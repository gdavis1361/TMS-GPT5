Ext.define("TMS.ActionWindow",{extend:"Ext.window.Window",baseCls:"x-panel",modal:true,frame:false,resizable:false,draggable:false,autoShow:true,autoSize:true,widthPercent:0.5,heightPercent:0.7,sizePercent:null,minWidth:300,minHeight:300,minSize:null,topItems:[],bottomItems:[],constructor:function(){this.topItems=[];this.bottomItems=[];this.callParent(arguments)},initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.initTopBar();this.initBottomBar();this.initSizing();this.init();this.callParent(arguments)},init:function(){},initTopBar:function(){this.topToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:this.topItems||[]});this.dockedItems.push(this.topToolbar);this.topToolbar.on("afterrender",function(){if(!this.topToolbar.items.items.length){this.topToolbar.hide()}},this)},initBottomBar:function(){this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",ui:"footer",layout:{pack:"center"},items:this.bottomItems||[]});this.dockedItems.push(this.bottomToolbar);this.bottomToolbar.on("afterrender",function(){if(!this.bottomToolbar.items.items.length){this.bottomToolbar.hide()}},this)},initSizing:function(){if(!this.autoSize){return}if(this.sizePercent!=null){this.widthPercent=this.sizePercent;this.heightPercent=this.sizePercent}if(this.minSize!=null){this.minWidth=this.minSize;this.minHeight=this.minSize}this.on("show",function(){var b=Ext.Element.getViewportWidth()*this.widthPercent;var a=Ext.Element.getViewportHeight()*this.heightPercent;if(b<this.minWidth){b=this.minWidth}if(a<this.minHeight){a=this.minHeight}this.setWidth(b);this.setHeight(a);this.center()},this);Ext.EventManager.onWindowResize(function(){var b=Ext.Element.getViewportWidth()*this.widthPercent;var a=Ext.Element.getViewportHeight()*this.heightPercent;if(b<this.minWidth){b=this.minWidth}if(a<this.minHeight){a=this.minHeight}this.setWidth(b);this.setHeight(a);this.center()},this)},addTopButton:function(a){this.topToolbar.show();this.topToolbar.add(a)},addBottomButton:function(a){this.bottomToolbar.show();this.bottomToolbar.add(a)},showCloseButton:function(){this.bottomToolbar.removeAll();this.addBottomButton({scope:this,text:"Close",handler:this.close})}});Ext.define("TMS.AjaxController",{extend:"Ext.util.Observable",singleton:true,constructor:function(a){Ext.apply(this,a);this.requests=[];this.init()},url:"/at-ajax/modules/tms/application/request",requestTimeout:false,requests:[],wait:100,enabled:true,init:function(){this.initListeners()},initListeners:function(){Ext.Ajax.on("beforerequest",function(a,b){if(b.bulk===true||b.async===false||b.form!=null||!this.enabled){return true}b.userCallback=b.callback;b.callback=function(){};if(this.requestTimeout){clearTimeout(this.requestTimeout)}this.requestTimeout=setTimeout(Ext.bind(function(){this.sendBulkRequest();this.requestTimeout=false},this),this.wait);this.requests.push(b);b.transactionId=this.requests.length-1;return false},this)},sendBulkRequest:function(){var b=[];while(this.requests.length){b.push(this.requests.pop())}this.requests=[];var a=[];Ext.each(b,function(f){var e=[];for(var d in f.params){var g=f.params[d];if(d.substr(-2)=="[]"){if(typeof g!="array"){g=[]}f.params[d.replace("[]","")]=g;delete f.params[d]}}var c={transactionId:f.transactionId,url:f.url,params:f.params||{},method:f.method||"post"};a.push(c)},this);Ext.Ajax.request({scope:this,bulk:true,url:this.url,requests:b,method:"post",params:{requests:Ext.encode(a)},callback:function(f,g,e){var h=f.requests;var c=Ext.decode(e.responseText);var d=c.results;if(d){Ext.each(d,function(j){var k=h[h.length-j.transactionId-1];var i={};Ext.apply(i,{request:k,requestId:k.id,responseText:Ext.encode(j)},e);if(k.success){Ext.bind(k.success,k.scope)(i,k)}if(k.userCallback){try{Ext.callback(k.userCallback,k.scope,[k.options,true,i])}catch(l){}}},this)}}})},disable:function(){this.enabled=false},enable:function(){this.enabled=true}});Ext.define("TMS.Application",{extend:"Ext.util.Observable",singleton:true,messageContainer:false,constructor:function(){this.callParent(arguments);this.initMenu()},initMenu:function(){this.mainMenu=Ext.getBody().down(".header-main-nav");this.mainMenu.show();this.activeMenu=this.mainMenu.down("li a.active").up("li");this.activeSubMenu=this.activeMenu.down("ul");if(this.activeSubMenu){this.activeSubMenu.show();this.currentSubMenu=this.activeSubMenu}Ext.select(".header-navigation").each(function(a){a.on("mouseleave",function(){if(this.currentSubMenu!=null&&this.currentSubMenu!=this.activeSubMenu){this.onHideMenu(this.currentSubMenu)}if(this.activeSubMenu!=null){this.onShowMenu(this.activeSubMenu)}},this)},this);this.mainMenu.select("> li").each(function(a){a.on("mouseover",function(e,d,c){var f=Ext.get(e.getTarget("li"));var b=f.down("ul");if(b==null){return}if(this.currentSubMenu==b){return}if(this.currentSubMenu!=null){this.onHideMenu(this.currentSubMenu)}if(this.activeSubMenu!=null){this.onHideMenu(this.activeSubMenu)}this.onShowMenu(b)},this);a.on("mouseleave",function(e,d,c){var f=Ext.get(e.getTarget("li"));var b=f.down("ul");if(b==null){return}if(this.currentSubMenu==b){this.currentSubMenu=null}this.onHideMenu(b)},this)},this)},onShowMenu:function(a){if(!a.isVisible()){a.show(true)}a.up("li").down("a").addCls("active");this.currentSubMenu=a},onHideMenu:function(a){a.hide();a.up("li").down("a").removeCls("active");if(this.currentSubMenu==null&&this.activeSubMenu!=null&&a!=this.activeSubMenu){this.onShowMenu(this.activeSubMenu)}},showMessage:function(c){var b={};var a={title:"",content:"",icon:"/resources/img/thumb_icon.png",url:false,timeout:false};Ext.apply(b,c,a);if(!this.messageContainer){this.messageContainer=Ext.core.DomHelper.insertFirst(Ext.getBody(),{id:"tms-application-messages-container"},true)}var d=Ext.core.DomHelper.append(this.messageContainer,this.createMessageBox(b),true);d.config=b;d.hide();d.slideIn("t");if(b.timeout){setTimeout(Ext.bind(function(){this.fadeOut({remove:true})},d),b.wait)}d.on("click",function(e){if(e.getTarget(".close")!=null){this.fadeOut({remove:true})}else{if(d.config.url){location.href=d.config.url}}},d)},createMessageBox:function(a){var b=new Ext.XTemplate('<div class="tms-application-message">','<div class="close"></div>','<div class="title">{title}</div>','<div class="icon"><img src="{icon}" /></div>','<div class="message">{content}</div>',"</div>");return b.apply(a)},addJs:function(c){var a=true;Ext.select("script").each(function(d){if(d.dom.src.replace(c,"")!=d.dom.src){a=false}});if(a){var b=Ext.core.DomHelper.append(Ext.getDoc().down("head"),{tag:"script",type:"text/javascript",src:c});return b}else{return false}},addCss:function(a){var b=true;Ext.select("link").each(function(d){if(d.dom.href.replace(a,"")!=d.dom.href){b=false}});if(b){var c=Ext.core.DomHelper.append(Ext.getDoc().down("head"),{tag:"link",type:"text/css",href:a});return c}else{return false}}});Ext.define("TMS.IframeWindow",{extend:"TMS.ActionWindow",iframe:false,iframeHtml:false,title:" ",url:false,init:function(){this.initIframe();this.initButtons()},initIframe:function(){this.iframeHtml=Ext.core.DomHelper.markup({tag:"iframe",cls:"rate-confirmation-iframe",border:0,frameborder:0,width:"100%",height:"100%"});this.html=this.iframeHtml;this.on("afterrender",function(){this.iframe=this.getEl().down("iframe");this.setHeight(Ext.Element.getViewportHeight()*0.8);this.setWidth(Ext.Element.getViewportWidth()*0.9);this.center();if(this.url){this.loadUrl(this.url)}},this)},initButtons:function(){this.showCloseButton()},loadUrl:function(a){this.url=a;this.setLoading(true);this.iframe.on("load",function(){this.setLoading(false)},this);this.iframe.dom.src=this.url}});Ext.define("TMS.TimeDifference",{extend:"Ext.util.Observable",config:{selectorCls:"time-difference",futurePrefix:"In",futureSuffix:"",pastPrefix:"",pastSuffix:"ago"},displays:false,constructor:function(a){this.initConfig(a);this.displays=Ext.select("."+this.selectorCls,true);this.displays.removeCls(this.selectorCls);this.initDisplays();this.updateDisplays();this.interval=setInterval(Ext.Function.bind(this.updateDisplays,this),1000)},remove:function(){clearInterval(this.interval)},initDisplays:function(){this.displays.addCls("x-hidden");var c=this.displays.elements.length;var a=new Date();for(var b=0;b<c;b++){a.setTime(this.displays.elements[b].dom.innerHTML+"000");this.displays.elements[b].originalTime=a.getTime()}this.displays.update("");this.displays.removeCls("x-hidden")},updateDisplays:function(){var c=this.displays.elements.length;var a=(new Date()).getTime();for(var b=0;b<c;b++){this.displays.elements[b].update(this.getDisplayText(a-this.displays.elements[b].originalTime))}},getDisplayText:function(h){h/=1000;var n=true;if(h<0){n=false;h=-h}var e=[[31536000,"year"],[2592000,"month"],[604800,"week"],[86400,"day"],[3600,"hour"],[60,"minute"],[1,"second"]];var a="";var l="";var c=e.length;var f=0;for(var d=0;d<c;d++){l=e[d][0];a=e[d][1];f=Math.floor(h/l);if(f){break}}var g=f+" "+a;if(f>1){g+="s"}if(n){g=this.pastPrefix+" "+g+" "+this.pastSuffix}else{g=this.futurePrefix+" "+g+" "+this.futureSuffix}return g;var m=Math.floor(h/86400);var k=Math.floor((h-(m*86400))/3600);var b=Math.floor((h-(m*86400)-(k*3600))/60);var l=Math.floor((h-(m*86400)-(k*3600)-(b*60)));var j=m+" Days "+k+" Hours "+b+" Minutes and "+l+" Seconds ";return j}});Ext.define("TMS.filter.Abstract",{extend:"Ext.form.Panel",frame:true,bodyPadding:5,fieldDefaults:{labelWidth:70,anchor:"100%"},config:{extraFilters:{}},registeredFilters:{},values:{},autoScroll:true,constructor:function(){this.extraFilters={};this.values={};return this.callParent(arguments)},initComponent:function(){this.items=[];this.registeredFilters={};this._init();this.callParent(arguments)},_init:function(){this.initListeners();this.initDefaults();this.initButtons();this.init()},init:function(){},initListeners:function(){this.on("expand",function(){this.child("field").focus()},this);this.on("add",function(a,b){if(Ext.ComponentQuery.is(b,"field")){this.onFilterAdd(b)}},this)},initDefaults:function(){this.defaults={xtype:"textfield",enableKeyEvents:true,listeners:{scope:this,specialkey:function(b,a){if(a.getKey()==a.ENTER&&b.xtype=="textfield"){this.filter()}}}}},initButtons:function(){this.buttons=[{scope:this,text:"Search",handler:function(){this.filter()}},{scope:this,text:"Reset",handler:function(){this.getForm().reset();this.filter()}}]},initFields:function(){},registerFilter:function(a){this.registeredFilters[a.name]=a;if(this.values[a.name]!=null){a.setRawValue(this.values[a.name])}this.onFilterAdd(a)},filter:function(){this.fireEvent("filter",this,this.getValues())},getValues:function(){var a=this.getForm().getValues();var c={};var d;var b;for(b in this.values){if(a[b]==null){d={};c[b]=this.values[b]}}for(b in c){d=this.registeredFilters[b];if(d!=null){a[b]=d.getValue()}else{a[b]=c[b]}}for(b in this.registeredFilters){d=this.registeredFilters[b];a[b]=d.getValue()}console.log(this.extraFilters);return Ext.apply({},this.extraFilters,a)},setValues:function(a){this.values=a;this.getForm().setValues(a);for(var b in a){if(this.registeredFilters[b]!=null){this.registeredFilters[b].setValue(a[b])}}},onFilterAdd:function(a){a.on("change",function(d,c,b){if(c!=b){this.filter()}},this)}});Ext.define("TMS.carrier.filter.Carrier",{extend:"TMS.filter.Abstract",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initName();this.initMc();this.initScac();this.initCity();this.initStateField();this.initZip()},initName:function(){this.name=new Ext.form.field.Text(Ext.apply({scope:this,name:"name",fieldLabel:"Name"},this.defaults));this.items.push(this.name)},initMc:function(){this.mc=new Ext.form.field.Text(Ext.apply({scope:this,name:"mc",fieldLabel:"MC#"},this.defaults));this.items.push(this.mc)},initScac:function(){this.scac=new Ext.form.field.Text(Ext.apply({scope:this,name:"scac",fieldLabel:"SCAC"},this.defaults));this.items.push(this.scac)},initCity:function(){this.city=new Ext.form.field.Text(Ext.apply({scope:this,name:"city",fieldLabel:"City"},this.defaults));this.items.push(this.city)},initStateField:function(){this.stateStore=Ext.create("Ext.data.Store",{autoLoad:true,fields:["display","value"],proxy:{type:"ajax",url:"/at-ajax/modules/util/data/states",reader:{type:"json",root:"records"}}});this.stateField=new Ext.form.field.ComboBox(Ext.apply({scope:this,queryMode:"local",name:"state",displayField:"display",valueField:"value",fieldLabel:"State",store:this.stateStore},this.defaults));this.items.push(this.stateField)},initZip:function(){this.zip=new Ext.form.field.Text(Ext.apply({scope:this,name:"zip",fieldLabel:"Zip"},this.defaults));this.items.push(this.zip)}});Ext.define("TMS.carrier.forms.sections.Audit",{extend:"TMS.ActionWindow",requires:["TMS.documents.view.Grid","TMS.carrier.forms.sections.Authority","TMS.comment.forms.sections.Form"],title:"Approve Carrier",processingPage:"/at-ajax/modules/carrier/audit/",carrier_id:0,widthPercent:0.9,heightPercent:0.9,layout:{type:"hbox",align:"stretch"},border:false,init:function(){this.initAuthority();this.initDocuments();this.initHidden();this.initButtons();this.initListeners()},initAuthority:function(){this.authorityPanel=Ext.create("TMS.carrier.forms.sections.Authority",{width:300,carrier_id:this.carrier_id});this.items.push(this.authorityPanel)},initDocuments:function(){this.documentsPanel=Ext.create("TMS.documents.view.Grid",{title:"Carrier Documents",extraParams:{carrier_id:this.carrier_id},flex:1});this.items.push(this.documentsPanel)},initHidden:function(){this.carrierIdField=Ext.create("Ext.form.field.Hidden",{name:"carrierId",value:0});this.items.push(this.carrierIdField)},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Approve",handler:this.approve,scale:"medium",icon:"/resources/icons/check-24.gif"});this.declineButton=Ext.create("Ext.button.Button",{scope:this,text:"Decline",handler:this.decline,scale:"medium",icon:"/resources/icons/close-24.png"});this.addTopButton([this.approveButton,this.declineButton])},approve:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"approve",params:{carrier_id:this.carrier_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},decline:function(){this.formPanel=Ext.create("TMS.comment.forms.sections.Form",{field_value:this.carrier_id,commentType:"carrier"});this.formWindow=Ext.create("Ext.window.Window",{title:"Enter a reason",autoShow:true,modal:true,resizable:false,draggable:false,width:400,items:[this.formPanel]});this.formPanel.on("formsuccess",function(){this.formWindow.close();this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"decline",params:{carrier_id:this.carrier_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},this)},initListeners:function(){}});Ext.define("TMS.form.Abstract",{extend:"Ext.form.Panel",alias:"widget.tmsform",submitParams:{},fieldPrefix:"",fieldPostfix:"",autoDestroy:true,autoScroll:true,constructor:function(){this.submitParams={};return this.callParent(arguments)},initComponent:function(){if(!this.url){}Ext.form.field.Base.prototype.msgTarget="";this.addEvents("beforesubmit","submit","success","failure","cancelsubmit");this.setFieldPrefix(this.fieldPrefix);this.setFieldPostfix(this.fieldPostfix);this.on("add",function(b,a){if(Ext.ComponentQuery.is(a,"field")){this.applyPrefixPostfix(a)}},this);this.callParent(arguments)},setFieldPrefix:function(a){if(!this.rendered){this.on("afterrender",function(b,c){this.setFieldPrefix(c.prefix)},this,{prefix:a});return}this.fieldPrefix=a;this.getForm().getFields().each(function(b){if(b.name!=null&&b.name.length){this.applyPrefixPostfix(b)}},this)},setFieldPostfix:function(a){if(!this.rendered){this.on("afterrender",function(b,c){this.setFieldPostfix(c.postfix)},this,{postfix:a});return}this.fieldPostfix=a;this.getForm().getFields().each(function(b){if(b.name!=null&&b.name.length){this.applyPrefixPostfix(b)}},this)},applyPrefixPostfix:function(b){if(b.defaultName==null){b.defaultName=b.name}var a=b.defaultName;if(this.fieldPrefix.toString().length){a=this.fieldPrefix+"-"+a}if(this.fieldPostfix.toString().length){a+="-"+this.fieldPostfix}b.name=a},useDefaultNames:function(){this.getForm().getFields().each(function(a){if(a.name!=null&&a.name.length){if(a.defaultName!=null){a.name=a.defaultName}}},this)},usePrefixPostfixNames:function(){this.setFieldPrefix(this.fieldPrefix);this.setFieldPostfix(this.fieldPostfix)},setParams:function(a){Ext.apply(this.submitParams,a)},setParam:function(b,a){this.submitParams[b]=a},getValues:function(){var a=this.getForm().getValues();Ext.apply(a,this.submitParams);return a},setValues:function(a){if(!this.rendered){this.on("afterrender",function(c,b){this.setValues(a)},this,{values:a});return}this.useDefaultNames();this.getForm().setValues(a);this.usePrefixPostfixNames()},anyErrors:function(){var a=false;this.getForm().getFields().each(function(b){if(b.hasActiveError()){a=true}},this);return a},submit:function(){if(this.rendered&&this.getForm().isValid()&&this.fireEvent("beforesubmit",this,this.submitParams)!==false){var a=this.getValues();Ext.apply(a,this.submitParams);this.getForm().submit({scope:this,url:this.url,params:a,success:function(b,c){this.fireEvent("success",b,c);this.fireEvent("submit",b,c)},failure:function(b,c){this.fireEvent("failure",b,c);this.fireEvent("submit",b,c);setTimeout(Ext.bind(function(f){var d=[];for(var e in f){d.push({id:e,msg:f[e]})}this.getForm().markInvalid(d)},this,[c.result.errors]))}})}else{this.fireEvent("cancelsubmit",this)}}});Ext.define("TMS.carrier.forms.sections.Authority",{extend:"TMS.form.Abstract",title:"Carrier Authority",processingPage:"/at-ajax/modules/carrier/authority/",url:"/at-ajax/modules/carrier/authority/save/",carrier_id:0,bodyPadding:8,initComponent:function(){this.items=this.items||[];this.initCommon();this.initContract();this.initBroker();this.initHidden();this.initListeners();if(this.carrier_id){this.loadData(this.carrier_id)}this.callParent(arguments)},initCommon:function(){this.commonField=Ext.create("Ext.form.field.Text",{fieldLabel:"Common Authority",name:"common_authority",readOnly:true});this.items.push(this.commonField)},initContract:function(){this.contractField=Ext.create("Ext.form.field.Text",{fieldLabel:"Contract Authority",name:"contract_authority",readOnly:true});this.items.push(this.contractField)},initBroker:function(){this.brokerField=Ext.create("Ext.form.field.Text",{fieldLabel:"Broker Authority",name:"broker_authority",readOnly:true});this.items.push(this.brokerField)},initHidden:function(){this.carrierIdField=Ext.create("Ext.form.field.Hidden",{name:"carrier_id",value:this.carrier_id});this.items.push(this.carrierIdField)},initListeners:function(){},loadData:function(a){this.carrier_id=a||this.carrier_id;if(this.carrier_id){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"load",params:{carrier_id:this.carrier_id},success:function(c){var b=Ext.decode(c.responseText);if(b.success){this.setValues(b.record)}}})}},setValues:function(a){this.commonField.setValue(this.getDisplay(a.common_authority));this.contractField.setValue(this.getDisplay(a.contract_authority));this.brokerField.setValue(this.getDisplay(a.broker_authority))},getDisplay:function(a){if(a){return"Yes"}else{return"No"}}});Ext.define("TMS.carrier.forms.sections.CarrierLocations",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect","TMS.location.forms.sections.Location"],carrier_id:0,layout:{type:"hbox",align:"stretch"},processingPage:"/at-ajax/modules/carrier/process/",locationProcessingPage:"/at-ajax/modules/location/process/",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTopBar();this.initButtons();this.initLayoutPanels();this.initLocationStore();this.initLocationSelectorView();this.initLocationEditor()},initTopBar:function(){this.topToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top"});this.dockedItems.push(this.topToolbar)},initButtons:function(){this.topToolbar.add({scope:this,text:"Add New Location",icon:"/resources/icons/add-16.png",handler:this.addNewLocation})},initLayoutPanels:function(){this.leftPanel=Ext.create("Ext.panel.Panel",{title:"Locations",width:200});this.rightPanel=Ext.create("Ext.panel.Panel",{layout:"fit",flex:1,border:false});this.items.push(this.leftPanel,this.rightPanel)},initLocationStore:function(){this.locationStore=Ext.create("Ext.data.Store",{fields:["location_id","location_name_1","location_name_2"],proxy:{type:"ajax",url:this.processingPage+"get-locations",extraParams:{carrier_id:this.carrier_id},reader:{type:"json",root:"records"}}});this.locationStore.on("load",this.selectFirst,this);this.locationStore.load()},initLocationSelectorView:function(){this.locationSelectorView=Ext.create("Ext.view.View",{title:"Locations",store:this.locationStore,tpl:['<tpl for=".">','<div class="carrier-contact-row">{location_name_1} {location_name_2}</div>',"</tpl>",'<div class="x-clear"></div>'],autoHeight:true,trackOver:true,overItemCls:"carrier-contact-row-hover",selectedItemCls:"carrier-contact-row-selected",itemSelector:".carrier-contact-row",emptyText:"No Locations",deferEmptyText:false,listeners:{scope:this,selectionchange:function(b,a){if(a.length){this.selectRecord(a[0].index)}}}});this.leftPanel.add(this.locationSelectorView)},initLocationEditor:function(){this.locationEditor=Ext.create("TMS.location.forms.sections.Location",{title:"Location Information",bodyPadding:10,disabled:true,url:this.locationProcessingPage+"process",buttons:[{scope:this,text:"Save",cls:"submit",handler:function(){this.locationEditor.submit()}}]});this.locationEditor.on("success",function(b,c){var a=c.result.record;this.locationEditor.getForm().setValues(a);this.locationStore.un("load",this.selectFirst,this);this.locationStore.on("load",this.selectCurrent,this);this.locationStore.load()},this);this.locationEditor.setValues({carrier_id:this.carrier_id});this.rightPanel.add(this.locationEditor)},selectFirst:function(){if(this.locationStore.count()){this.leftPanel.doComponentLayout();this.locationSelectorView.suspendEvents();this.selectRecord(0);this.locationSelectorView.resumeEvents()}},selectCurrent:function(){var b=this.locationEditor.getForm().getValues()["location_id"];if(b){var a=this.locationStore.findRecord("location_id",b);if(a){this.leftPanel.doComponentLayout();this.locationSelectorView.suspendEvents();this.selectRecord(a.index);this.locationSelectorView.resumeEvents()}else{this.selectRecord(0)}}},selectRecord:function(c){this.locationSelectorView.select(c);var a=this.locationStore.getAt(c);var d=a.data.location_id;var b=a.data.location_name_1;this.locationEditor.enable();this.locationEditor.loadLocation(d);this.locationEditor.setTitle("Location Information - "+b)},addNewLocation:function(){this.locationEditor.show();this.locationEditor.enable();this.locationEditor.setTitle("New Location");this.locationEditor.getForm().reset();this.locationEditor.setValues({carrier_id:this.carrier_id})},saveLocationData:function(){}});Ext.define("TMS.form.Navigation",{extend:"TMS.form.Abstract",requires:["TMS.form.plugin.StatusBar","TMS.panel.plugin.AutoHeight"],layout:"border",layoutTypes:{CARD:"card",SCROLL:"scroll"},border:false,submitParams:{},rootCls:"tms-form-navigation",cls:"tms-form-navigation",bodyCls:"tms-form-navigation-body",redirect:true,redirectTimeout:4000,deferredRender:false,layoutType:null,leftConfig:{},centerConfig:{},activeItem:null,saving:false,constructor:function(){this.leftConfig={};this.centerConfig={};this.callParent(arguments)},initComponent:function(){this.formItems=this.items||[];this.dockedItems=this.dockedItems||[];this.plugins=this.plugins||[];this.items=[];this.uniqueKey=(new Date()).getTime();Ext.form.field.Base.prototype.msgTarget="";this.addEvents("setactiveitem");this.initNavigationStore();this.initBottomToolbar();this.initLayoutType();this.initLeft();this.initCenter();this.initListeners();this.initStatusBar();this.initAutoHeight();this.initKeys();this.callParent(arguments)},initNavigationStore:function(){this.navigationStore=new Ext.data.Store({scope:this,fields:["title","button","panel"]})},initListeners:function(){this.on("beforesubmit",this.onBeforeSubmit,this);this.on("submit",this.onSubmit,this);this.on("cancelsubmit",this.onSubmit,this);this.on("failure",function(b,a){this.onFailure(a.result)},this);this.on("success",function(b,a){this.onSuccess(a.result)},this);this.on("afterrender",function(){this.getEl().on("contextmenu",function(c,b,a){var d=new Ext.menu.Menu({scope:this});this.navigationStore.each(function(e){if(e.get("button").isVisible()){var f=e.get("title");if(e.get("panel")==this.activeItem){f="<b>"+f+"</b>"}d.add({scope:this,text:f,record:e,handler:function(g){this.setActiveItem(g.record.get("panel"))}})}},this);d.showAt(c.getXY());c.preventDefault()},this)},this)},initLayoutType:function(){if(this.layoutType==null){this.layoutType=this.layoutTypes.CARD}switch(this.layoutType){case this.layoutTypes.CARD:this.initCardLayout();break;case this.layoutTypes.SCROLL:this.initScrollLayout();break}},initCardLayout:function(){this.previousButton=new Ext.panel.Tool({scope:this,type:"prev",tooltip:"Previous",handler:function(){this.previous()}});this.nextButton=new Ext.panel.Tool({scope:this,type:"next",tooltip:"Next",handler:function(){this.next()}});Ext.apply(this.centerConfig,{layout:{type:"card",deferredRender:this.deferredRender},defaults:{border:false,autoScroll:true}});this.on("setactiveitem",function(a){this.center.getLayout().setActiveItem(a)},this)},initScrollLayout:function(){Ext.apply(this.centerConfig,{autoScroll:true,border:false,bodyPadding:"5 0 0 0",defaults:{margin:"0 5 10 5",collapsible:true,titleCollapse:true}});this.on("setactiveitem",function(a){var b=a.getEl().getY()-this.center.getEl().getY();this.center.body.scroll("t",(-b)+5,{scope:this,callback:Ext.bind(function(c){if(this.activeItemTooltip!=null){this.activeItemTooltip.hide();this.activeItemTooltip.destroy()}var d=c.title.substr(0,10)+"...";this.activeItemTooltip=Ext.create("Ext.tip.ToolTip",{scope:this,cls:"form-message-tip",anchor:"left",autoHide:false,target:c.getEl(),html:d});this.activeItemTooltip.show()},this,[a])})},this)},initBottomToolbar:function(){if(this.buttons==null||!this.buttons.length){return}this.bottomToolbar=new Ext.toolbar.Toolbar({scope:this,items:["->",this.buttons]});this.bbar=this.bottomToolbar;delete this.buttons},initLeft:function(){this.left=new Ext.panel.Panel(Ext.apply({scope:this,region:"west",layout:"anchor",width:200,split:true,collapsible:true,floatable:false,header:false,bodyStyle:{background:"#f1f1f1"},defaults:{anchor:"100%"},autoScroll:true},this.leftConfig));this.items.push(this.left)},initCenter:function(){this.center=new Ext.panel.Panel(Ext.apply({scope:this,region:"center",border:false,bbar:this.statusBar},this.centerConfig));this.items.push(this.center);this.center.on("beforeadd",function(b,c){if(b==this.center&&c.title!=null){var a=c.navigationRecord;if(a==null){this.onCenterBeforeAdd(c);return false}}},this);this.on("afterrender",function(){this.center.add(this.formItems);if(this.navigationStore.count()){this.setActiveItem(this.navigationStore.getAt(0).get("panel"))}},this)},initStatusBar:function(){this.statusBarPlugin=Ext.create("TMS.form.plugin.StatusBar",{dockTo:this.center,items:[{scope:this,text:"&laquo; Back",handler:function(){this.previous()}},"-",{scope:this,text:"Continue &raquo;",handler:function(){this.next()}}]});this.plugins.push(this.statusBarPlugin);this.statusBarPlugin.on("showerror",function(a){this.navigationStore.each(function(c){var b=c.get("panel");if(Ext.ComponentQuery.is(b,"tmsform")){var d=b.getForm().findField(a);if(d!=null){this.setActiveItem(b);d.focus(true,100)}}},this)},this)},initAutoHeight:function(){this.plugins.push(Ext.create("TMS.panel.plugin.AutoHeight"))},initKeys:function(){this.on("afterrender",function(){var a=new Ext.util.KeyNav(Ext.getBody(),{scope:this,pageUp:function(){if(!this.saving){this.previous()}},pageDown:function(){if(!this.saving){this.next()}}})},this)},addNavigation:function(e){if(e.title==null||!e.title.length){return}var f=e.title;if(f.length>24){f=f.substr(0,24)+"..."}var b={};var d=this.left.add(Ext.apply({scope:this,xtype:"button",scale:"medium",cls:"form-navigation-button",panel:e,text:f,hidden:(e.hidden||e.disabled),enableToggle:true,toggleGroup:this.uniqueKey,handler:function(g){this.setActiveItem(g.panel)}},b));var c=this.navigationStore.add({title:e.title,button:d,panel:e});var a=c[0];d.record=a;e.navigationButton=d;e.navigationRecord=a;d.on("afterrender",function(g){g.tip=Ext.create("Ext.tip.ToolTip",{scope:this,showDelay:600,button:g,width:200,target:g.getEl(),anchor:"top",html:null});g.tip.on("beforeshow",function(k){if(!Ext.ComponentQuery.is(e,"tmsform")){return false}var h=k.button.panel.getForm().getFields();var i='<table cellpadding="5" cellspacing="0" width="100%"><tbody>';var j=0;h.each(function(l){if(l.fieldLabel!=null&&l.getRawValue!=null){i+='<tr><td style="width: 40%;"><span style="font-weight: bold;">'+l.fieldLabel+": </span></td><td>"+l.getRawValue()+"</td>";j++}},this);i+="</tbody></table>";if(!h.length||!j){return false}k.update(i)},this)},this);d.on("click",function(g){if(g.tip==null){return}if(!g.tip.isVisible()){g.tip.on("beforeshow",function(){return false},this,{single:true})}else{g.tip.hide()}},this);e.on("enable",function(g,h){h.button.show()},this,{button:d});e.on("disable",function(g,h){h.button.hide()},this,{button:d});e.on("destroy",function(g,h){this.navigationStore.remove(h.button.record);h.button.destroy()},this,{button:d});e.on("show",function(g,h){h.button.toggle(true)},this,{button:d});e.on("afterrender",function(){var g=e.query("field");if(g.length){var h=g[g.length-1];h.on("afterrender",function(i){i.on("specialkey",function(k,j){if(j.getKey()==Ext.EventObject.TAB){this.next()}},this)},this)}},this)},bindForm:function(a){if(Ext.ComponentQuery.is(a,"tmsform")){a.on("beforesubmit",function(b,c){return this.fireEvent("beforesubmit",b,c)},this);a.on("submit",function(b,c){return this.fireEvent("submit",b,c)},this);a.on("success",function(b,c){return this.fireEvent("success",b,c)},this);a.on("failure",function(b,c){return this.fireEvent("failure",b,c)},this);a.on("cancelsubmit",function(b){return this.fireEvent("cancelsubmit",b)},this);this.on("beforesubmit",function(d,g,c){if(d==null){return}try{this.suspendEvents(false);var b=c.form.fireEvent("beforesubmit",d,g);this.resumeEvents();return b}catch(f){}},this,{form:a});this.on("submit",function(d,f,c){if(d==null){return}try{this.suspendEvents(false);var b=c.form.fireEvent("submit",d,f);this.resumeEvents();return b}catch(g){}},this,{form:a});this.on("success",function(d,f,c){if(d==null){return}try{this.suspendEvents(false);var b=c.form.fireEvent("success",d,f);this.resumeEvents();return b}catch(g){}},this,{form:a});this.on("failure",function(d,f,c){if(d==null){return}try{this.suspendEvents(false);var b=c.form.fireEvent("failure",d,f);this.resumeEvents();return b}catch(g){}},this,{form:a});this.on("cancelsubmit",function(d,c){if(d==null){return}try{this.suspendEvents(false);var b=c.form.fireEvent("cancelsubmit",d);this.resumeEvents();return b}catch(f){}},this,{form:a})}},setActiveItem:function(a){if(!this.center.rendered){this.center.on("afterrender",function(b,c){this.setActiveItem(c.item)},this,{item:a});return}this.center.add(a);this.activeItem=a;if(a.navigationButton){a.navigationButton.toggle(true)}this.fireEvent("setactiveitem",a)},getActiveItem:function(){return this.activeItem},showBusy:function(a){this.statusBar.showBusy(a)},next:function(){var b=0;var a=0;var d=this.center.items.items;var c=[];this.navigationStore.each(function(e,f){var g=e.get("panel");if(!g.isDisabled()&&g.navigationButton!=null){c.push(g);if(g==this.activeItem){b=c.length-1}}},this);a=b+1;if(a>=c.length){a=0}this.setActiveItem(c[a])},previous:function(){var b=0;var a=0;var d=this.center.items.items;var c=[];this.navigationStore.each(function(e,f){var g=e.get("panel");if(!g.isDisabled()&&g.navigationButton!=null){c.push(g);if(g==this.activeItem){b=c.length-1}}},this);a=b-1;if(a<0){a=c.length-1}this.setActiveItem(c[a])},onCenterBeforeAdd:function(a){this.addNavigation(a);a.on("afterrender",function(b){if(b.header!=null){if(b.header.rendered){var c=b.header.getEl();c.addCls(this.rootCls+"-center-header")}else{b.header.on("afterrender",function(e){var d=e.getEl();d.addCls(this.rootCls+"-center-header")},this)}}},this);this.bindForm(a)},onMouseWheel:function(b){return;var c=this.center.getLayout().getActiveItem();var a=c.body.getScroll();if(c.body.dom.scrollHeight>c.body.dom.clientHeight){if(a.top+c.body.dom.clientHeight!=c.body.dom.scrollHeight){return}return}var d=b.getWheelDelta();if(d<0){this.next()}else{if(d>0){this.previous()}}b.stopEvent()},onBeforeSubmit:function(){},onSubmit:function(){},onSuccess:function(a){},onFailure:function(a){}});Ext.define("TMS.carrier.forms.Carrier",{extend:"TMS.form.Navigation",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.CarrierInformation","TMS.contacts.forms.sections.ModesEquipment","TMS.contacts.forms.sections.CarrierContacts","TMS.contacts.forms.sections.PayTo","TMS.comment.forms.sections.Comments","TMS.orders.view.FilteredGrid","TMS.documents.view.Interface"],title:"Carrier",url:"/at-ajax/modules/contact/process/add",carrier_id:0,record:null,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initLocations();this.initGeneralInformationPanel();this.initCarrierInformation();this.initPayTo();this.initGeneralInformation();this.initModesEquipment();this.initContacts();this.initComments();this.initOrders();this.initDocuments()},initTitle:function(){if(this.record!=null){this.title=this.record.CarrName}},initLocations:function(){this.locations=Ext.create("TMS.carrier.forms.sections.CarrierLocations",{title:"Carrier Locations",carrier_id:this.carrier_id});this.items.push(this.locations);this.bindForm(this.locations.locationEditor)},initGeneralInformationPanel:function(){Ext.get("carrier-general-information").show();this.generalInformationPanel=new Ext.panel.Panel({scope:this,border:false,contentEl:"carrier-general-information"})},initCarrierInformation:function(){this.carrierInformation=Ext.create("TMS.contacts.forms.sections.CarrierInformation",{title:"Carrier Information",border:true,carrier_id:this.carrier_id})},initGeneralInformation:function(){this.generalInformation=new Ext.panel.Panel({title:"General Information",bodyPadding:10,defaults:{margin:"0 0 10 0"},items:[this.generalInformationPanel,this.carrierInformation,this.payTo]});this.items.push(this.generalInformation)},initPayTo:function(){this.payTo=Ext.create("TMS.contacts.forms.sections.PayTo",{title:"Pay To Information",carrier_id:this.carrier_id});this.bindForm(this.payTo)},initModesEquipment:function(){this.modesEquipment=Ext.create("TMS.contacts.forms.sections.ModesEquipment",{title:"Allowed Modes & Equipment",carrier_id:this.carrier_id});this.items.push(this.modesEquipment)},initContacts:function(){this.contacts=Ext.create("TMS.contacts.forms.sections.CarrierContacts",{title:"Contacts",carrier_id:this.carrier_id});this.items.push(this.contacts);this.bindForm(this.contacts.contactMethods);this.bindForm(this.contacts.preferredStates)},initComments:function(){this.comments=Ext.create("TMS.comment.forms.sections.Comments",{title:"Comments",field_value:this.carrier_id,type:"carrier"});this.items.push(this.comments)},initOrders:function(){this.orders=Ext.create("TMS.orders.view.FilteredGrid",{title:"Orders",extraFilters:{carrier_id:this.carrier_id}});this.items.push(this.orders)},initDocuments:function(){this.documents=Ext.create("TMS.documents.view.Interface",{title:"Documents",extraParams:{carrier_id:this.carrier_id}});this.items.push(this.documents)}});Ext.define("TMS.carrier.lookup.Carrier",{extend:"Ext.ux.form.field.RealComboBox",processingPage:"/at-ajax/modules/carrier/lookup/carrier",displayField:"carrier_name",valueField:"carrier_id",emptyText:"Search by name or mc number...",cls:"carrier-lookup",typeAhead:false,hideTrigger:true,anchor:"100%",pageSize:10,minChars:0,listConfig:{loadingText:"Searching...",cls:"carrier-lookup-list",emptyText:"No matching carriers found.",getInnerTpl:function(){return'<div class="carrier-name">{carrier_name}</div><div class="carrier-number">{carrier_mc_no}</div>'}},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["carrier_id","carrier_name","carrier_mc_no"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.carrier.view.FilteredGrid",{extend:"Ext.panel.Panel",requires:["TMS.carrier.filter.Carrier","TMS.carrier.view.Grid"],layout:"border",gridConfig:{},constructor:function(){this.gridConfig={};return this.callParent(arguments)},initComponent:function(){this.dockedItems=this.dockedItems||[];this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initFilter();this.initGrid()},initFilter:function(){this.filter=Ext.create("TMS.carrier.filter.Carrier",{title:"Search",region:"east",width:250,collapsible:true,collapsed:true,titleCollapse:true,split:true,floatable:false});this.items.push(this.filter)},initGrid:function(){this.grid=Ext.create("TMS.carrier.view.Grid",Ext.apply({region:"center",filter:this.filter},this.gridConfig));this.items.push(this.grid)}});Ext.define("TMS.grid.Grid",{extend:"Ext.grid.Panel",viewConfig:{stripeRows:true},stateful:false,initComponent:function(){this.callParent(arguments);this.baseInit()},baseInit:function(){this.setListeners();this.setFilter(this.filter);this.on("statesave",function(){},this)},setListeners:function(){this.store.on("load",function(){this.saveState()},this)},setFilter:function(a){if(a==null){return false}this.filter=a;this.filter.on("filter",function(c,b){this.store.proxy.extraParams.filter=Ext.encode(b);this.store.loadPage(1);this.saveState()},this,{buffer:500});this.store.proxy.extraParams.filter=Ext.encode(this.filter.getValues())},applyState:function(a){this.callParent(arguments);if(a.filter!=null&&this.filter!=null){this.filter.setValues(a.filter);this.store.proxy.extraParams.filter=Ext.encode(this.filter.getValues())}if(a.store!=null){Ext.apply(this.store,a.store)}},getState:function(){var a=this.callParent(arguments);if(this.filter!=null){a.filter=this.filter.getValues()}a.store={currentPage:this.store.currentPage};return a}});Ext.define("TMS.carrier.view.Grid",{extend:"TMS.grid.Grid",processingPage:"/at-ajax/modules/carrier/lookup/carrier",viewConfig:{stripeRows:true},autoLoadStore:true,initComponent:function(){this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true,dock:"top"});this.dockedItems.push(this.pager)},initListeners:function(){this.on("afterrender",function(){if(this.autoLoadStore){this.store.load()}},this)},initColumns:function(){this.columns=[{header:"Name",dataIndex:"carrier_name",flex:2,renderer:function(c,b,a){return Ext.String.format('<a href="/carriers/?d=carriers&action=view&id={0}">{1}</a>',a.get("carrier_id"),c)}},{header:"MC#",dataIndex:"carrier_mc_no",flex:1},{header:"SCAC",dataIndex:"carrier_scac",flex:1},{header:"City",dataIndex:"location_city",flex:1},{header:"State",dataIndex:"location_state",flex:1},{header:"Zip",dataIndex:"location_zip",flex:1}]},initStore:function(){this.store=new Ext.data.Store({fields:["carrier_id","carrier_scac","carrier_name","carrier_mc_no","location_city","location_state","location_zip"],remoteSort:true,autoLoad:false,pageSize:20,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.carrier.view.RadiusGrid",{extend:"TMS.carrier.view.FilteredGrid",order_id:0,init:function(){this.gridConfig={autoLoadStore:false};this.callParent(arguments);this.initToolbar();this.initRadius();this.initFrom()},initToolbar:function(){this.toolbar=new Ext.toolbar.Toolbar({scope:this,docked:"top"});this.dockedItems.push(this.toolbar)},initRadius:function(){this.radiusStore=Ext.create("Ext.data.Store",{fields:["display","value"],data:[{display:"50 Miles",value:50},{display:"100 Miles",value:100},{display:"150 Miles",value:150},{display:"200 Miles",value:200},{display:"250 Miles",value:250}],proxy:{type:"memory",reader:{type:"json"}}});this.radiusSelect=new Ext.form.field.ComboBox({scope:this,name:"radiusDistance",fieldLabel:"Radius",labelWidth:50,queryMode:"local",displayField:"display",valueField:"value",store:this.radiusStore});this.radiusSelect.on("afterrender",function(){this.filter.suspendEvents(false);this.radiusSelect.select(this.radiusStore.getAt(1));this.filter.resumeEvents()},this);this.filter.registerFilter(this.radiusSelect);this.toolbar.add(this.radiusSelect)},initFrom:function(){this.fromStore=Ext.create("Ext.data.Store",{fields:["location_name_1","address_1","city","state","zip"],proxy:{type:"ajax",url:"/at-ajax/modules/order/order/get-stops",extraParams:{order_id:this.order_id},reader:{type:"json",root:"records"}}});this.on("afterrender",function(){this.fromStore.load()},this);this.fromSelect=new Ext.form.field.ComboBox({scope:this,name:"radiusZip",fieldLabel:"From",labelWidth:40,queryMode:"local",displayField:"location_name_1",valueField:"zip",store:this.fromStore,listConfig:{getInnerTpl:function(){return'<div><b>{location_name_1}</b></div><div style="font-size: 10px; font-style: italic;">{address_1} {city}, {state} {zip}</div>'}}});this.filter.registerFilter(this.fromSelect);this.toolbar.add(this.fromSelect)},initSearchButton:function(){this.searchButton=new Ext.button.Button({scope:this,text:"Search",handler:function(){}});this.toolbar.add(this.searchButton)}});Ext.define("TMS.comment.filter.Comment",{extend:"TMS.filter.Abstract",init:function(){this.initShowAll()},initShowAll:function(){this.items.push({xtype:"checkbox",fieldLabel:"Show All Customer Contacts",labelWidth:200,name:"showAll"})}});Ext.define("TMS.comment.forms.sections.Comments",{extend:"Ext.panel.Panel",requires:["TMS.comment.view.Grid","TMS.comment.forms.sections.Form","TMS.comment.filter.Comment"],layout:"border",title:"Comments",baseTitle:"Comments",field_value:0,type:"contact",extraFilters:{},initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTopBar();this.initGrid();this.initForm();this.initFilter();this.initListeners()},initTopBar:function(){this.topToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{scope:this,text:"Add New Comment",handler:this.addNewComment,icon:"/resources/icons/add-16.png"}]});this.dockedItems.push(this.topToolbar)},initGrid:function(){this.gridPanel=Ext.create("TMS.comment.view.Grid",{region:"center",field_value:this.field_value,type:this.type});this.items.push(this.gridPanel)},initForm:function(){this.formPanel=Ext.create("TMS.comment.forms.sections.Form",{field_value:this.field_value,commentType:this.type});this.formWindow=Ext.create("Ext.window.Window",{title:"Comment Details",autoShow:false,modal:true,resizable:false,draggable:false,width:400,closeAction:"hide",items:[this.formPanel]});this.formPanel.getForm().setValues({field_value:this.field_value})},addNewComment:function(){this.formPanel.getForm().reset();this.formPanel.getForm().setValues({field_value:this.field_value});this.formPanel.selectFirst();this.formPanel.bottomToolbar.enable();this.formWindow.show()},initFilter:function(){this.filterPanel=Ext.create("TMS.comment.filter.Comment",{region:"east",width:250,title:"Filter",collapsible:true,collapsed:true,titleCollapse:true});this.filterPanel.on("filter",function(b,a){Ext.apply(a,this.extraFilters);this.gridPanel.store.proxy.extraParams.filter=Ext.encode(a);this.gridPanel.store.loadPage(1)},this);this.items.push(this.filterPanel)},initListeners:function(){this.gridPanel.store.on("load",function(a){if(a.totalCount){this.setTitle(this.baseTitle+" ("+a.totalCount+")")}else{this.setTitle(this.baseTitle)}},this);this.formPanel.on("formsuccess",function(){this.gridPanel.store.load();this.addNewComment();this.formWindow.hide()},this);this.formPanel.on("formfailure",function(){},this);this.gridPanel.on("itemclick",function(c,a,d,b,g){var f=a.data;this.formPanel.getForm().setValues(f);this.formPanel.expand();this.formPanel.bottomToolbar.disable()},this)}});Ext.define("TMS.comment.forms.sections.Form",{extend:"Ext.form.Panel",requires:["Ext.ux.form.field.RealComboBox"],layout:"anchor",processingPage:"/at-ajax/modules/comment/process/",defaults:{anchor:"100%"},commentType:"contact",field_value:0,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initStore();this.initBottomBar();this.initCommentType();this.initCommentBox();this.initHidden()},initStore:function(){this.store=Ext.create("Ext.data.Store",{fields:["comment_type_id","comment_type_name"],proxy:{type:"ajax",url:this.processingPage+"get-comment-types",reader:{type:"json",root:"records"},extraParams:{commentType:this.commentType}}});this.store.load();this.store.on("load",this.selectFirst,this)},selectFirst:function(){if(this.commentType){var a=this.commentType.store.getAt(0);if(a){this.commentType.setValue(a.get("comment_type_id"))}}},initBottomBar:function(){this.bottomToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",pack:"right"});this.dockedItems.push(this.bottomToolbar);this.bottomToolbar.add("->",{scope:this,text:"Save Comment",handler:this.saveComment,icon:"/resources/icons/save-16.png"})},initCommentType:function(){this.commentType=Ext.create("Ext.ux.form.field.RealComboBox",{fieldLabel:"Type",store:this.store,displayField:"comment_type_name",valueField:"comment_type_id",labelWidth:50,name:"comment_type_id",margin:"10",queryMode:"local"});this.commentType.on("change",function(b,a){if(a){this.comment.show()}else{}},this);this.items.push(this.commentType)},initCommentBox:function(){this.comment=Ext.create("Ext.form.TextArea",{grow:true,anchor:"100%",name:"comment",margin:"10",height:70});this.items.push(this.comment)},initHidden:function(){this.commentId=Ext.create("Ext.form.field.Hidden",{name:"comment_id",value:0});this.items.push(this.commentId);this.fieldValue=Ext.create("Ext.form.field.Hidden",{name:"field_value",value:this.field_value});this.items.push(this.fieldValue)},changeCommentType:function(a){this.commentType.clearValue();this.store.proxy.extraParams.group_id=a;this.store.load();this.commentType.fireEvent("change")},saveComment:function(){this.setLoading("Saving");this.getForm().submit({scope:this,url:this.processingPage+"save-comment",success:function(a,b){this.setLoading(false);this.fireEvent("formsuccess")},failure:function(a,b){this.setLoading(false);this.fireEvent("formfailure");Ext.Msg.alert("Failure",b.result.errorStr)}})}});Ext.define("TMS.comment.view.Grid",{extend:"Ext.grid.Panel",requires:["Ext.ux.RowExpander"],processingPage:"/at-ajax/modules/comment/process/",viewConfig:{stripeRows:true},features:[{ftype:"rowbody",getAdditionalData:function(c,a,b,f){var d=this.view.headerCt,e=d.getColumnCount();return{rowBody:b.get("comment"),rowBodyCls:this.rowBodyCls,rowBodyColspan:e}}}],disableSelection:true,field_value:0,type:"contact",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initColumns:function(){this.columns=[{header:"Comment About",dataIndex:"field_display",width:100,xtype:"templatecolumn",tpl:"{field_display}"},{header:"Created By",dataIndex:"created_by_first_name",width:100,xtype:"templatecolumn",tpl:"{created_by_first_name} {created_by_last_name}"},{header:"Created At",dataIndex:"created_at"},{header:"Type",dataIndex:"comment_type_name"},{header:"Comment",dataIndex:"comment",flex:1,sortable:false}]},initStore:function(){this.store=new Ext.data.Store({fields:["comment_id","comment","field_value","field_display","created_by_id","created_by_first_name","created_by_last_name","created_at","updated_at","comment_type_id","comment_type_name"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage+"get-grid-records",reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{field_value:this.field_value,type:this.type}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.store.on("load",function(c,b){return;var a=this.getView().getNodes();Ext.each(a,function(d){Ext.create("Ext.tip.ToolTip",{scope:this,target:d,anchor:"top",autoHide:true,html:this.getView().getRecord(d).get("comment"),listeners:{beforeshow:Ext.bind(function(){},this)}})},this)},this)}});Ext.define("TMS.contacts.filter.Contact",{extend:"TMS.filter.Abstract",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initName();this.initCompany();this.initOwner();this.initUpToDate();this.initStatus()},initName:function(){this.items.push({name:"name",fieldLabel:"Name"})},initCompany:function(){this.items.push({name:"company",fieldLabel:"Company"})},initOwner:function(){this.items.push({name:"owner",fieldLabel:"Owner"})},initUpToDate:function(){var a={data:[{upToDate:-1,display:"All"},{upToDate:0,display:"No"},{upToDate:1,display:"Yes"}]};this.upToDateStore=Ext.create("Ext.data.Store",{autoLoad:true,fields:["upToDate","display"],data:a,proxy:{type:"memory",reader:{type:"json",root:"data"}}});this.items.push({xtype:"realcombobox",queryMode:"local",name:"upToDate",displayField:"display",valueField:"upToDate",fieldLabel:"Up To Date",store:this.upToDateStore})},initStatus:function(){var a={data:[{status_id:-1,status_name:"All"},{status_id:9,status_name:"Cold"},{status_id:10,status_name:"Warm"},{status_id:11,status_name:"Hot"}]};this.statusStore=Ext.create("Ext.data.Store",{autoLoad:true,fields:["status_id","status_name"],data:a,proxy:{type:"memory",reader:{type:"json",root:"data"}}});this.items.push({xtype:"realcombobox",queryMode:"local",name:"status",displayField:"status_name",valueField:"status_id",fieldLabel:"Status",store:this.statusStore})}});Ext.define("TMS.contacts.forms.sections.BillTo",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.customer.lookup.Customer","TMS.location.lookup.Location"],contact_id:0,location_id:0,bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-bill-to",title:"Bill To",baseTitle:"Bill To",autoSave:false,layout:"anchor",defaults:{anchor:"100%"},recordLoaded:false,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.addEvents("recordload");this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initCompanySelector();this.initLocationSelector();this.initHidden();this.initListeners();this.load(this.contact_id)},initToolbar:function(){this.removeBillToButton=Ext.create("Ext.button.Button",{scope:this,text:"Remove Bill To",handler:this.removeBillTo});this.topBar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[this.removeBillToButton]});this.dockedItems.push(this.topBar)},initCompanySelector:function(){this.companySelector=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Company",name:"bill_to_customer_id"});this.items.push(this.companySelector)},initLocationSelector:function(){this.locationSelector=Ext.create("TMS.location.lookup.Location",{fieldLabel:"Location",type:"customer",name:"bill_to_location_id"});this.items.push(this.locationSelector)},initHidden:function(){this.contactIdField=Ext.create("Ext.form.field.Hidden",{name:"contact_id",value:this.contact_id});this.items.push(this.contactIdField)},initListeners:function(){this.companySelector.on("select",function(c,b){if(!b.length){this.locationSelector.disable();return false}this.locationSelector.enable();var a=b[0];this.locationSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.store.proxy.extraParams.to_id=a.get("customer_id");this.locationSelector.store.proxy.extraParams.locationType="Billing";this.locationSelector.store.load();this.locationSelector.focus(true,50)},this);this.locationSelector.on("select",function(c,b){var a=b[0];this.location_id=a.get("location_id");this.save()},this);this.on("beforesubmit",function(){this.contactIdField.setValue(this.contact_id)},this)},removeBillTo:function(){this.locationSelector.setValue("");this.location_id=0;if(this.autoSave&&this.contact_id){this.submit()}},save:function(){if(this.autoSave&&this.contact_id&&this.location_id){this.submit()}},load:function(a){this.contact_id=a;if(this.contact_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-bill-to-data",params:{contact_id:this.contact_id},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);this.fireEvent("recordload",this,b);this.recordLoaded=true;if(b.success){this.companySelector.setValue(b.record.customer_id);this.companySelector.setRawValue(b.record.customer_name);this.locationSelector.setValue(b.record.location_id);this.locationSelector.setRawValue(b.record.location_name_1+" "+b.record.location_name_2);this.locationSelector.store.proxy.extraParams.to_id=b.record.customer_id}else{this.companySelector.setValue(0);this.companySelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.setRawValue("")}}})}}});Ext.define("TMS.contacts.forms.sections.CarrierContacts",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect","TMS.contacts.forms.sections.ContactMethods","TMS.contacts.forms.sections.PreferredStates"],carrier_id:0,layout:{type:"hbox",align:"stretch"},processingPage:"/at-ajax/modules/carrier/process/",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initLayoutPanels();this.initContactMethods();this.initPreferredStates();this.initContactStore();this.initContactSelectorView()},initToolbar:function(){this.toolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{scope:this,text:"Add New Contact",icon:"/resources/icons/add-16.png",handler:this.addNewContact}]});this.dockedItems.push(this.toolbar)},addNewContact:function(){var a="/contacts/?d=contacts&a=add&carrier_id="+this.carrier_id;window.open(a,"_blank")},initLayoutPanels:function(){this.leftPanel=Ext.create("Ext.panel.Panel",{title:"Contacts",width:200});this.viewContactPageButton=Ext.create("Ext.button.Button",{scope:this,text:"View Contact Page",handler:this.viewContactPageClick,icon:"/resources/icons/preview-16.png"});this.rightPanel=Ext.create("Ext.panel.Panel",{flex:1,layout:{type:"vbox",align:"stretch"},defaults:{autoScroll:true,flex:1},tbar:[this.viewContactPageButton]});this.items.push(this.leftPanel,this.rightPanel)},viewContactPageClick:function(){var b=this.contactSelectorView.getSelectionModel().getSelection();if(b&&b.length){var a=b[0];var c="/contacts/?d=contacts&a=view&id="+a.data.contact_id;window.open(c,"_blank")}},initContactMethods:function(){this.contactMethods=Ext.create("TMS.contacts.forms.sections.ContactMethods",{autoSave:true});this.rightPanel.add(this.contactMethods)},initPreferredStates:function(){this.preferredStates=Ext.create("TMS.contacts.forms.sections.PreferredStates");this.rightPanel.add(this.preferredStates)},initContactStore:function(){this.contactStore=Ext.create("Ext.data.Store",{fields:["contact_id","first_name","last_name"],proxy:{type:"ajax",url:this.processingPage+"get-contacts",extraParams:{carrier_id:this.carrier_id},reader:{type:"json",root:"records"}}});this.contactStore.on("load",this.selectFirst,this);this.on("afterrender",function(){this.contactStore.load()},this)},initContactSelectorView:function(){this.contactSelectorView=Ext.create("Ext.view.View",{title:"Contacts",store:this.contactStore,tpl:['<tpl for=".">','<div class="carrier-contact-row">{first_name} {last_name}</div>',"</tpl>",'<div class="x-clear"></div>',],autoHeight:true,trackOver:true,overItemCls:"carrier-contact-row-hover",selectedItemCls:"carrier-contact-row-selected",itemSelector:".carrier-contact-row",emptyText:"No contacts",deferEmptyText:false,listeners:{scope:this,selectionchange:function(b,a){if(a.length){this.selectRecord(a[0].index)}}}});this.leftPanel.add(this.contactSelectorView)},selectFirst:function(){if(this.contactStore.count()){this.leftPanel.doLayout();this.contactSelectorView.suspendEvents();this.selectRecord(0);this.contactSelectorView.resumeEvents()}else{this.rightPanel.hide()}},selectRecord:function(c){this.contactSelectorView.select(c);var a=this.contactStore.getAt(c);var d=a.data.contact_id;var b=a.data.first_name+" "+a.data.last_name;this.rightPanel.setTitle(b);this.contactMethods.loadRecord(d);this.preferredStates.loadContact(d,this.carrier_id)}});Ext.define("TMS.contacts.forms.sections.CarrierInformation",{extend:"Ext.panel.Panel",requires:["TMS.carrier.lookup.Carrier","TMS.location.lookup.Location","TMS.location.forms.Form","TMS.form.plugin.StatusBar","TMS.ActionWindow"],bodyStyle:{padding:"10px"},border:false,processingPage:"/at-ajax/modules/carrier/process/",carrierProcessingPage:"/at-ajax/modules/carrier/process/",carrierLookupPage:"/at-ajax/modules/carrier/lookup/",contact_id:0,fieldValues:{},layout:"anchor",defaults:{anchor:"100%"},initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCarrierPanel();this.initLocationPanel();this.initCarrierLookup();this.initLocationLookup();this.initListeners()},initListeners:function(){if(this.carrier_id){this.on("afterrender",function(){this.carrierLookup.loadFromStore({carrier_id:this.carrier_id},false);this.locationLookup.store.on("load",function(b,a){if(a.length){this.locationLookup.enable();this.locationLookup.select(a[0])}},this,{single:true});this.locationLookup.store.load({params:{to_id:this.carrier_id}})})}},initCarrierPanel:function(){this.carrierPanel=new Ext.panel.Panel({scope:this,layout:"hbox",border:false,unstyled:true,autoHeight:true,defaults:{margin:2}});this.items.push(this.carrierPanel)},initLocationPanel:function(){this.locationPanel=new Ext.panel.Panel({scope:this,layout:"hbox",border:false,unstyled:true,autoHeight:true,defaults:{margin:2}});this.items.push(this.locationPanel)},initCarrierLookup:function(){this.carrierLookup=Ext.create("TMS.carrier.lookup.Carrier",{fieldLabel:"Carrier",flex:1});this.carrierAddButton=new Ext.button.Button({scope:this,width:150,text:"Add New Carrier",handler:function(){var b=this.createLocationWindow({title:"Add New Carrier"});var a=new Ext.form.field.Text({xtype:"textfield",name:"mc_no",fieldLabel:"MC Number",enableKeyEvents:true,msgTarget:"under"});this.carrierApproval=Ext.create("Ext.Img",{src:"/resources/silk_icons/thumbs_down_red.png",width:24,height:24});this.carrierInsurance=Ext.create("Ext.form.FieldSet",{items:[],title:"Insurance Information",getFieldValues:function(){var c=[];Ext.each(this.items.items,function(d){c.push(d.getForm().getValues())},this);return c}});carrierApprovalPanel=new Ext.Container({items:[this.carrierApproval,this.carrierInsurance],hidden:true});a.on("change",function(f,e,c){if(e==c){return}var d=f.getValue();if(d.length!=6){return}b.setLoading(true);b.form.locationSection.clearFieldValues();Ext.Ajax.request({scope:this,url:this.carrierLookupPage+"carrier411",params:{mc:f.getValue()},success:function(j,i){var g=Ext.JSON.decode(j.responseText);if(g.record!=null){thumbsUp=false;if(g.record.FMCSACOMMON=="A"||g.record.FMCSACONTRACT=="A"){if(g.record.SAFETYRATING!="N"){if(g.record.insurance.length){thumbsUp=true}}}if(thumbsUp){this.carrierApproval.setSrc("/resources/silk_icons/thumbs_up_green.png")}else{this.carrierApproval.setSrc("/resources/silk_icons/thumbs_down_red.png")}this.carrierInsurance.removeAll(true);Ext.each(g.record.insurance,function(k,l){this.carrierInsurance.add(new Ext.form.Panel({items:[{xtype:"displayfield",name:"type",fieldLabel:"Type",value:k.INSURTYPE},{xtype:"displayfield",name:"effective",fieldLabel:"Effective Date",value:k.INSUREFFECTIVE},{xtype:"hidden",name:"insurance_type_name",fieldLabel:"Type",value:k.INSURTYPE},{xtype:"hidden",name:"effective_date",fieldLabel:"Effective Date",value:k.INSUREFFECTIVE},{xtype:"hidden",name:"agency_name",value:k.INSURCOMPANY},{xtype:"hidden",name:"policy_number",value:k.INSURPOLICYNUM},{xtype:"hidden",name:"insurance_value",value:(k.INSURBIPDTO?k.INSURBIPDTO:"")}],bodyStyle:{background:(l%2?"#eaeaea":""),border:0}}))},this);var h={name1:g.record.FMCSALEGALNAME,name2:g.record.FMCSADBANAME,address1:g.record.FMCSABUSADDRESS,zip:g.record.FMCSABUSZIP.split("-",1),phone:g.record.FMCSABUSPHONE,safety_rating_date:g.record.SAFETYRATEDATE,safety_rating:g.record.SAFETYRATING,insurance:thumbsUp};b.form.getForm().setValues(h);carrierApprovalPanel.show()}else{carrierApprovalPanel.hide();a.markInvalid(g.errors)}b.setLoading(false);b.doLayout()}})},this,{buffer:250});Ext.each(b.form.locationSection.items.items,function(e,c){e.setReadOnly(true)});b.form.locationSection.insert(0,a);b.form.locationSection.insert(0,carrierApprovalPanel);b.form.on("success",function(d,e){var c=e.result;Ext.Ajax.request({scope:this,url:this.carrierProcessingPage+"process",locationResult:c,params:Ext.apply({location_id:c.record.location_id,insurance_info:Ext.encode(this.carrierInsurance.getFieldValues())},d.getValues()),success:function(i,h){var g=Ext.JSON.decode(i.responseText);var f=h.locationResult.record;if(g.success){b.setLoading(false);b.destroy();this.carrierLookup.store.on("load",function(k,j,m,l){if(j.length){this.carrierLookup.select(j[0])}},this,{single:true});this.carrierLookup.store.load({params:{carrier_id:g.record.carrier_id}});this.locationLookup.enable();this.locationLookup.store.on("load",function(k,j,m,l){if(j.length){this.locationLookup.select(j[0])}},this,{single:true});this.locationLookup.store.proxy.extraParams.to_id=g.record.customer_id;this.locationLookup.store.load({params:{location_id:f.location_id}})}}})},this)}});this.carrierPanel.add(this.carrierLookup,this.carrierAddButton)},initLocationLookup:function(){this.locationLookup=Ext.create("TMS.location.lookup.Location",{type:"carrier",fieldLabel:"Location",flex:1,disabled:true,hiddenName:"location_id"});this.carrierLookup.on("select",function(c,b){if(!b.length){this.locationLookup.disable();return false}this.locationLookup.enable();var a=b[0];this.locationLookup.setValue("");this.locationLookup.setRawValue("");this.locationLookup.store.proxy.extraParams.to_id=a.get("carrier_id");this.locationLookup.store.loadPage(1);this.locationLookup.focus(true,50);this.locationLookup.expand()},this);this.locationAddButton=new Ext.button.Button({scope:this,width:150,text:"Add New Location",disabled:true,handler:function(){var a=this.createLocationWindow({title:"Add New Location"});a.on("show",function(b){b.down("textfield[name=name1]").setValue(this.locationLookup.getRawValue());b.down("textfield[name=name1]").focus(true,50)},this);a.on("failure",function(c,d){var b=d.result.errors.join(", ");Ext.MessageBox.alert("Errors",b,Ext.bind(function(){this.setLoading(false)},a))},a);a.on("success",function(c,d){var b=d.result;Ext.Ajax.request({scope:this,url:this.carrierProcessingPage+"add-location",locationResult:b,params:{carrier_id:this.carrierLookup.getValue(),location_id:b.record.location_id},success:function(h,g){var f=Ext.JSON.decode(h.responseText);var e=g.locationResult.record;a.setLoading(false);a.destroy();this.locationLookup.enable();this.locationLookup.store.on("load",function(j,i,l,k){if(i.length){this.locationLookup.select(i[0])}},this,{single:true});this.locationLookup.store.proxy.extraParams.to_id=this.carrierLookup.getValue();this.locationLookup.store.load({params:{location_id:e.location_id}})}})},this);a.show()}});this.locationLookup.on("disable",function(){this.locationAddButton.disable()},this);this.locationLookup.on("enable",function(){this.locationAddButton.enable()},this);this.locationPanel.add(this.locationLookup,this.locationAddButton)},createLocationWindow:function(a){var b=Ext.create("TMS.location.forms.Form",{scope:this,autoScroll:true,plugins:[Ext.create("TMS.form.plugin.StatusBar")],carrier_id:this.carrierLookup.getValue()});var c=Ext.create("TMS.ActionWindow",Ext.apply({scope:this,layout:"fit",modal:true,form:b,items:[b],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",layout:{pack:"center"},items:[{scope:this,type:"button",text:"Save",handler:function(){c.form.submit()}},{scope:this,type:"button",text:"Cancel",handler:function(){c.destroy()}}]}]},a));return c}});Ext.define("TMS.contacts.forms.sections.Claim",{extend:"TMS.ActionWindow",title:"Claim Contact",processingPage:"/at-ajax/modules/contact/process/",contact_id:0,defaultText:"",init:function(){this.on("afterrender",this.claimContact,this);this.initButtons()},claimContact:function(){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"claim-contact",params:{contact_id:this.contact_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);if(a.success){this.update(a.msg[0]);this.showCloseButton()}else{this.update(a.errorStr)}}})},initButtons:function(){this.addBottomButton([{scope:this,text:"Close",handler:function(){this.close()}}])}});Ext.define("TMS.contacts.forms.sections.CompanyInformation",{extend:"Ext.panel.Panel",requires:["TMS.customer.lookup.Customer","TMS.location.lookup.Location","TMS.customer.forms.Form","TMS.form.plugin.StatusBar","TMS.ActionWindow","TMS.location.forms.Form"],bodyStyle:{padding:"10px"},title:"Company Information",processingPage:"/at-ajax/modules/contact/process/",customerProcessingPage:"/at-ajax/modules/customer/process/",contact_id:0,fieldValues:{},layout:"anchor",defaults:{anchor:"100%"},isPayTo:false,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCustomerPanel();this.initLocationPanel();this.initCustomerLookup();this.initLocationLookup();this.initListeners()},initListeners:function(){this.on("expand",function(){this.scrollIntoView()},this);if(this.contact_id){this.on("afterrender",function(){this.customerLookup.store.on("load",function(b,a){if(a&&a.length){this.customerLookup.select(a[0])}},this,{single:true});this.customerLookup.store.load({params:{contact_id:this.contact_id}});this.locationLookup.store.on("load",function(b,a){if(a&&a.length){this.locationLookup.enable();this.locationLookup.select(a[0])}},this,{single:true});this.locationLookup.store.load({params:{contact_id:this.contact_id}})});this.locationLookup.on("select",function(c,b){if(b&&b.length){var a=b[0];var d=a.data.location_id;Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"save-location",params:{contact_id:this.contact_id,location_id:d}})}},this)}},initCustomerPanel:function(){this.customerPanel=new Ext.panel.Panel({scope:this,layout:"hbox",border:false,unstyled:true,defaults:{margin:2}});this.items.push(this.customerPanel)},initLocationPanel:function(){this.locationPanel=new Ext.panel.Panel({scope:this,layout:"hbox",border:false,unstyled:true,defaults:{margin:2}});this.items.push(this.locationPanel)},initCustomerLookup:function(){this.customerLookup=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Company",flex:1,proxyParams:{isPayTo:this.isPayTo}});this.customerAddButton=new Ext.button.Button({scope:this,width:150,text:"Add New Company",handler:function(){var a=this.createCustomerWindow({title:"Add New Company"});a.form.down("textfield[name=customerName]").focus(true,50);a.form.on("success",function(e,f){var b=f.result;if(b.success){var d=b.record;this.locationLookup.enable();this.locationLookup.store.proxy.extraParams.to_id=d.customer_id;this.customerLookup.loadFromStore({customer_id:d.customer_id},false);a.destroy();var c=this.locationAddButtonClick();c.down("textfield[name=name1]").setValue(d.customer_name);c.down("*[name=customer_id]").setValue(d.customer_id)}},this);a.show()}});this.customerPanel.add(this.customerLookup,this.customerAddButton)},initLocationLookup:function(){this.locationLookup=Ext.create("TMS.location.lookup.Location",{type:"customer",fieldLabel:"Location",flex:1,disabled:true,hiddenName:"location_id",name:"location_id"});this.customerLookup.on("select",function(c,b){if(!b.length){this.locationLookup.disable();return false}this.locationLookup.enable();var a=b[0];this.locationLookup.setRawValue("");this.locationLookup.setValue("");this.locationLookup.store.proxy.extraParams.to_id=a.get("customer_id");this.locationLookup.store.loadPage(1);this.locationLookup.focus(true,50);this.locationLookup.expand()},this);this.locationAddButton=new Ext.button.Button({scope:this,width:150,text:"Add New Location",disabled:true,handler:this.locationAddButtonClick});this.locationLookup.on("disable",function(){this.locationAddButton.disable()},this);this.locationLookup.on("enable",function(){this.locationAddButton.enable()},this);this.locationPanel.add(this.locationLookup,this.locationAddButton)},locationAddButtonClick:function(){var a=this.createLocationWindow({title:"Add New Location"});a.form.down("*[name=customer_id]").setValue(this.customerLookup.getRealValue());a.form.down("textfield[name=name1]").setValue(this.locationLookup.getRawValue());a.form.down("textfield[name=name1]").focus(true,50);a.form.on("success",function(d,e){var b=e.result;var c=b.record;a.destroy();this.locationLookup.enable();this.locationLookup.loadFromStore({location_id:c.location_id});this.locationLookup.store.proxy.extraParams.to_id=this.customerLookup.getValue()},this);return a},createCustomerWindow:function(a){var b=Ext.create("TMS.customer.forms.Form",{scope:this,isPayTo:this.isPayTo,plugins:[Ext.create("TMS.form.plugin.StatusBar")]});b.customerName.setValue(this.customerLookup.getRawValue());var c=Ext.create("TMS.ActionWindow",Ext.apply({scope:this,modal:true,layout:"fit",form:b,items:[b],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",layout:{pack:"center"},items:[{scope:this,type:"button",text:"Save",handler:function(){c.form.submit()}},{scope:this,type:"button",text:"Cancel",handler:function(){c.destroy()}}]}]},a));return c},createLocationWindow:function(a){var b=Ext.create("TMS.location.forms.Form",{scope:this,plugins:[Ext.create("TMS.form.plugin.StatusBar")],customer_id:this.customerLookup.getValue()});var c=Ext.create("TMS.ActionWindow",Ext.apply({scope:this,modal:true,minHeight:400,layout:"fit",form:b,items:[b],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",layout:{pack:"center"},items:[{scope:this,type:"button",text:"Save",handler:function(){c.form.submit()}},{scope:this,type:"button",text:"Cancel",handler:function(){c.destroy()}}]}]},a));return c}});Ext.define("TMS.contacts.forms.sections.ContactInformation",{extend:"Ext.panel.Panel",requires:["TMS.contacts.forms.sections.ContactMethods","TMS.contacts.forms.sections.ContactInterval"],icon:"/resources/icons/contact-info-24.png",border:false,layout:{type:"hbox",align:"stretch"},autoSave:false,contact_id:0,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initContactMethods();this.initContactInterval()},initContactMethods:function(){this.contactMethods=Ext.create("TMS.contacts.forms.sections.ContactMethods",{scope:this,title:"Methods",baseTitle:"Methods",flex:1,contact_id:this.contact_id,autoSave:this.autoSave});this.items.push(this.contactMethods)},initContactInterval:function(){this.contactInterval=Ext.create("TMS.contacts.forms.sections.ContactInterval",{title:"Interval",flex:1,call_interval:14,email_interval:14,disabled:true,contact_id:this.contact_id,autoSave:this.autoSave});this.items.push(this.contactInterval)}});Ext.define("TMS.contacts.forms.sections.ContactInterval",{extend:"TMS.form.Abstract",requires:["TMS.ActionWindow"],bodyStyle:{padding:"10px"},title:"Contact Intervals (in days)",processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-contact-interval",contact_id:0,autoSave:false,isLoaded:false,initComponent:function(){this.items=[];this.addEvents("recordload");this.init();this.callParent(arguments)},init:function(){this.initCall();this.initEmail();this.initVisit();this.initHidden();if(!this.contact_id){this.nextCallField.disable();this.nextEmailField.disable();this.nextVisitField.disable()}this.initListeners();this.getContactData(this.contact_id)},initCall:function(){this.callInterval=Ext.create("Ext.form.field.Text",{border:false,fieldLabel:"Call",labelWidth:60,width:100,name:"call_interval",value:this.call_interval||0});this.nextCallField=Ext.create("Ext.form.field.Date",{fieldLabel:"Next Action",name:"next_call",margin:"0 0 0 10",minValue:new Date()});this.callPanel=Ext.create("Ext.panel.Panel",{layout:"hbox",items:[this.callInterval,this.nextCallField],border:false});this.items.push(this.callPanel)},initEmail:function(){this.emailInterval=Ext.create("Ext.form.field.Text",{border:false,fieldLabel:"Email",labelWidth:60,width:100,name:"email_interval",value:this.email_interval||0});this.nextEmailField=Ext.create("Ext.form.field.Date",{fieldLabel:"Next Action",name:"next_email",margin:"0 0 0 10",minValue:new Date()});this.emailPanel=Ext.create("Ext.panel.Panel",{layout:"hbox",items:[this.emailInterval,this.nextEmailField],border:false});this.items.push(this.emailPanel)},initVisit:function(){this.visitInterval=Ext.create("Ext.form.field.Text",{border:false,fieldLabel:"Visit",labelWidth:60,width:100,name:"visit_interval",value:this.visit_interval||0});this.nextVisitField=Ext.create("Ext.form.field.Date",{fieldLabel:"Next Action",name:"next_visit",margin:"0 0 0 10",minValue:new Date()});this.visitPanel=Ext.create("Ext.panel.Panel",{layout:"hbox",items:[this.visitInterval,this.nextVisitField],border:false});this.items.push(this.visitPanel)},initHidden:function(){this.contactIdField=Ext.create("Ext.form.field.Hidden",{name:"contact_id",value:this.contact_id});this.items.push(this.contactIdField)},initListeners:function(){this.callInterval.on("change",this.save,this,{buffer:500});this.emailInterval.on("change",this.save,this,{buffer:500});this.visitInterval.on("change",this.save,this,{buffer:500});this.nextCallField.on("select",function(b,a){this.save()},this);this.nextEmailField.on("select",function(b,a){this.save()},this);this.nextVisitField.on("select",function(b,a){this.save()},this)},getContactData:function(a){this.contact_id=a;if(this.contact_id){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-contact-interval-data",params:{contact_id:this.contact_id},success:function(d){var c=Ext.decode(d.responseText);var b=c.record;this.fireEvent("recordload",this,b);this.getForm().setValues(b);if(b.now>b.next_call_ts){this.nextCallField.disable()}if(b.now>b.next_email_ts){this.nextEmailField.disable()}if(b.now>b.next_visit_ts){this.nextVisitField.disable()}setTimeout(Ext.bind(function(){this.isLoaded=true},this),500)}})}},save:function(){if(this.autoSave&&this.contact_id&&this.isLoaded){this.submit()}},setDueDate:function(){this.dateWindow=Ext.create("TMS.ActionWindow",{title:"Select a new due date",width:null,height:null,items:[{scope:this,xtype:"datepicker",minDate:new Date(),handler:function(b,a){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"set-due-date",params:{contact_id:this.contact_id,field:field,date:a},success:function(d){var c=Ext.decode(d.responseText);this.fireEvent("setdate")}});this.dateWindow.destroy()}}]})}});Ext.define("TMS.contacts.forms.sections.ContactMethodRow",{extend:"Ext.panel.Panel",autoHeight:true,layout:"hbox",border:false,defaults:{border:false},store:false,initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initContactMethodSelector();this.initMethodField();this.initButton();this.initListeners()},initContactMethodSelector:function(){this.contactMethodSelector=Ext.create("Ext.ux.form.field.RealComboBox",{flex:1,valueField:"method_id",displayField:"method_type",store:this.store,queryMode:"local",editable:false,margin:"2"});this.items.push(this.contactMethodSelector)},initMethodField:function(){this.contactMethodField=Ext.create("Ext.form.field.Text",{flex:1,xtype:"textfield",margin:"2",itemId:"method_data",enableKeyEvents:true});this.items.push(this.contactMethodField)},initButton:function(){this.button=Ext.create("Ext.button.Button",{margin:"2",icon:"/resources/icons/delete-16.png",width:24,scope:this,handler:function(a){a.ownerCt.destroy()}});this.items.push(this.button)},initListeners:function(){}});Ext.define("TMS.contacts.forms.sections.ContactMethods",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.ContactMethodRow"],title:"Contact Methods",baseTitle:"Contact Methods",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-contact-methods",contact_id:0,autoSave:false,initComponent:function(){this.items=[];this.addEvents("save","recordload");this.init();this.callParent(arguments)},init:function(){this.initHidden();this.initListeners();this.initStore();this.loadRecord()},initHidden:function(){this.contactIdField=Ext.create("Ext.form.field.Hidden",{name:"contact_id",value:this.contact_id});this.items.push(this.contactIdField)},initListeners:function(){this.on("add",this.itemAdded,this,{buffer:500});this.on("remove",this.itemRemoved,this,{buffer:1000});this.on("beforesubmit",function(c){if(!this.rendered){return}var e=this.getRows();var f=e.length;var b=[];var d=[];for(var a=0;a<f;a++){b.push(e[a].contactMethodSelector.getValue());d.push(e[a].contactMethodField.getValue());e[a].contactMethodSelector.name="contact_method_type_"+a;e[a].contactMethodField.name="contact_method_data_"+a}this.contactIdField.setValue(this.contact_id);c.setParam("contact_method_types",Ext.encode(b));c.setParam("contact_method_data",Ext.encode(d))},this)},getEmail:function(){var a=false;var c=this.getRows();var d=c.length;for(var b=0;b<d;b++){if(c[b].contactMethodSelector.getRawValue()=="Email"){return c[b].contactMethodField.getValue()}}},initStore:function(){this.contactMethodStore=Ext.create("Ext.data.Store",{fields:["method_id","method_type","method_group_id"],proxy:{type:"ajax",url:this.processingPage+"get-contact-method-types",reader:{type:"json",root:"records"}}});this.contactMethodStore.load()},selectFirst:function(b){if(b&&b.store){var a=b.store.getAt(0);if(a){b.setValue(a.get("method_id"))}}},getFirstUnusedIndex:function(j){var c=0;var f=[];var h=this.getRows();for(var g=0;g<h.length-1;g++){var b=h[g].items.items[0];var a=b.getValue();f.push(a)}var e=j.store.data.items;var d=e.length;for(var g=0;g<d;g++){if(f.indexOf(e[g].data.method_id)==-1){c=g;break}}return c},selectFirstUnused:function(b){if(b&&b.store){var a=b.store.getAt(this.getFirstUnusedIndex(b));b.setValue(a.get("method_id"))}},addContactMethod:function(){},createRow:function(){var a=Ext.create("TMS.contacts.forms.sections.ContactMethodRow",{store:this.contactMethodStore});a.contactMethodField.on("keyup",function(e){if(e.getValue().length){var b=this.query("#method_data");var d=b[b.length-1];if(d.getValue().length){var c=this.createRow();this.add(c);this.selectFirstUnused(c.contactMethodSelector)}}},this);a.contactMethodField.on("change",function(d){if(!d.getValue().length){var b=this.query("#method_data");var c=b[b.length-1];if(d!=c){d.ownerCt.destroy()}}this.save()},this,{buffer:700});return a},loadRecord:function(c,b){this.contact_id=c||this.contact_id;var d=this.baseTitle;if(b!=null&&this.baseTitle.length){d=this.baseTitle+" - "+b}if(this.rendered){this.setTitle(d)}else{this.title=d}if(this.contactMethodStore.isLoading()){this.contactMethodStore.on("load",function(){this.loadRecord()},this)}else{if(this.contact_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-contact-method-data",params:{contact_id:this.contact_id},success:function(k){this.setLoading(false);var g=Ext.decode(k.responseText);var f=g.records;this.fireEvent("recordload",this,f);this.suspendEvents();this.destroyRows();this.resumeEvents();for(var j=0;j<f.length;j++){var e=this.createRow();e.contactMethodSelector.setValue(f[j].method_id);e.contactMethodField.setRawValue(f[j].contact_value_1);this.add(e)}var h=this.createRow();this.add(h);this.selectFirst(h.contactMethodSelector)}})}else{var a=this.createRow();this.add(a);this.selectFirst(a.contactMethodSelector)}}},destroyRows:function(){Ext.each(this.query("> .panel"),function(a){a.destroy()})},itemAdded:function(a,c,b){var d=this.query("> .panel");this.manageRemoveButtons(d)},itemRemoved:function(a,c,b){var d=this.query("> .panel");if(d.length){this.manageRemoveButtons(d);this.save()}},manageRemoveButtons:function(b){if(b.length){for(var a=0;a<b.length-1;a++){b[a].down(".button").enable()}b[b.length-1].down(".button").disable()}},getRows:function(){return this.query("> .panel")},save:function(){if(this.contact_id&&this.autoSave){this.submit()}}});Ext.define("TMS.contacts.forms.sections.Email",{extend:"TMS.form.Abstract",requires:[],bodyStyle:{padding:"8px"},url:"/at-ajax/modules/contact/process/send-email",layout:{type:"vbox",align:"stretch"},contact_id:0,contactMethodsUrl:"/at-ajax/modules/contact/process/get-contact-method-data",initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initHidden();this.initEmail();this.initSubject();this.initMessage();this.loadData()},loadData:function(){if(this.contact_id){Ext.Ajax.request({scope:this,method:"post",url:this.contactMethodsUrl,params:{contact_id:this.contact_id},success:function(c){var b=Ext.decode(c.responseText);var a=b.records;var d=[];Ext.each(a,function(e){if(e.method_type=="Email"){d.push({email:e.contact_value_1})}},this);this.emailStore.loadData(d);if(d.length){this.emailSelect.select(this.emailStore.getAt(0))}else{this.emailSelect.setValue("")}}})}},initHidden:function(){this.items.push({xtype:"hidden",name:"contact_id",value:this.contact_id})},initEmail:function(){this.emailStore=Ext.create("Ext.data.Store",{fields:["email"],proxy:{type:"memory",reader:{type:"json",root:"records"}}});this.emailSelect=new Ext.form.field.ComboBox({scope:this,flex:1,name:"email",queryMode:"local",displayField:"email",valueField:"email",store:this.emailStore});this.emailAdd=new Ext.button.Button({scope:this,text:"Add Email",icon:"/resources/icons/add-16.png",margin:"0 0 0 4",handler:function(){var a=Ext.create("TMS.contacts.forms.sections.ContactMethods",{contact_id:this.contact_id,title:"",baseTitle:"",plugins:[Ext.create("TMS.form.plugin.StatusBar",{scope:this,items:[{text:"Save",cls:"submit",icon:"/resources/icons/save-16.png",handler:function(){a.submit()}}]})]});a.on("success",function(){this.loadData()},this);Ext.create("TMS.ActionWindow",{title:"Contact Methods",layout:"fit",items:[a]})}});this.emailContainer=Ext.create("Ext.form.FieldContainer",{scope:this,fieldLabel:"Email",combineErrors:true,layout:"hbox",defaults:{hideLabel:true},items:[this.emailSelect,this.emailAdd]});this.items.push(this.emailContainer)},initSubject:function(){this.subject=new Ext.form.field.Text({scope:this,name:"subject",fieldLabel:"Subject"});this.items.push(this.subject)},initMessage:function(){this.message=Ext.create("Ext.form.HtmlEditor",{name:"message",flex:1,allowBlank:false,value:"&nbsp;"});this.items.push(this.message)}});Ext.define("TMS.contacts.forms.sections.GeneralInformation",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.lookup.Contact"],title:"General Information",icon:"/resources/icons/general-info-24.png",processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-contact",contact_id:0,fieldValues:{},layout:{type:"hbox",align:"stretch"},autoSave:false,initComponent:function(){this.items=[];this.addEvents("recordload");this.init();this.callParent(arguments)},init:function(){this.initListeners();this.loadRecord();this.initLeftContainer();this.initRightContainer();if(this.contact_id){this.initOtherContactsPanel()}else{this.initSimilarPanel()}this.initFields()},initListeners:function(){},loadRecord:function(a){this.contact_id=a||this.contact_id;if(this.contact_id){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-contact-data",params:{contact_id:this.contact_id},success:function(c){var b=Ext.decode(c.responseText);this.record=b.record;this.fireEvent("recordload",this,this.record);this.setData()}})}},setData:function(a){if(this.typeStore.isLoading()){this.typeStore.on("load",function(){this.setData()},this)}else{this.down("#contact_type_id").setValue(this.record.contact_type_id);this.down("#contact_type_id").disable();this.down("#contact_name").setValue(this.record.contact_name);this.down("#contact_title").setValue(this.record.contact_title);if(this.record.contact_type_id==2){this.down("#status_id").show();if(this.statusTypeStore.isLoading()){this.statusTypeStore.on("load",function(){this.down("#status_id").suspendEvents();this.down("#status_id").setValue(this.record.status_id);this.down("#status_id").resumeEvents()},this)}else{this.down("#status_id").suspendEvents();this.down("#status_id").setValue(this.record.status_id);this.down("#status_id").resumeEvents()}}}},focusField:function(a){this.fieldValues[a.id]=a.getValue()},blurField:function(a){if(this.fieldValues[a.id]!=null){if(this.fieldValues[a.id]!=a.getValue()){this.save()}}},initLeftContainer:function(){this.leftContainer=new Ext.panel.Panel({scope:this,layout:"anchor",autoHeight:true,flex:1,border:false,bodyPadding:10,defaults:{anchor:"98%"}});this.items.push(this.leftContainer)},initRightContainer:function(){this.rightContainer=new Ext.panel.Panel({cls:"similar-contacts-panel",layout:"anchor",bodyPadding:5,scope:this,frame:false,flex:1,autoScroll:true,height:200,bodyStyle:{"border-right":"0px","border-top":"0px","border-bottom":"0px"},defaults:{anchor:"98%"}});this.items.push(this.rightContainer)},initFields:function(){this.typeStore=Ext.create("Ext.data.Store",{fields:["type_id","type_name"],proxy:{type:"ajax",url:this.processingPage+"get-contact-types",reader:{type:"json",root:"records"}}});this.typeStore.on("load",function(b,a){if(a.length==1){this.typeSelector.select(a[0])}},this);this.typeStore.load();this.typeSelector=Ext.create("Ext.ux.form.field.RealComboBox",{store:this.typeStore,displayField:"type_name",valueField:"type_id",hiddenName:"contact_type_id",fieldLabel:"Contact Type",queryMode:"local",editable:false,itemId:"contact_type_id",id:"contact_type_id",name:"contact_type_id",allowBlank:false,listeners:{scope:this,change:function(a,b){if(b==2){this.down("#status_id").show()}else{this.down("#status_id").hide()}}}});this.leftContainer.add(this.typeSelector);this.typeSelector.on("change",function(){this.nameField.enable();this.titleField.enable()},this,{single:true});this.nameField=this.leftContainer.add({xtype:"textfield",plugins:[Ext.create("TMS.form.plugin.Help","This is the first name, and last name of the contact.")],border:false,fieldLabel:"Name",name:"contact_name",itemId:"contact_name",enableKeyEvents:true,allowBlank:false,listeners:{scope:this,focus:this.focusField,blur:this.blurField},disabled:true});this.titleField=this.leftContainer.add({xtype:"textfield",border:false,fieldLabel:"Title",name:"contact_title",itemId:"contact_title",listeners:{scope:this,focus:this.focusField,blur:this.blurField},disabled:true});this.statusTypeStore=Ext.create("Ext.data.Store",{fields:["status_id","status_name"],proxy:{type:"ajax",url:this.processingPage+"get-contact-status-types",reader:{type:"json",root:"records"}}});this.statusTypeStore.load();this.leftContainer.add({xtype:"realcombobox",plugins:[Ext.create("TMS.form.plugin.Help","<ul><li><b>Cold: </b>Location is unknown, new contact.<li><b>Warm: </b> May pssibly do business with this person.<li><b>Hot: </b> Required to do business with this person, ready to book a load.</ul>")],store:this.statusTypeStore,displayField:"status_name",valueField:"status_id",hiddenName:"status_id",fieldLabel:"Status",queryMode:"local",editable:false,itemId:"status_id",name:"status_id",hidden:true,listeners:{scope:this,change:function(a,c,b){if(c!=null){this.save()}}}});this.contactIdField=Ext.create("Ext.form.field.Hidden",{name:"contact_id",value:this.contact_id});this.items.push(this.contactIdField)},initSimilarPanel:function(){this.similarStore=new Ext.data.Store({fields:["name","location","owner"],proxy:{type:"ajax",url:this.processingPage+"get-similar",reader:{type:"json",root:"records"}}});this.similarTemplate=new Ext.XTemplate('<div class="similar-contacts-container">','<tpl for=".">','<div class="similar-contact">','<div class="name-location">','<span class="name">{name}</span>','<tpl if="location.length">','<span class="at"> at</span> <span class="location">{location}</span>',"</tpl>","</div>",'<tpl if="owner.length">','<div class="owner">owned by {owner}</div>',"</tpl>","</div>","</tpl>","</div>");this.similarView=new Ext.view.View({scope:this,store:this.similarStore,tpl:this.similarTemplate,autoHeight:true,multiSelect:false,trackOver:true,deferEmptyText:false,overItemCls:"similar-contact-over",itemSelector:".similar-contact",emptyText:"No similar contacts..."});this.similarView.on("refresh",function(b,a){this.doLayout()},this);this.on("afterrender",function(){var a=this.down("#contact_name");var b=this.typeSelector;b.on("change",function(e,d,c){if(d==c){return false}this.similarStore.proxy.extraParams.contactTypeId=d;if(this.similarStore.proxy.extraParams.query!=null&&this.similarStore.proxy.extraParams.query.length){this.similarStore.load()}},this);a.on("keyup",function(e,d,c){this.similarStore.proxy.extraParams.query=e.getValue();this.similarStore.load()},this,{buffer:250})},this);this.rightContainer.setTitle("Similar Contacts");this.rightContainer.add(this.similarView)},initOtherContactsPanel:function(){this.otherContactSelector=Ext.create("TMS.contacts.lookup.Contact",{anchor:"98%",hideTrigger:false});this.otherContactSelector.on("select",function(e,b){if(b&&b.length){var a=b[0];var d=a.data.contact_id;var c="/contacts/?d=contacts&a=view&id="+d;this.otherContactSelector.setRawValue("");window.open(c,"_blank")}},this);this.otherContactSelector.store.proxy.url="/at-ajax/modules/contact/lookup/other-contacts";this.otherContactSelector.store.proxy.extraParams.contact_id=this.contact_id;this.otherContactSelector.store.load();this.rightContainer.setTitle("Other Customer Contacts");this.rightContainer.add(this.otherContactSelector)},save:function(){if(this.contact_id&&this.autoSave){this.submit()}}});Ext.define("TMS.contacts.forms.sections.ModesEquipment",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect"],bodyStyle:{padding:"10px"},title:"Allowed Modes and Equipment",autoHeight:true,processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-modes-equipment",autoSave:true,layout:"hbox",contact_id:0,carrier_id:0,modeIds:[],equipmentIds:[],modesLoaded:false,equipmentLoaded:false,loaded:false,initComponent:function(){this.items=[];this.addEvents("recordload");this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initStore();this.initHidden();this.initFields();this.loadData()},initListeners:function(){this.on("afterrender",function(){if(this.contact_id||this.carrier_id){}},this);this.on("beforesubmit",function(a){if(!this.rendered){return}this.modes.setValue(Ext.encode(this.modesAllowed.getValue()));this.equipment.setValue(Ext.encode(this.equipmentAllowed.getValue()));if(a==this){this.setParams({contact_id:this.contact_id,carrier_id:this.carrier_id})}},this)},initStore:function(){this.modesStore=Ext.create("Ext.data.Store",{fields:["mode_id","mode_name"],proxy:{type:"ajax",url:this.processingPage+"get-modes-list",reader:{type:"json",root:"modeList"}}});this.equipmentStore=Ext.create("Ext.data.Store",{fields:["CarrEquipId","CarrEquipDesc"],proxy:{type:"ajax",url:this.processingPage+"get-equipment-list",reader:{type:"json",root:"equipmentList"}}});this.modesStore.load();this.equipmentStore.load()},initHidden:function(){this.modes=Ext.create("Ext.form.field.Hidden",{name:"modesAllowed"});this.items.push(this.modes);this.equipment=Ext.create("Ext.form.field.Hidden",{name:"equipmentAllowed"});this.items.push(this.equipment)},initFields:function(){this.modesAllowed=Ext.create("Ext.ux.form.field.BoxSelect",{store:this.modesStore,multiSelect:true,labelAlign:"top",fieldLabel:"Modes Allowed",displayField:"mode_name",valueField:"mode_id",itemId:"modesAllowed",flex:1,margin:2,queryMode:"local"});this.modesAllowed.on("afterrender",function(){this.modesAllowed.on("change",function(){this.save()},this,{buffer:1000})},this);if(this.modeIds.length){this.modesAllowed.store.on("load",function(){var a=[];Ext.each(this.modeIds,function(c){var b=this.modesAllowed.store.getAt(this.modesAllowed.store.find("mode_id",c));a.push(b)},this);this.modesAllowed.select(a)},this)}this.items.push(this.modesAllowed);this.equipmentAllowed=Ext.create("Ext.ux.form.field.BoxSelect",{store:this.equipmentStore,multiSelect:true,labelAlign:"top",fieldLabel:"Equipment Allowed",displayField:"CarrEquipDesc",valueField:"CarrEquipId",itemId:"equipmentAllowed",flex:1,margin:2,queryMode:"local"});this.equipmentAllowed.on("afterrender",function(){this.equipmentAllowed.on("change",function(){this.save()},this,{buffer:1000})},this);if(this.equipmentIds.length){this.equipmentAllowed.store.on("load",function(){var a=[];Ext.each(this.equipmentIds,function(c){var b=this.equipmentAllowed.store.getAt(this.equipmentAllowed.store.find("CarrEquipId",c));a.push(b)},this);this.equipmentAllowed.select(a)},this)}this.items.push(this.equipmentAllowed)},loadData:function(){if(!this.rendered){this.on("afterrender",function(){this.loadData()},this);return}if(this.contact_id||this.carrier_id){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-modes-equipment",params:{contact_id:this.contact_id,carrier_id:this.carrier_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("recordload",this,a);this.modeIds=a.modeIds;this.equipmentIds=a.equipmentIds;if(this.modesStore.isLoading()){this.modesStore.on("load",function(){this.modesAllowed.setValue(this.modeIds);this.modesLoaded=true;this.checkLoaded()},this)}else{this.modesAllowed.setValue(this.modeIds);this.modesLoaded=true;this.checkLoaded()}if(this.equipmentStore.isLoading()){this.equipmentStore.on("load",function(){this.equipmentAllowed.setValue(this.equipmentIds);this.equipmentLoaded=true;this.checkLoaded()},this)}else{this.equipmentAllowed.setValue(this.equipmentIds);this.equipmentLoaded=true;this.checkLoaded()}}})}else{this.modesLoaded=true;this.equipmentLoaded=true;this.checkLoaded()}},checkLoaded:function(){if(this.loaded){return}if(this.equipmentLoaded&&this.modesLoaded){setTimeout(Ext.bind(function(){this.loaded=true},this),1100)}},loadContact:function(a){this.contact_id=a;this.carrier_id=0;this.loadData()},loadCarrier:function(a){this.carrier_id=a;this.contact_id=0;this.loadData()},save:function(){if((this.contact_id||this.carrier_id)&&this.autoSave&&this.loaded){this.submit()}}});Ext.define("TMS.contacts.forms.sections.PayTo",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.customer.lookup.Customer","TMS.location.lookup.Location"],carrier_id:0,loadedCarrierId:0,pay_to_location_id:0,bodyStyle:{padding:"8px"},url:"/at-ajax/modules/carrier/process/save-pay-to",processingPage:"/at-ajax/modules/carrier/process/",title:"Pay To",baseTitle:"Pay To",layout:"anchor",defaults:{anchor:"100%"},initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCustomerSelector();this.initLocationSelector();this.initListeners();this.load(this.carrier_id)},initCustomerSelector:function(){this.customerSelector=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Company",proxyParams:{isPayTo:1}});this.items.push(this.customerSelector)},initLocationSelector:function(){this.locationSelector=Ext.create("TMS.location.lookup.Location",{fieldLabel:"Location",type:"customer"});this.items.push(this.locationSelector)},initListeners:function(){this.customerSelector.on("select",function(c,b){if(!b.length){this.locationSelector.disable();return false}this.locationSelector.enable();var a=b[0];this.locationSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.store.proxy.extraParams.to_id=a.get("customer_id");this.locationSelector.store.load();this.locationSelector.focus(true,50)},this);this.locationSelector.on("select",function(c,b){var a=b[0];this.pay_to_location_id=a.get("location_id");this.save()},this);this.on("beforesubmit",function(a){a.setParams({carrier_id:this.carrier_id,pay_to_location_id:this.pay_to_location_id})},this)},save:function(){if(this.carrier_id&&this.pay_to_location_id){this.submit()}},load:function(a){this.carrier_id=a;if(this.carrier_id&&this.carrier_id!=this.loadedCarrierId){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-pay-to-data",params:{carrier_id:this.carrier_id},success:function(d){var b=Ext.decode(d.responseText);if(b.success){this.loadedCarrierId=this.carrier_id;var c=this.customerSelector.store.add({customer_id:b.data.customer_id,customer_name:b.data.customer_name});this.customerSelector.suspendEvents(false);this.customerSelector.select(c[0]);this.customerSelector.resumeEvents();c=this.locationSelector.store.add({location_id:b.data.location_id,location_display:b.data.location_name});this.locationSelector.select(c[0]);this.setTitle(this.baseTitle+" for "+b.data.forCarrierName)}else{this.customerSelector.setValue(0);this.customerSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.setRawValue("")}}})}}});Ext.define("TMS.contacts.forms.sections.PreferredStates",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect"],title:"Preferred States",baseTitle:"Preferred States",contact_id:0,carrier_id:0,layout:"hbox",url:"/at-ajax/modules/contact/process/save-preferred-states",processingPage:"/at-ajax/modules/contact/process/",loaded:false,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initLayoutPanels();this.initStore();this.initOriginStates();this.initDestinationStates();this.initListeners()},initLayoutPanels:function(){this.leftPanel=Ext.create("Ext.panel.Panel",{flex:1,autoHeight:true,border:0,layout:"anchor",defaults:{anchor:"98%"}});this.rightPanel=Ext.create("Ext.panel.Panel",{flex:1,autoHeight:true,border:0,layout:"anchor",defaults:{anchor:"98%"}});this.items.push(this.leftPanel,this.rightPanel)},initStore:function(){this.statesStore=Ext.create("Ext.data.Store",{fields:["stateCode","stateName"],proxy:{type:"ajax",url:this.processingPage+"get-state-list",reader:{type:"json",root:"records"}}});this.statesStore.load()},initOriginStates:function(){this.originStates=Ext.create("Ext.ux.form.field.BoxSelect",{store:this.statesStore,displayField:"stateName",valueField:"stateCode",queryMode:"local",multiSelect:true,padding:10,fieldLabel:"Origin",anchor:"100%"});this.leftPanel.add(this.originStates)},initDestinationStates:function(){this.destinationStates=Ext.create("Ext.ux.form.field.BoxSelect",{store:this.statesStore,displayField:"stateName",valueField:"stateCode",queryMode:"local",multiSelect:true,padding:10,fieldLabel:"Destination",anchor:"100%"});this.rightPanel.add(this.destinationStates)},loadContact:function(b,c,a){this.contact_id=b||this.contact_id;this.carrier_id=c||this.carrier_id;var d=this.baseTitle;if(a!=null){d=this.baseTitle+" - "+a}if(this.rendered){this.setTitle(d)}else{this.title=d}if(this.statesStore.isLoading()){this.statesStore.on("load",function(){this.loadContact()},this)}else{if(this.contact_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-preferred-states",params:{contact_id:this.contact_id,carrier_id:this.carrier_id},success:function(k){this.setLoading(false);var g=Ext.decode(k.responseText);var f=g.records;var e=[];var j=[];for(var h=0;h<f.length;h++){if(parseInt(f[h].origin)){e.push(f[h].state)}else{j.push(f[h].state)}}this.originStates.setValue(e);this.destinationStates.setValue(j);setTimeout(Ext.bind(function(){this.loaded=true},this),800)}})}}},initListeners:function(){this.originStates.on("change",this.savePreferredStates,this,{buffer:700});this.destinationStates.on("change",this.savePreferredStates,this,{buffer:700});this.on("beforesubmit",function(a){if(!this.rendered){return}if(a==this){this.setParams({contact_id:this.contact_id,carrier_id:this.carrier_id,originStates:Ext.encode(this.originStates.getValue()),destinationStates:Ext.encode(this.destinationStates.getValue())})}},this)},savePreferredStates:function(){if(this.loaded){this.submit()}}});Ext.define("TMS.contacts.forms.sections.Release",{extend:"TMS.ActionWindow",requires:["TMS.contacts.forms.sections.Transfer"],title:"Confirm Release",processingPage:"/at-ajax/modules/contact/process/",contact_id:0,defaultText:"",bodyPadding:10,sizePercent:0.2,minSize:200,init:function(){this.on("afterrender",this.getContactInfo,this);this.initButtons()},getContactInfo:function(){setTimeout(Ext.bind(function(){this.setLoading(true)},this),200);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-contact-data",params:{contact_id:this.contact_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.response=a;this.defaultText="<p>Are you sure you want to release "+a.record.contact_name+"?</p>";this.update(this.defaultText)}})},initButtons:function(){this.addBottomButton([{scope:this,text:"Cancel",scale:"medium",icon:"/resources/icons/close-24.png",handler:function(){this.close()}},{scope:this,text:"Transfer Contact",scale:"medium",icon:"/resources/icons/release-24.png",handler:this.transfer},{scope:this,text:"Release Restricted",scale:"medium",icon:"/resources/icons/release-restricted-24.png",handler:function(){this.release(1)}},{scope:this,text:"Release Unrestricted",scale:"medium",icon:"/resources/icons/release-unrestricted-24.png",handler:function(){this.release(0)}}])},release:function(a){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"release",params:{contact_id:this.contact_id,restricted:a},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);if(b.success){this.update(b.msg[0]);this.showCloseButton()}else{this.update(b.errorStr+this.defaultText)}}})},transfer:function(){Ext.create("TMS.contacts.forms.sections.Transfer",{contact_id:this.contact_id,title:"Confirm Transfer of "+this.response.record.contact_name});this.close()}});Ext.define("TMS.contacts.forms.sections.Transfer",{extend:"TMS.ActionWindow",requires:["TMS.user.lookup.User"],title:"Confirm Transfer",processingPage:"/at-ajax/modules/contact/process/",contact_id:0,requested_by_id:0,defaultText:"",layout:"anchor",init:function(){if(this.requested_by_id){this.on("afterrender",this.getContactInfo,this)}else{this.initUserSelector()}this.initButtons()},getContactInfo:function(){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-transfer-data",params:{contact_id:this.contact_id,requested_by_id:this.requested_by_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);if(a.success){this.defaultText="<p>"+a.msg[0]+"</p>";this.update(this.defaultText)}}})},initUserSelector:function(){this.userSelector=Ext.create("TMS.user.lookup.User");this.userSelector.on("select",function(a,b){var c=b[0].data;this.requested_by_id=c.user_id},this);this.items.push(this.userSelector)},initButtons:function(){this.addBottomButton({scope:this,text:"Cancel",handler:function(){this.close()}});if(this.requested_by_id){this.addBottomButton({scope:this,text:"Deny Transfer",handler:this.deny})}this.addBottomButton({scope:this,text:"Transfer Contact",handler:this.transfer})},transfer:function(){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"transfer-contact",params:{contact_id:this.contact_id,requested_by_id:this.requested_by_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);if(a.success){this.fireEvent("taskcomplete");this.removeAll();this.update(a.msg[0]);this.showCloseButton()}else{this.update(a.errorStr)}}})},deny:function(){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"deny-transfer-contact",params:{contact_id:this.contact_id,requested_by_id:this.requested_by_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);if(a.success){this.fireEvent("taskcomplete");this.update(a.msg[0]);this.showCloseButton()}else{this.update(a.errorStr)}}})}});Ext.define("TMS.contacts.forms.Contact",{extend:"TMS.form.Navigation",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.GeneralInformation","TMS.contacts.forms.sections.CompanyInformation","TMS.contacts.forms.sections.CarrierInformation","TMS.contacts.forms.sections.ContactInformation"],title:"Contacts",url:"/at-ajax/modules/contact/process/add",preloadCustomerId:0,preloadCarrierId:0,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initButtons();this.initGeneralInformation();this.initContactInformation()},initButtons:function(){this.buttons=[{scope:this,text:"Submit",icon:"/resources/icons/save-16.png",cls:"submit",handler:function(){this.submit()}}]},initGeneralInformation:function(){this.generalInformation=Ext.create("TMS.contacts.forms.sections.GeneralInformation",{title:"General Information",border:true});this.items.push(this.generalInformation);this.generalInformation.typeStore.on("load",function(){if(this.preloadCustomerId>0){this.generalInformation.typeSelector.setValue(2)}if(this.preloadCarrierId>0){this.generalInformation.typeSelector.setValue(3)}});this.generalInformation.down("#contact_type_id").on("change",function(e,f){var c=2;var d=3;var b=4;var a=5;if(this.locationInformation!=null){this.locationInformation.destroy()}if(f==c||f==b||f==a){this.locationInformation=Ext.create("TMS.contacts.forms.sections.CompanyInformation",{scope:this,isPayTo:(f==a)?1:0});this.center.add(this.locationInformation);if(this.preloadCustomerId>0){this.locationInformation.customerLookup.store.on("load",function(){this.locationInformation.customerLookup.setValue(this.preloadCustomerId)},this,{single:true});this.locationInformation.customerLookup.store.load({params:{customer_id:this.preloadCustomerId}})}}if(f==d){this.contactInterval.disable();this.locationInformation=Ext.create("TMS.contacts.forms.sections.CarrierInformation",{title:"Carrier Information"});this.center.add(this.locationInformation);if(this.preloadCarrierId>0){this.locationInformation.carrierLookup.store.on("load",function(){this.locationInformation.carrierLookup.setValue(this.preloadCarrierId)},this,{single:true});this.locationInformation.carrierLookup.store.load({params:{carrier_id:this.preloadCarrierId}})}}if(f==c){this.contactInterval.enable()}else{this.contactInterval.disable()}},this)},initContactInformation:function(){this.contactInformation=Ext.create("TMS.contacts.forms.sections.ContactInformation",{scope:this,title:"Contact Information"});this.items.push(this.contactInformation);this.contactMethods=this.contactInformation.contactMethods;this.contactInterval=this.contactInformation.contactInterval;this.bindForm(this.contactMethods);this.bindForm(this.contactInterval)}});Ext.define("TMS.contacts.forms.Update",{extend:"TMS.form.Navigation",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.Release","TMS.contacts.forms.sections.GeneralInformation","TMS.contacts.forms.sections.ContactInformation","TMS.calendar.view.Small","TMS.contacts.forms.sections.ModesEquipment","TMS.contacts.forms.sections.BillTo","TMS.documents.forms.sections.DocumentsRequired","TMS.comment.forms.sections.Comments","TMS.contacts.forms.sections.CompanyInformation","TMS.documents.view.Interface","TMS.orders.view.PreOrderFilteredGrid","TMS.orders.view.FilteredGrid"],contact_id:0,url:"/at-ajax/modules/contact/process/",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initGeneralInformation();this.initContactInformation();this.initCalendar();this.initModesEquipmentPanel();this.initBillToPanel();this.initDocumentsRequiredPanel();this.initCommentsPanel();this.initCompanyInformation();this.initDocuments();this.initPreOrderGrid();this.initOrderGrid()},initToolbar:function(){this.releaseButton=Ext.create("Ext.button.Button",{scope:this,text:"Release",scale:"medium",icon:"/resources/icons/release-24.png",handler:function(){Ext.create("TMS.contacts.forms.sections.Release",{contact_id:this.contact_id})}});this.callButton=Ext.create("Ext.button.Button",{scope:this,text:"Call",scale:"medium",icon:"/resources/icons/phone-24.png",handler:function(){}});this.emailButton=Ext.create("Ext.button.Button",{scope:this,text:"Email",scale:"medium",icon:"/resources/icons/email-24.png",handler:function(){var a=this.contactMethodsPanel.getEmail();var b=Ext.create("TMS.contacts.forms.sections.Email",{contact_id:this.contact_id,plugins:[Ext.create("TMS.form.plugin.StatusBar",{scope:this,items:[{text:"Send",cls:"submit",icon:"/resources/icons/save-16.png",handler:function(){b.submit()}}]})]});Ext.create("TMS.ActionWindow",{title:"Email",layout:"fit",items:[b],form:b})}});this.topBar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[this.releaseButton,"-",this.callButton,"-",this.emailButton]});this.dockedItems.push(this.topBar)},initGeneralInformation:function(){this.generalInformation=Ext.create("TMS.contacts.forms.sections.GeneralInformation",{contact_id:this.contact_id,autoSave:true});this.generalInformation.on("recordload",function(b,a){this.setTitle(a.contact_name);if(a.contact_type_id==2){this.contactIntervalPanel.enable();this.modesEquipmentPanel.enable();this.billToPanel.enable();this.documentsRequiredPanel.enable()}},this);this.items.push(this.generalInformation)},initContactInformation:function(){this.contactInformation=Ext.create("TMS.contacts.forms.sections.ContactInformation",{scope:this,contact_id:this.contact_id,autoSave:true,title:"Contact Information"});this.items.push(this.contactInformation);this.contactMethodsPanel=this.contactInformation.contactMethods;this.contactIntervalPanel=this.contactInformation.contactInterval;this.bindForm(this.contactMethodsPanel);this.bindForm(this.contactIntervalPanel)},initCalendar:function(){this.contactCalendarPanel=Ext.create("TMS.calendar.view.Small",{title:"Contact Calendar",calendarConfig:{extraParams:{contact_id:this.contact_id}}});this.items.push(this.contactCalendarPanel)},initModesEquipmentPanel:function(){this.modesEquipmentPanel=Ext.create("TMS.contacts.forms.sections.ModesEquipment",{contact_id:this.contact_id,disabled:true});this.items.push(this.modesEquipmentPanel)},initBillToPanel:function(){this.billToPanel=Ext.create("TMS.contacts.forms.sections.BillTo",{contact_id:this.contact_id,autoSave:true,disabled:true});this.items.push(this.billToPanel)},initDocumentsRequiredPanel:function(){this.documentsRequiredPanel=Ext.create("TMS.documents.forms.sections.DocumentsRequired",{contact_id:this.contact_id,autoSave:true,disabled:true});this.items.push(this.documentsRequiredPanel)},initCommentsPanel:function(){this.commentsPanel=Ext.create("TMS.comment.forms.sections.Comments",{field_value:this.contact_id,type:"contact",cls:""});this.items.push(this.commentsPanel)},initCompanyInformation:function(){this.contactTypeId=2;this.companyInformation=Ext.create("TMS.contacts.forms.sections.CompanyInformation",{title:"Company",contact_id:this.contact_id,isPayTo:(this.contactTypeId==5)?1:0});this.companyInformation.customerLookup.on("change",function(b,a){a=parseInt(a);if(isNaN(a)){}else{this.customerDocumentsGrid.setExtraParams({customer_id:a});this.customerDocumentsGrid.setTitle(this.customerDocumentsGrid.baseTitle+" for "+b.getRawValue());this.customerDocumentsGrid.store.load()}},this);this.items.push(this.companyInformation)},initDocuments:function(){this.documents=Ext.create("TMS.documents.view.Interface",{title:"Documents"});this.items.push(this.documents);this.documents.on("minimize",function(){this.setActiveItem(this.documents);this.documents.doLayout()},this)},initPreOrderGrid:function(){this.preOrderGrid=Ext.create("TMS.orders.view.PreOrderFilteredGrid",{title:"Quotes",gridConfig:{stateful:false,stateId:null},extraFilters:{ordered_by_id:this.contact_id}});this.items.push(this.preOrderGrid)},initOrderGrid:function(){this.orderGrid=Ext.create("TMS.orders.view.FilteredGrid",{gridConfig:{stateful:false,stateId:null},extraFilters:{ordered_by_id:this.contact_id}});this.items.push(this.orderGrid)}});Ext.ns("TMS.contacts.lookup.ContactTypes");TMS.contacts.lookup.ContactTypes={Contact:"contact",Customer:"customer",Carrier:"carrier"};Ext.define("TMS.contacts.lookup.Contact",{extend:"Ext.ux.form.field.RealComboBox",type:TMS.contacts.lookup.ContactTypes.Contact,processingPage:"/at-ajax/modules/contact/lookup/contact",displayField:"name",valueField:"contact_id",emptyText:"Search for contact...",typeAhead:false,hideTrigger:true,anchor:"100%",pageSize:10,minChars:0,listConfig:{loadingText:"Searching...",emptyText:"No matching contacts found.",getInnerTpl:function(){return"{name}"}},params:{},constructor:function(){this.params={};this.callParent(arguments)},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["contact_id","first_name","last_name","name","location_id"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"},extraParams:Ext.apply(this.params,{type:this.type})}})},setParam:function(b,a){this.store.proxy.extraParams[b]=a}});Ext.define("TMS.contacts.model.Status",{extend:"Ext.data.Model",fields:[{name:"status_id",type:"int"},{name:"status_name",type:"string"}]});Ext.define("TMS.contacts.view.FilteredGrid",{extend:"Ext.panel.Panel",requires:["TMS.contacts.filter.Contact","TMS.contacts.view.Grid"],layout:"border",height:500,title:"Contacts",initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initFilter();this.initGrid()},initFilter:function(){this.filter=Ext.create("TMS.contacts.filter.Contact",{title:"Search",region:"east",width:250,collapsible:true,collapsed:true,titleCollapse:true,split:true,floatable:false});this.items.push(this.filter)},initGrid:function(){this.grid=Ext.create("TMS.contacts.view.Grid",{region:"center",filter:this.filter});this.items.push(this.grid)}});Ext.define("TMS.contacts.view.FreeAgentsGrid",{extend:"Ext.grid.Panel",requires:["TMS.contacts.forms.sections.Claim"],processingPage:"/at-ajax/modules/contact/process/get-free-agents-records",viewConfig:{stripeRows:true},title:"Free Agents",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initColumns();this.initStore();this.initPager()},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("/contacts/?d=contacts&a=view&id={0}",a.get("contact_id"))},this)},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initColumns:function(){this.columns=[{header:"Contact Name",dataIndex:"contact_name",flex:1},{header:"Title",dataIndex:"title",flex:1},{header:"Customer",dataIndex:"customer_name",flex:1},{header:"Restriction",dataIndex:"restrictionDisplay",flex:1},{header:"Date",dataIndex:"updated_at",flex:1,xtype:"templatecolumn",tpl:"{dateDisplay}"},{header:"Claim",dataIndex:"contact_id",flex:1,xtype:"templatecolumn",tpl:'<div class="rounded5 button box-right"><a href="#" class="claim-button" id="claim-{contact_id}">Claim</a></div>'}]},initStore:function(){this.store=new Ext.data.Store({fields:["contact_id","contact_name","title","updated_at","dateDisplay","owner_name","customer_id","customer_name","restrictionDisplay"],remoteSort:true,pageSize:20,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}});this.store.on("load",function(){Ext.select(".claim-button").on("click",function(c,a){c.preventDefault();var b=a.id.split("-")[1];var d=Ext.create("TMS.contacts.forms.sections.Claim",{contact_id:b});d.on("close",function(){this.store.load()},this)},this)},this)}});Ext.define("TMS.contacts.view.Grid",{extend:"TMS.grid.Grid",processingPage:"/at-ajax/modules/contact/process/get",viewConfig:{stripeRows:true},initComponent:function(){this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.addEvents("editrecord");this.initSelectionModel();this.initColumns();this.initStore();this.initActionBar();this.initPager();this.initListeners()},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true,dock:"top"});this.dockedItems.push(this.pager)},initActionBar:function(){this.topBar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{scope:this,text:"Edit",icon:"/resources/icons/edit-24.png",scale:"medium",handler:function(){this.fireEvent("editrecord",this)}}]});this.dockedItems.push(this.topBar)},initSelectionModel:function(){this.selModel=Ext.create("Ext.selection.CheckboxModel")},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("/contacts/?d=contacts&a=view&id={0}",a.get("contact_id"))},this)},initColumns:function(){this.columns=[{header:"Name",dataIndex:"contact_name",flex:1,renderer:function(c,b,a){return Ext.String.format('<a href="/contacts/?d=contacts&a=view&id={0}">{1}</a>',a.get("contact_id"),c)}},{header:"Company",dataIndex:"customer_name",flex:1,xtype:"templatecolumn",tpl:'<a href="/customers/?d=customers&a=view&id={customer_id}">{customer_name}</a>'},{header:"Status",dataIndex:"status",flex:1},{header:"Next Action",dataIndex:"next_action_date",flex:1,xtype:"templatecolumn",tpl:'<tpl if="upToDate"><span style="color:green;">{next_action_date_display}</span></tpl><tpl if="!upToDate"><span style="color:red;">{next_action_date_display}</span></tpl>'},{header:"Owner",dataIndex:"owner_name",flex:1}]},initStore:function(){this.store=new Ext.data.Store({fields:["contact_id","contact_name","customer_id","customer_name","status","up_to_date","next_action","owner_name","next_action_date","next_action_date_display","nextActionTs","nowTs","upToDate"],remoteSort:true,pageSize:20,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.contacts.view.Interface",{extend:"Ext.tab.Panel",requires:["TMS.contacts.view.FilteredGrid","TMS.contacts.forms.Update"],layout:"border",height:500,deferredRender:true,openTabs:{},initComponent:function(){this.items=this.items||[];this.plugins=this.plugins||[];this.init();this.callParent(arguments)},init:function(){this.initFilteredGrid();this.initListeners()},initFilteredGrid:function(){this.filteredGrid=Ext.create("TMS.contacts.view.FilteredGrid");this.items.push(this.filteredGrid)},initListeners:function(){this.filteredGrid.grid.on("editrecord",function(c){var f=c.selModel.getSelection();var a=f.length;if(a){var d=false;for(var b=0;b<a;b++){if(this.openTabs[f[b].data.contact_id]){if(!d){d=this.openTabs[f[b].data.contact_id]}}else{var e=Ext.create("Ext.panel.Panel",{closable:true,title:f[b].data.contact_name,layout:"fit"});e.on("afterrender",function(g,h){g.setLoading();setTimeout(function(){g.setLoading(false);g.add(Ext.create("TMS.contacts.forms.Update",{contact_id:h.contact_id}))},100);this.openTabs[h.contact_id]=g},this,{contact_id:f[b].data.contact_id});e.on("close",function(g,h){this.openTabs[h.contact_id]=false},this,{contact_id:f[b].data.contact_id});this.add(e);if(!d){d=e}}}d.show()}},this)}});Ext.define("TMS.customer.filter.Customer",{extend:"TMS.filter.Abstract",init:function(){this.initName()},initName:function(){this.items.push({name:"name",fieldLabel:"Name"})}});Ext.define("TMS.customer.forms.sections.CustomerContacts",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect","TMS.contacts.forms.sections.ContactMethods","TMS.contacts.forms.sections.BillTo","TMS.documents.forms.sections.DocumentsRequired"],customer_id:0,layout:{type:"border",},processingPage:"/at-ajax/modules/customer/process/",title:"Customer Contacts",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initLayoutPanels();this.initContactMethods();this.initBillTo();this.initDocumentsRequired();this.initContactStore();this.initContactSelectorView();this.initListeners()},initToolbar:function(){this.toolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{scope:this,text:"Add New Contact",icon:"/resources/icons/add-16.png",handler:this.addNewContact}]});this.dockedItems.push(this.toolbar)},addNewContact:function(){var a="/contacts/?d=contacts&a=add&customer_id="+this.customer_id;window.open(a,"_blank")},initLayoutPanels:function(){this.leftPanel=Ext.create("Ext.panel.Panel",{title:"Contacts",region:"west",collapsible:true,titleCollapse:true,floatable:false,split:true,width:200,autoScroll:true});this.viewContactPageButton=Ext.create("Ext.button.Button",{scope:this,text:"View Contact Page",handler:this.viewContactPageClick,icon:"/resources/icons/preview-16.png"});this.rightPanel=Ext.create("Ext.tab.Panel",{flex:1,region:"center",tbar:[this.viewContactPageButton]});this.items.push(this.leftPanel,this.rightPanel)},viewContactPageClick:function(){var b=this.contactSelectorView.getSelectionModel().getSelection();if(b&&b.length){var a=b[0];var c="/contacts/?d=contacts&a=view&id="+a.data.contact_id;window.open(c,"_blank")}},initContactMethods:function(){this.contactMethods=Ext.create("TMS.contacts.forms.sections.ContactMethods",{title:"Contact Methods",autoSave:true});this.rightPanel.add(this.contactMethods);this.rightPanel.setActiveTab(this.contactMethods)},initBillTo:function(){this.billTo=Ext.create("TMS.contacts.forms.sections.BillTo",{title:"Bill To",autoSave:true});this.rightPanel.add(this.billTo)},initDocumentsRequired:function(){this.documentsRequired=Ext.create("TMS.documents.forms.sections.DocumentsRequired",{title:"Documents Required",autoSave:true});this.rightPanel.add(this.documentsRequired)},initContactStore:function(){this.contactStore=Ext.create("Ext.data.Store",{fields:["contact_id","first_name","last_name","owner_name"],proxy:{type:"ajax",url:this.processingPage+"get-contacts",extraParams:{customer_id:this.customer_id},reader:{type:"json",root:"records"}}});this.contactStore.on("load",this.selectFirst,this);this.on("afterrender",function(){this.contactStore.load()},this)},initContactSelectorView:function(){this.contactSelectorView=Ext.create("Ext.view.View",{title:"Contacts",store:this.contactStore,tpl:['<tpl for=".">','<div class="carrier-contact-row">{first_name} {last_name}</div>',"</tpl>",'<div class="x-clear"></div>',],trackOver:true,overItemCls:"carrier-contact-row-hover",selectedItemCls:"carrier-contact-row-selected",itemSelector:".carrier-contact-row",emptyText:"No contacts",deferEmptyText:false,listeners:{scope:this,selectionchange:function(b,a){if(a.length){this.selectRecord(a[0].index)}}}});this.leftPanel.add(this.contactSelectorView)},selectFirst:function(){if(this.contactStore.count()){this.leftPanel.doComponentLayout();this.contactSelectorView.suspendEvents();this.selectRecord(0);this.contactSelectorView.resumeEvents()}else{this.rightPanel.hide()}},selectRecord:function(c){this.contactSelectorView.select(c);var a=this.contactStore.getAt(c);var d=a.data.contact_id;var b=a.data.first_name+" "+a.data.last_name;b+=" owned by "+a.data.owner_name;this.rightPanel.setTitle(b);this.contactMethods.loadRecord(d);this.billTo.load(d);this.documentsRequired.loadContact(d)},initListeners:function(){}});Ext.define("TMS.customer.forms.sections.CustomerDuplicates",{extend:"Ext.panel.Panel",requires:["TMS.customer.lookup.Customer","TMS.customer.view.DuplicatesGrid"],customer_id:0,processingPage:"/at-ajax/modules/customer/process/",title:"Duplicate Customers",baseTitle:"Duplicate Customers",layout:"anchor",defaults:{anchor:"100%"},initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initGrid();this.initCustomerSearch();this.initListeners()},initCustomerSearch:function(){this.searchBox=Ext.create("TMS.customer.lookup.Customer",{flex:5});this.search=Ext.create("Ext.form.FieldContainer",{layout:"hbox",items:[this.searchBox,{flex:1,xtype:"button",scope:this,text:"Add",handler:function(){this.saveDuplicate()}}]})},initGrid:function(){this.grid=Ext.create("TMS.customer.view.DuplicatesGrid",{customer_id:this.customer_id});this.items.push(this.grid)},initListeners:function(){if(this.collapsed){this.collapsed=false;this.on("afterrender",function(){this.collapse()},this)}this.on("expand",function(){this.grid.doLayout();this.scrollIntoView()},this)},save:function(){},load:function(a){},saveDuplicate:function(){this.setLoading(true);Ext.Ajax.request({scope:this,url:this.processingPage+"add-duplicate",params:{customer_id:this.customer_id,duplicate_id:this.searchBox.getValue()},success:function(a){this.grid.store.load();this.searchBox.store.load();console.log(a);this.searchBox.setValue("");this.setLoading(false)}})}});Ext.define("TMS.customer.forms.sections.CustomerLocations",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox","Ext.ux.form.field.BoxSelect","TMS.location.forms.sections.Location"],customer_id:0,layout:{type:"hbox",align:"stretch"},processingPage:"/at-ajax/modules/customer/process/",locationProcessingPage:"/at-ajax/modules/location/process/",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTopBar();this.initButtons();this.initLayoutPanels();this.initLocationStore();this.initLocationSelectorView();this.initLocationEditor()},initTopBar:function(){this.topToolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top"});this.dockedItems.push(this.topToolbar)},initButtons:function(){this.topToolbar.add({scope:this,text:"Add New Location",icon:"/resources/icons/add-16.png",handler:this.addNewLocation})},initLayoutPanels:function(){this.leftPanel=Ext.create("Ext.panel.Panel",{title:"Locations",width:200,autoScroll:true});this.rightPanel=Ext.create("Ext.panel.Panel",{layout:"fit",flex:1,border:false});this.items.push(this.leftPanel,this.rightPanel)},initLocationStore:function(){this.locationStore=Ext.create("Ext.data.Store",{fields:["location_id","location_name_1","location_name_2"],proxy:{type:"ajax",url:this.processingPage+"get-locations",extraParams:{customer_id:this.customer_id},reader:{type:"json",root:"records"}}});this.locationStore.on("load",this.selectFirst,this);this.locationStore.load()},initLocationSelectorView:function(){this.locationSelectorView=Ext.create("Ext.view.View",{title:"Locations",store:this.locationStore,tpl:['<tpl for=".">','<div class="carrier-contact-row">{location_name_1} {location_name_2}</div>',"</tpl>",'<div class="x-clear"></div>'],autoHeight:true,trackOver:true,overItemCls:"carrier-contact-row-hover",selectedItemCls:"carrier-contact-row-selected",itemSelector:".carrier-contact-row",emptyText:"No Locations",deferEmptyText:false,listeners:{scope:this,selectionchange:function(b,a){if(a.length){this.selectRecord(a[0].index)}}}});this.leftPanel.add(this.locationSelectorView)},initLocationEditor:function(){this.locationEditor=Ext.create("TMS.location.forms.sections.Location",{title:"Location Information",bodyPadding:10,disabled:true,url:this.locationProcessingPage+"process",buttons:[{scope:this,text:"Save",cls:"submit",handler:function(){this.locationEditor.submit()}}]});this.locationEditor.on("success",function(b,c){var a=c.result.record;this.locationEditor.getForm().setValues(a);this.locationStore.un("load",this.selectFirst,this);this.locationStore.on("load",this.selectCurrent,this);this.locationStore.load()},this);this.locationEditor.setValues({customer_id:this.customer_id});this.rightPanel.add(this.locationEditor)},selectFirst:function(){if(this.locationStore.count()){this.leftPanel.doComponentLayout();this.locationSelectorView.suspendEvents();this.selectRecord(0);this.locationSelectorView.resumeEvents()}},selectCurrent:function(){var b=this.locationEditor.getForm().getValues()["location_id"];if(b){var a=this.locationStore.findRecord("location_id",b);if(a){this.leftPanel.doComponentLayout();this.locationSelectorView.suspendEvents();this.selectRecord(a.index);this.locationSelectorView.resumeEvents()}else{this.selectRecord(0)}}},selectRecord:function(c){this.locationSelectorView.select(c);var a=this.locationStore.getAt(c);var d=a.data.location_id;var b=a.data.location_name_1;this.locationEditor.enable();this.locationEditor.loadLocation(d);this.locationEditor.setTitle("Location Information - "+b)},addNewLocation:function(){this.locationEditor.show();this.locationEditor.enable();this.locationEditor.setTitle("New Location");this.locationEditor.getForm().reset();this.locationEditor.setValues({customer_id:this.customer_id})},saveLocationData:function(){}});Ext.define("TMS.customer.forms.Customer",{extend:"TMS.form.Navigation",requires:["Ext.ux.form.field.RealComboBox","TMS.customer.forms.sections.CustomerLocations","TMS.customer.forms.sections.CustomerDuplicates","TMS.customer.forms.sections.CustomerContacts","TMS.documents.view.Interface","TMS.comment.forms.sections.Comments","TMS.orders.view.FilteredGrid","TMS.orders.view.PreOrderFilteredGrid"],title:"Customer",url:"",customer_id:0,record:null,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initLocations();this.initDuplicates();this.initContacts();this.initDocuments();this.initComments();this.initOrders();this.initQuotes()},initTitle:function(){if(this.record!=null){this.title=this.record.customer_name}},initLocations:function(){this.locations=Ext.create("TMS.customer.forms.sections.CustomerLocations",{title:"Customer Locations",customer_id:this.customer_id});this.items.push(this.locations);this.bindForm(this.locations.locationEditor)},initDuplicates:function(){this.duplicates=Ext.create("TMS.customer.forms.sections.CustomerDuplicates",{customer_id:this.customer_id});this.items.push(this.duplicates)},initContacts:function(){this.contacts=Ext.create("TMS.customer.forms.sections.CustomerContacts",{customer_id:this.customer_id});this.items.push(this.contacts);this.bindForm(this.contacts.contactMethods);this.bindForm(this.contacts.documentsRequired);this.bindForm(this.contacts.billTo)},initDocuments:function(){this.documents=Ext.create("TMS.documents.view.Interface",{extraParams:{customer_id:this.customer_id}});this.items.push(this.documents);this.documents.on("minimize",function(){this.setActiveItem(this.documents);this.documents.doLayout()},this)},initComments:function(){this.comments=Ext.create("TMS.comment.forms.sections.Comments",{field_value:this.customer_id,type:"customer",border:false});this.items.push(this.comments)},initOrders:function(){this.orders=Ext.create("TMS.orders.view.FilteredGrid",{title:"Orders",extraFilters:{customer_id:this.customer_id},border:false});this.items.push(this.orders)},initQuotes:function(){this.quotes=Ext.create("TMS.orders.view.PreOrderFilteredGrid",{title:"Quotes",extraFilters:{customer_id:this.customer_id},border:false});this.items.push(this.quotes)}});Ext.define("TMS.customer.forms.Form",{extend:"TMS.form.Abstract",url:"/at-ajax/modules/customer/process/add",bodyPadding:10,isPayTo:false,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCustomerName();if(this.isPayTo){this.items.push({xtype:"hidden",name:"isPayTo",value:1})}},initCustomerName:function(){this.customerName=Ext.create("Ext.form.field.Text",{fieldLabel:"Company Name",anchor:"100%",name:"customerName",enableKeyEvents:true});this.customerName.on("keypress",function(b,a){if(a.keyCode==13){this.fireEvent("pressedenter")}},this);this.items.push(this.customerName)}});Ext.define("TMS.customer.lookup.Customer",{extend:"Ext.ux.form.field.RealComboBox",lastQueryValue:"",processingPage:"/at-ajax/modules/customer/lookup/customer",displayField:"customer_name",valueField:"customer_id",emptyText:"Search by name...",cls:"customer-lookup",typeAhead:false,hideTrigger:true,anchor:"100%",pageSize:10,minChars:0,width:250,listConfig:{loadingText:"Searching...",cls:"customer-lookup-list",emptyText:"No matching customers found.",getInnerTpl:function(){return'<div class="customer-name">{customer_name}</div>'}},proxyParams:{},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore();this.initListeners()},initListeners:function(){},initStore:function(){this.store=new Ext.data.Store({fields:["customer_id","customer_name"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage,extraParams:this.proxyParams,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.customer.view.DuplicatesGrid",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/customer/process/get-duplicate-records",viewConfig:{stripeRows:true},customer_id:0,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initColumns:function(){this.columns=[{header:"Duplicate Name",dataIndex:"customer_name",flex:9,renderer:function(c,b,a){return c;return Ext.String.format('<a href="/customers/?d=customers&a=view&id={0}">{1}</a>',a.get("customer_id"),c)}}]},initStore:function(){this.store=new Ext.data.Store({fields:["customer_id","customer_name"],remoteSort:true,pageSize:20,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{customer_id:this.customer_id}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){},this)},initFilters:function(){}});Ext.define("TMS.customer.view.Grid",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/customer/process/get-grid-records",viewConfig:{stripeRows:true},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initColumns:function(){this.columns=[{header:"Name",dataIndex:"customer_name",flex:5,renderer:function(c,b,a){return Ext.String.format('<a href="/customers/?d=customers&a=view&id={0}">{1}</a>',a.get("customer_id"),c)}},{header:"Locations",flex:1,dataIndex:"location_count"}]},initStore:function(){this.store=new Ext.data.Store({fields:["customer_id","customer_name","location_count"],remoteSort:true,pageSize:20,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("/customers/?d=customers&a=view&id={0}",a.get("customer_id"))},this)},initFilters:function(){this.filterPanel.add(new Ext.form.field.Text({fieldLabel:"Name"}))}});Ext.define("TMS.data.Model",{extend:"Ext.data.Model",idProperty:"",url:"",onClassExtended:function(a,b){this.init();return this.callParent(arguments)},init:function(){this.initProxy()},initProxy:function(){this.proxy={type:"ajax",api:{read:"/at-ajax/modules/league/season/read",create:"/at-ajax/modules/league/season/create",update:"/at-ajax/modules/league/season/update",destroy:"/at-ajax/modules/league/season/destroy"},reader:{idProperty:"season_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}}}});Ext.define("TMS.documents.filter.Document",{extend:"TMS.filter.Abstract",processingPage:"/at-ajax/modules/document/grid/",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initTaskTypes();this.initTaskOwners();this.initCreatedBy();this.initAssignedTo();this.initDueDateOn();this.initDueDateFrom();this.initDueDateTo()},initTaskTypes:function(){this.typeStore=Ext.create("Ext.data.Store",{fields:["task_type_id","task_name"],proxy:{type:"ajax",url:this.processingPage+"get-task-type-list",reader:{type:"json",root:"records"}}});this.typeStore.load();this.items.push({xtype:"realcombobox",queryMode:"local",name:"status",displayField:"task_name",valueField:"task_type_id",fieldLabel:"Task Type",store:this.typeStore})},initTaskOwners:function(){var a={data:[{value:"all",display:"All"},{value:"unclaimed",display:"Unclaimed"},{value:"me",display:"Me"},{value:"others",display:"Others"}]};this.taskOwnerStore=Ext.create("Ext.data.Store",{autoLoad:true,fields:["value","display"],data:a,proxy:{type:"memory",reader:{type:"json",root:"data"}}});this.items.push({xtype:"realcombobox",queryMode:"local",name:"taskOwner",displayField:"display",valueField:"value",fieldLabel:"Task Owners",store:this.taskOwnerStore})},initCreatedBy:function(){this.items.push({name:"created_by",fieldLabel:"Created By"})},initAssignedTo:function(){this.items.push({name:"assigned_to",fieldLabel:"Assigned To"})},initDueDateOn:function(){this.items.push({xtype:"datefield",name:"dueDateOn",fieldLabel:"Due Date On"})},initDueDateFrom:function(){this.items.push({xtype:"datefield",name:"dueDateFrom",fieldLabel:"Due Date From"})},initDueDateTo:function(){this.items.push({xtype:"datefield",name:"dueDateTo",fieldLabel:"Due Date To"})}});Ext.define("TMS.documents.forms.sections.DocumentsRequired",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.documents.forms.sections.DocumentsRequiredRow"],title:"Documents Required",baseTitle:"Documents Required",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/contact/process/",url:"/at-ajax/modules/contact/process/save-documents-required",contact_id:0,order_id:0,autoSave:false,readOnly:false,initComponent:function(){this.items=this.items||[];this.addEvents("dataload");this.init();this.callParent(arguments)},init:function(){this.initHidden();this.initListeners();this.initStore();if(this.contact_id){this.loadContact(this.contact_id)}if(this.order_id){this.loadData()}},initHidden:function(){this.contactIdField=Ext.create("Ext.form.field.Hidden",{name:"contact_id",value:this.contact_id});this.items.push(this.contactIdField);this.documentTypeIds=Ext.create("Ext.form.field.Hidden",{name:"document_type_ids"});this.items.push(this.documentTypeIds);this.documentTypeQuantities=Ext.create("Ext.form.field.Hidden",{name:"document_type_quantities"});this.items.push(this.documentTypeQuantities)},initListeners:function(){this.on("add",this.itemAdded,this,{buffer:500});this.on("remove",this.itemRemoved,this);this.on("beforesubmit",function(c){var e=this.getRows();var f=e.length;var b=[];var d=[];for(var a=0;a<f;a++){b.push(e[a].typeSelector.getValue());d.push(e[a].quantityField.getValue());e[a].typeSelector.name="document_type_id_"+a;e[a].quantityField.name="document_type_quantity_"+a}this.documentTypeIds.setValue(Ext.encode(b));this.documentTypeQuantities.setValue(Ext.encode(d));this.contactIdField.setValue(this.contact_id)},this)},initStore:function(){this.documentTypeStore=Ext.create("Ext.data.Store",{fields:["document_type_id","document_type_name"],proxy:{type:"ajax",extraParams:{showAll:false},url:this.processingPage+"get-document-types",reader:{type:"json",root:"records"}}});this.documentTypeStore.load()},selectFirst:function(b){var a=b.store.getAt(0);if(a){b.setValue(a.get("document_type_id"))}},getFirstUnusedIndex:function(j){var c=0;var f=[];var h=this.getRows();for(var g=0;g<h.length-1;g++){var b=h[g].items.items[0];var a=b.getValue();f.push(a)}var e=j.store.data.items;var d=e.length;for(var g=0;g<d;g++){if(f.indexOf(e[g].data.document_type_id)==-1){c=g;break}}return c},selectFirstUnused:function(b){if(b&&b.store){var a=b.store.getAt(this.getFirstUnusedIndex(b));b.setValue(a.get("document_type_id"))}},createRow:function(){var a=Ext.create("TMS.documents.forms.sections.DocumentsRequiredRow",{store:this.documentTypeStore,readOnly:this.readOnly});a.quantityField.on("keyup",function(e){if(e.getValue().length){var b=this.query("#document_type_quantity");var d=b[b.length-1];if(d.getValue().length){var c=this.createRow();this.add(c);this.selectFirstUnused(c.typeSelector)}}},this);a.quantityField.on("change",function(d){if(!d.getValue().length){var b=this.query("#document_type_quantity");var c=b[b.length-1];if(d!=c){d.ownerCt.destroy()}}this.save()},this,{buffer:500});return a},loadData:function(){if(this.documentTypeStore.isLoading()){this.documentTypeStore.on("load",function(){this.loadData()},this);return}if(this.order_id||this.contact_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-documents-required-data",params:{contact_id:this.contact_id,order_id:this.order_id},success:function(f){this.setLoading(false);var c=Ext.decode(f.responseText);var b=c.records;this.suspendEvents();this.destroyRows();this.resumeEvents();for(var e=0;e<b.length;e++){var a=this.createRow();a.on("afterrender",function(h,i){var g=h.typeSelector;var j=h.quantityField;g.setValue(i.record.document_type_id);j.setRawValue(i.record.quantity)},this,{record:b[e]});this.add(a)}if(!this.readOnly){var d=this.createRow();this.add(d);this.selectFirst(d.typeSelector)}this.fireEvent("dataload",this)}})}},loadContact:function(c,b){this.contact_id=c;var d=this.title;if(b!=null){d=this.baseTitle+" for "+b}if(this.rendered){this.setTitle(d)}else{this.title=d}if(this.documentTypeStore.isLoading()){this.documentTypeStore.on("load",function(){this.loadContact(this.contact_id)},this)}else{if(this.contact_id){this.loadData()}else{if(!this.readOnly){var a=this.createRow();this.add(a);this.selectFirst(a.typeSelector)}}}},destroyRows:function(){Ext.each(this.query("> .panel"),function(a){a.destroy()})},itemAdded:function(a,c,b){var d=this.query("> .panel");this.manageRemoveButtons(d)},itemRemoved:function(a,c,b){var d=this.query("> .panel");if(d.length){this.manageRemoveButtons(d);this.save()}},manageRemoveButtons:function(b){if(b.length){for(var a=0;a<b.length-1;a++){b[a].down(".button").enable()}b[b.length-1].down(".button").disable()}},getRows:function(){return this.query("> .panel")},save:function(){if(this.contact_id&&this.autoSave){this.submit()}}});Ext.define("TMS.documents.forms.sections.DocumentsRequiredRow",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox"],autoHeight:true,layout:"hbox",border:false,defaults:{border:false},readOnly:false,initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initTypeSelector();this.initQuantityField();this.initButton();this.initListeners()},initTypeSelector:function(){var a={};if(this.readOnly){Ext.apply(a,{readOnly:true})}this.typeSelector=Ext.create("Ext.ux.form.field.RealComboBox",Ext.apply({flex:1,valueField:"document_type_id",displayField:"document_type_name",store:this.store,queryMode:"local",editable:false,margin:"2"},a));this.items.push(this.typeSelector)},initQuantityField:function(){var a={};if(this.readOnly){Ext.apply(a,{readOnly:true})}this.quantityField=Ext.create("Ext.form.field.Text",Ext.apply({flex:1,margin:"2",itemId:"document_type_quantity",enableKeyEvents:true,emptyText:"Quantity"},a));this.items.push(this.quantityField)},initButton:function(){var a={};if(this.readOnly){Ext.apply(a,{hidden:true})}this.button=Ext.create("Ext.button.Button",Ext.apply({margin:"2",icon:"/resources/icons/delete-16.png",width:24,scope:this,handler:function(b){b.ownerCt.destroy()}},a));this.items.push(this.button)},initListeners:function(){}});Ext.define("TMS.documents.forms.ScannerImport",{extend:"TMS.form.Abstract",url:"/at-ajax/modules/document/process/import-documents",initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initScannerStore();this.initScannerSelect();this.initButtons();this.initListeners()},initScannerStore:function(){this.scannerStore=Ext.create("Ext.data.Store",{fields:["scannerName","scannerDisplay"],proxy:{type:"ajax",url:"/at-ajax/modules/document/process/get-scanner-list",reader:{type:"json",root:"records"}}});this.scannerStore.load()},initScannerSelect:function(){this.scannerSelector=Ext.create("Ext.form.field.ComboBox",{fieldLabel:"Scanner",name:"scannerName",store:this.scannerStore,triggerAction:"all",queryMode:"local",valueField:"scannerName",displayField:"scannerDisplay",editable:false});this.items.push(this.scannerSelector)},initButtons:function(){this.buttons=[{scope:this,text:"Import 10",scale:"medium",icon:"/resources/icons/download-24.png",handler:function(){this.submitParams.limit=10;this.submit()}},{scope:this,text:"Import 20",scale:"medium",icon:"/resources/icons/download-24.png",handler:function(){this.submitParams.limit=20;this.submit()}},{scope:this,text:"Import All",scale:"medium",icon:"/resources/icons/download-24.png",handler:function(){this.submitParams.limit=-1;this.submit()}}]},initListeners:function(){this.on("beforesubmit",function(){this.setLoading()},this);this.on("submit",function(){this.setLoading(false)},this)}});Ext.define("TMS.documents.view.Grid",{extend:"Ext.grid.Panel",requires:["TMS.documents.forms.ScannerImport","TMS.ActionWindow","TMS.IframeWindow"],processingPage:"/at-ajax/modules/document/process/",viewConfig:{stripeRows:true},baseTitle:"Documents",extraParams:false,initComponent:function(){this.extraParams=this.extraParams||{};this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initPlugins();this.initTopBar();this.initDocumentTypeStore();this.initRelationTypeStore();this.initColumns();this.initStore();this.initUploader();if(this.extraParams!==false){this.initImportButton()}this.initPager();this.initListeners()},setExtraParams:function(a){Ext.apply(this.extraParams,a);this.store.proxy.extraParams.filter=Ext.encode(this.extraParams);this.initUploader()},initPlugins:function(){this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.plugins=[this.cellEditing]},initTopBar:function(){this.topBar=Ext.create("Ext.toolbar.Toolbar",{dock:"top"});this.dockedItems.push(this.topBar)},initDocumentTypeStore:function(){this.documentTypeStore=Ext.create("Ext.data.Store",{fields:["document_type_id","document_type_name"],proxy:{type:"ajax",url:"/at-ajax/modules/contact/process/get-document-types",reader:{type:"json",root:"records"}}});this.documentTypeStore.load()},initRelationTypeStore:function(){this.relationTypeStore=Ext.create("Ext.data.Store",{fields:["relation_table_name","relation_table_display"],proxy:{type:"ajax",url:"/at-ajax/modules/document/process/get-relation-types",reader:{type:"json",root:"records"}}});this.relationTypeStore.load()},initColumns:function(){this.columns=[{header:"ID",dataIndex:"document_id",hidden:true},{header:"Document Type",dataIndex:"document_type_name",sortable:false,field:{xtype:"combobox",triggerAction:"all",selectOnTab:true,queryMode:"local",store:this.documentTypeStore,valueField:"document_type_name",displayField:"document_type_name",editable:false}},{header:"Description",dataIndex:"description",sortable:false,flex:1,field:{type:"textarea"}},{header:"File Type",dataIndex:"file_type",sortable:false,hidden:true},{header:"Relation",width:90,dataIndex:"relation_table_display",sortable:false,field:{xtype:"combobox",triggerAction:"all",selectOnTab:true,queryMode:"local",store:this.relationTypeStore,valueField:"relation_table_display",displayField:"relation_table_display",editable:false,triggerAction:"all"}},{header:"Relation ID",width:60,dataIndex:"relation_table_key",sortable:false,field:{type:"textarea"}},{header:"Created",dataIndex:"created_at",renderer:function(b){var a=new Date(b*1000);return Ext.Date.format(a,"n/j/Y")}},{header:"",sortable:false,dataIndex:"downloadUrl",width:70,xtype:"templatecolumn",tpl:'<a href="{downloadUrl}"><img src="/resources/icons/download-16.png" alt="Download" title="Download" /></a>&nbsp;&nbsp;<a href="{downloadUrl}" class="preview-link"><img src="/resources/icons/preview-16.png" alt="Preview" title="Preview" id="preview-{document_id}" /></a>'}]},initStore:function(){this.store=new Ext.data.Store({fields:["document_id","file_type","description","document_type_name","relation_table_display","relation_table_name","relation_table_key","created_at","downloadUrl"],pageSize:25,remoteSort:true,proxy:{type:"ajax",url:this.processingPage+"get-grid-records",reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{filter:Ext.encode(this.extraParams)}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true,dock:"top"});this.dockedItems.push(this.pager)},initUploader:function(){if(this.uploader){this.uploader.destroy()}var b=false;for(var a in this.extraParams){b=true;break}if(!b){return false}this.uploader=Ext.create("Ext.ux.Uploader",{url:this.processingPage+"upload-file",autoUpload:true,useSmallDisplay:true,extraParams:this.extraParams,scale:"medium",icon:"/resources/icons/upload-24.png",border:false,config:{filters:[{title:"PDFs",extensions:"pdf"},{title:"TIFs",extensions:"tif"},{title:"Zip files",extensions:"zip"}]}});this.uploader.on("uploadcomplete",function(){this.store.load()},this);this.topBar.add(this.uploader)},initImportButton:function(){this.importButton=Ext.create("Ext.button.Button",{text:"Import",scale:"medium",icon:"/resources/icons/download-24.png",scope:this,handler:function(){var a=Ext.create("TMS.documents.forms.ScannerImport",{});this.actionWindow=Ext.create("TMS.ActionWindow",{title:"Import From Scanners",items:[a]});a.on("submit",function(){this.actionWindow.destroy()},this)}});this.topBar.add(this.importButton)},initListeners:function(){this.cellEditing.on("edit",function(b,c,a){if(c.record.dirty){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"update-record",params:{field:c.field,value:c.record.data[c.field],documentId:c.record.data.document_id},success:function(e){var d=Ext.decode(e.responseText);c.record.commit()}})}},this);if(this.collapsed){this.on("expand",function(){if(!this.store.getTotalCount()){this.store.load()}},this)}else{this.store.load()}this.on("expand",function(){this.setHeight(null);this.pager.doLayout();this.scrollIntoView()},this);this.on("itemclick",function(b,a,e,d,f,c){if(f.getTarget(".preview-link")){Ext.create("TMS.IframeWindow",{title:"Document Preview",url:a.data.downloadUrl,widthPercent:0.9,heightPercent:0.9})}},this);this.on("afterrender",function(){this.store.on("load",function(){var a=this.getEl().select(".preview-link");var c=a.elements.length;for(var b=0;b<c;b++){Ext.get(a.elements[b]).on("click",function(h,f){h.preventDefault();var g=f.id.split("-");var d=g[g.length-1]},this)}},this)},this);setInterval(Ext.bind(function(){},this),1000)}});Ext.define("TMS.documents.view.Interface",{extend:"Ext.panel.Panel",requires:["TMS.panel.plugin.FullScreen","TMS.documents.view.Grid","TMS.panel.plugin.FullScreen","TMS.documents.view.Grid"],layout:"border",title:"Documents",extraFilters:{},extraParams:{},lastRecordId:false,initComponent:function(){this.items=this.items||[];this.plugins=this.plugins||[];this.addEvents("maximize","minimize");this.init();this.callParent(arguments)},init:function(){this.initTools();this.initGrid();this.initDocumentPreview()},initTools:function(){this.tools=[{itemId:"plus",type:"plus",scope:this,handler:function(){this.onMaximize()}},{itemId:"minus",type:"minus",scope:this,hidden:true,handler:function(){this.onMinimize()}}];this.fullScreenPlugin=Ext.create("TMS.panel.plugin.FullScreen");this.plugins.push(this.fullScreenPlugin)},initGrid:function(){this.gridPanel=Ext.create("TMS.documents.view.Grid",{region:"center",border:false,filter:this.filterPanel,extraParams:this.extraParams});this.gridPanel.on("itemclick",function(b,a){if(a.data.document_id!=this.lastRecordId){this.lastRecordId=a.data.document_id;this.iframe.dom.src=a.data.downloadUrl}},this);this.items.push(this.gridPanel)},initDocumentPreview:function(){this.documentPreview=Ext.create("Ext.panel.Panel",{title:"Document Preview",region:"east",width:250,html:"<iframe></iframe>"});this.documentPreview.on("afterrender",function(){this.iframe=this.documentPreview.getEl().down("iframe");this.iframe.set({width:"100%",height:"100%",frameborder:0})},this);this.items.push(this.documentPreview)},onMaximize:function(){this.query("#plus")[0].hide();this.query("#minus")[0].show();this.fullScreenPlugin.maximize(this);this.fireEvent("maximize",this)},onMinimize:function(){this.query("#minus")[0].hide();this.query("#plus")[0].show();this.fullScreenPlugin.minimize(this);this.fireEvent("minimize",this)}});Ext.define("TMS.edi.form.Respond",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.edi.model.Log"],url:"/at-ajax/modules/contact/process/",initComponent:function(){this.items=[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initContentField();TMS.edi.model.Log.load(3,{scope:this,success:function(a,b){this.loadRecord(a)}})},initContentField:function(){console.log(this.items);this.content=new Ext.form.field.TextArea({name:"content"});this.items.push(this.content)}});Ext.define("TMS.edi.model.Log",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"int"},{name:"type",type:"int"},{name:"pre_order_id",type:"int"},{name:"customer_id",type:"int"},{name:"broker_id",type:"int"},{name:"status",type:"int"},{name:"responded_at",type:"date"},{name:"comments",type:"string"},{name:"created_at",type:"date"},{name:"content",type:"string"},{name:"description",type:"string"}],proxy:{type:"ajax",api:{read:"/at-ajax/modules/edi/log/read",create:"/at-ajax/modules/edi/log/create",update:"/at-ajax/modules/edi/log/update",destroy:"/at-ajax/modules/edi/log/destroy"},reader:{idProperty:"id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}}});Ext.define("TMS.form.plugin.Help",{extend:"Ext.util.Observable",field:null,message:"",constructor:function(b,a){this.message=b;this.callParent([a])},init:function(a){this.field=a;if(!Ext.ComponentQuery.is(this.field,"field")){return}if(!this.field.rendered){a.on("afterrender",this.onAfterRender,this)}else{this.onAfterRender()}},initLabel:function(){this.field.labelEl.set({style:{cursor:"help"}})},initTip:function(){this.tip=Ext.create("Ext.tip.ToolTip",{scope:this,target:this.field.labelEl,anchor:"top",autoHide:true,html:this.message,listeners:{beforeshow:Ext.bind(function(){},this)}})},onAfterRender:function(){var a=this.field.labelEl;if(a==null){return}this.initLabel();this.initTip()}});Ext.define("TMS.form.plugin.StatusBar",{extend:"Ext.util.Observable",form:null,dockTo:null,redirect:true,redirectTimeout:2000,constructor:function(){this.callParent(arguments);this.addEvents("showerror")},init:function(a){this.form=a;if(!Ext.ComponentQuery.is(this.form,"tmsform")){return}this.initListeners();this.initStatusBar()},initListeners:function(){this.form.on("beforesubmit",this.onBeforeSubmit,this);this.form.on("submit",this.onSubmit,this);this.form.on("cancelsubmit",this.onCancelSubmit,this);this.form.on("failure",function(b,a){this.onFailure(a.result)},this);this.form.on("success",function(b,a){this.onSuccess(a.result)},this)},initStatusBar:function(){this.statusBar=Ext.create("Ext.ux.statusbar.StatusBar",{scope:this,docked:"bottom",dock:"bottom",items:this.items||[]});this.statusBar.on("afterrender",function(){this.statusTip=Ext.create("Ext.tip.ToolTip",{scope:this,target:this.statusBar.getEl(),anchor:"top",autoHide:false,hasContent:false,listeners:{beforeshow:Ext.bind(function(){if(!this.statusTip.hasContent){return false}},this)}});this.statusTip.on("afterrender",function(){this.statusTip.getEl().on("click",function(c,b){var a=c.getTarget("li");if(a==null){return}var e=Ext.get(a).getAttribute("field");var d=this.form.getForm().findField(e);this.fireEvent("showerror",e);this.statusTip.hide()},this)},this)},this);if(this.dockTo){this.dockTo.addDocked(this.statusBar)}else{this.form.addDocked(this.statusBar)}},setStatus:function(a){this.statusBar.clearStatus();this.statusBar.setStatus(a);if(a.tooltip!=null){this.statusTip.update(a.tooltip);this.statusTip.hasContent=true;this.statusTip.show()}else{this.statusTip.hasContent=false;this.statusTip.update("")}},onBeforeSubmit:function(){this.statusBar.showBusy("Saving...")},onSubmit:function(){if(!this.form.getForm().isValid()){var a='<div class="form-errors"><ul>';this.form.getForm().getFields().each(function(b){var c=b.getErrors()[0];if(c){a+='<li field="'+b.name+'">'+b.name+" - "+c+"</li>"}},this);a+="</div>";this.setStatus({text:"There are errors in your form.",iconCls:"warning-icon-16",tooltip:a})}},onCancelSubmit:function(){this.setStatus({text:""})},onSuccess:function(a){this.setStatus({text:a.msgStr,iconCls:"check-icon-16"});if(this.redirect&&a.redirect.length){setTimeout(Ext.bind(function(){location.href=a.redirect},this),this.redirectTimeout)}else{setTimeout(Ext.bind(function(){this.statusBar.clearStatus()},this),4000)}},onFailure:function(a){this.setStatus({text:"There was an error submitting the form.",iconCls:"warning-icon-16",tooltip:a.errorStr})}});Ext.define("TMS.form.Submission",{extend:"Ext.util.Observable",processingPage:"/at-ajax/modules/task/process/",redirect:true,removeSubmit:true,timeoutSeconds:30,callback:function(){},scrollToMessage:false,autoSubmit:true,extraParams:{},invalidCls:"form-invalid",constructor:function(b,a){Ext.apply(this,a);this.form=Ext.get(b);this.addEvents("success","failure","complete");this.submitButton=this.form.down("input[type=submit]");if(this.autoSubmit){this.submit()}return this},submit:function(){this.submitButton.focus();this.messageDiv=this.form.down(".message");this.form.select("."+this.invalidCls).removeCls(this.invalidCls);if(this.messageDiv==null){this.messageDiv=Ext.get(document.createElement("div")).appendTo(this.submitButton.parent()).addCls("message")}this.messageDiv.dom.innerHTML='<span class="loadingSpinner"></span><span class="messageText">Submitting...</span>';this.messageText=this.messageDiv.down(".messageText");this.statusTimeout=setTimeout(Ext.Function.bind(function(){this.messageText.dom.innerHTML+="Still working..."},this),10000);this.unlockTimeout=setTimeout(Ext.Function.bind(function(){this.messageDiv.dom.innerHTML="There was a problem processing your request. Please wait a few minutes and try submitting again.";if(this.request.abort){this.request.abort()}this.enableForm()},this),this.timeoutSeconds*1000);this.request=Ext.Ajax.request({form:this.form,params:Ext.urlEncode(this.extraParams),success:this.complete,scope:this});this.disableForm()},complete:function(d){var a=Ext.decode(d.responseText);this.submitButton.focus();this.messageDiv.removeCls("form-errors");this.messageDiv.removeCls("form-messages");if(a.success){this.messageDiv.addCls("form-messages");this.messageDiv.update(a.msg);this.fireEvent("success",this,a);if(this.removeSubmit){this.form.select("input[type=submit]").remove()}if(a.redirect&&this.redirect){location.href=a.redirect}}else{this.messageDiv.addCls("form-errors");var e;var f="<ul>";for(var b in a.errors){f+="<li>"+a.errors[b]+"</li>";if(this.form.dom[b]){e=Ext.get(this.form.dom[b]);if(e){e.addCls(this.invalidCls)}}}f+="</ul>";this.fireEvent("failure",this,a);this.messageDiv.dom.innerHTML=f}this.fireEvent("complete",this,a);if(this.scrollToMessage){Ext.get(this.messageDiv).scrollIntoView();Ext.get(this.messageDiv).frame()}else{var c=Ext.get(Ext.core.DomHelper.append(this.messageDiv,{tag:"input",type:"text"}));c.focus();c.remove()}this.enableForm();clearTimeout(this.statusTimeout);clearTimeout(this.unlockTimeout)},enableForm:function(){this.form.select(TMS.form.itemTypes).each(function(a){a.dom.disabled=false})},disableForm:function(){this.form.select(TMS.form.itemTypes).each(function(a){a.dom.disabled=true})}});Ext.ns("TMS.form");TMS.form.itemTypes="input,button,select,textarea";TMS.form.focus=function(b){var a=Ext.get(b);if(a){a.focus();a.frame()}};TMS.form.enable=function(a){Ext.get(a).select(TMS.form.itemTypes).each(function(b){b.dom.disabled=false})};TMS.form.disable=function(a){Ext.get(a).select(TMS.form.itemTypes).each(function(b){b.dom.disabled=true})};Ext.define("TMS.league.form.Game",{extend:"Ext.form.Panel",requires:["TMS.league.store.Team","TMS.league.model.Game"],bodyPadding:10,showFooter:true,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initStore();this.initHomeTeam();this.initAwayTeam();this.initHidden();this.initFooter()},initStore:function(){this.store=Ext.create("TMS.league.store.Team")},initHomeTeam:function(){this.homeTeam=new Ext.form.ComboBox({name:"home_team_id",fieldLabel:"Home Team",store:this.store,queryMode:"local",displayField:"team_name",valueField:"league_team_id"});this.store.on("load",function(){this.homeTeam.setValue(this.homeTeam.getValue())},this);this.items.push(this.homeTeam)},initAwayTeam:function(){this.awayTeam=new Ext.form.ComboBox({name:"away_team_id",fieldLabel:"Away Team",store:this.store,queryMode:"local",displayField:"team_name",valueField:"league_team_id"});this.store.on("load",function(){this.awayTeam.setValue(this.awayTeam.getValue())},this);this.items.push(this.awayTeam)},initHidden:function(){this.gameId=Ext.create("Ext.form.field.Hidden",{name:"game_id"});this.items.push(this.gameId)},initFooter:function(){if(!this.showFooter){return false}this.footer=new Ext.toolbar.Toolbar({dock:"bottom",ui:"footer",items:["->",{scope:this,itemId:"save",text:"Save",formBind:true,handler:this.save}]});this.dockedItems.push(this.footer)},save:function(){var b=this.getForm();var a=b.getRecord();if(!b.isValid()){return}if(!a){a=Ext.create("TMS.league.model.Game",b.getValues());this.setLoading("Saving...");a.save({scope:this,callback:function(c){this.setLoading(false);this.fireEvent("create",this,c)}})}else{this.setLoading("Saving...");b.updateRecord(a);a.save({scope:this,callback:function(c){this.setLoading(false);this.fireEvent("update",this,c)}})}},cancel:function(){this.fireEvent("cancel",this)}});Ext.define("TMS.league.form.Season",{extend:"Ext.form.Panel",requires:["TMS.league.model.Season"],bodyPadding:10,showFooter:true,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initStartDate();this.initEndDate();this.initHidden();this.initFooter()},initTitle:function(){this.titleField=new Ext.form.field.Text({scope:this,name:"title",fieldLabel:"Title",allowBlank:false});this.items.push(this.titleField)},initStartDate:function(){this.startDate=new Ext.form.field.Date({scope:this,name:"start_date",fieldLabel:"Start Date",allowBlank:false});this.items.push(this.startDate)},initEndDate:function(){this.endDate=new Ext.form.field.Date({scope:this,name:"end_date",fieldLabel:"End Date",allowBlank:false});this.items.push(this.endDate)},initHidden:function(){this.seasonId=Ext.create("Ext.form.field.Hidden",{name:"season_id"});this.items.push(this.seasonId)},initFooter:function(){if(!this.showFooter){return false}this.footer=new Ext.toolbar.Toolbar({dock:"bottom",ui:"footer",items:["->",{scope:this,itemId:"save",text:"Save",formBind:true,handler:this.save},{text:"Cancel",scope:this,handler:this.cancel}]});this.dockedItems.push(this.footer)},save:function(){var b=this.getForm();var a=b.getRecord();if(!b.isValid()){return}if(!a){a=Ext.create("TMS.league.model.Season",b.getValues());this.setLoading("Saving...");a.save({scope:this,callback:function(c){this.setLoading(false);this.fireEvent("create",this,c)}})}else{b.updateRecord(a);this.fireEvent("update",this,a)}},cancel:function(){this.fireEvent("cancel",this)}});Ext.define("TMS.league.form.Week",{extend:"Ext.form.Panel",bodyPadding:10,showFooter:true,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initStartDate();this.initEndDate();this.initHidden();this.initFooter()},initTitle:function(){this.titleField=new Ext.form.field.Text({scope:this,name:"title",fieldLabel:"Title",allowBlank:false});this.items.push(this.titleField)},initStartDate:function(){this.startDate=new Ext.form.field.Date({scope:this,name:"start_date",fieldLabel:"Start Date",allowBlank:false});this.items.push(this.startDate)},initEndDate:function(){this.endDate=new Ext.form.field.Date({scope:this,name:"end_date",fieldLabel:"End Date",allowBlank:false});this.items.push(this.endDate)},initHidden:function(){this.weekId=Ext.create("Ext.form.field.Hidden",{name:"week_id"});this.items.push(this.weekId)},initFooter:function(){if(!this.showFooter){return false}this.footer=new Ext.toolbar.Toolbar({dock:"bottom",ui:"footer",items:["->",{scope:this,itemId:"save",text:"Save",formBind:true,handler:this.save}]});this.dockedItems.push(this.footer)},save:function(){var b=this.getForm();var a=b.getRecord();if(!b.isValid()){return}if(!a){this.fireEvent("create",this,b.getValues())}else{b.updateRecord(a);this.fireEvent("update",this,a)}},cancel:function(){this.fireEvent("cancel",this)}});Ext.define("TMS.league.grid.Season",{extend:"TMS.grid.Grid",requires:["TMS.league.store.Season"],initComponent:function(){this.dockedItems=this.dockedItems||[];this.plugins=this.plugins||[];this.init();this.callParent(arguments)},init:function(){this.initEditing();this.initToolbar();this.initColumns();this.initStore();this.initPager()},initEditing:function(){this.editing=Ext.create("Ext.grid.plugin.CellEditing");this.plugins.push(this.editing)},initToolbar:function(){this.toolbar=new Ext.panel.Panel();this.tbar=this.toolbar},initColumns:function(){this.columns=[{xtype:"actioncolumn",width:50,items:[{scope:this,icon:"/resources/icons/edit-16.png",tooltip:"Edit",handler:function(c,d,b){var a=c.getStore().getAt(d);this.fireEvent("editaction",this,a)}},{scope:this,icon:"/resources/icons/delete-16.png",tooltip:"Delete",handler:function(c,d,b){var a=c.getStore().getAt(d);this.deleteRecord(a)}}]},{header:"Title",dataIndex:"title",flex:1,field:{type:"textfield"}},{header:"Start Date",dataIndex:"start_date",flex:1},{header:"End Date",dataIndex:"end_date",flex:1}]},initStore:function(){if(this.store!=null){return false}this.store=Ext.create("TMS.league.store.Season")},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.toolbar.add(this.pager)},deleteRecord:function(a){this.fireEvent("delete",this,a);this.store.remove(a);a.destroy()}});Ext.define("TMS.league.grid.Standings",{extend:"TMS.grid.Grid",processingPage:"/at-ajax/modules/league/season/standings",viewConfig:{stripeRows:true},initComponent:function(){this.dockedItems=this.dockedItems||[];this.plugins=this.plugins||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initColumns();this.initStore()},initToolbar:function(){this.toolbar=new Ext.panel.Panel();this.tbar=this.toolbar},initColumns:function(){this.columns=[{header:"Rank",dataIndex:"rank",width:40},{dataIndex:"team_pic",width:75,renderer:function(a){return'<img src="'+a+'" width="50" />'}},{header:"Team",dataIndex:"team_name",flex:1,renderer:function(c,b,a){return Ext.String.format('<a href="/mypage/?section=teams&id={0}">{1}</a>',a.get("league_team_id"),c)}},{header:"W",dataIndex:"wins",width:40,renderer:function(a){return'<span style="color: green">'+a+"</span>"}},{header:"L",dataIndex:"losses",width:40,renderer:function(a){return'<span style="color: red">'+a+"</span>"}},{header:"Points",dataIndex:"points"}]},initStore:function(){this.store=new Ext.data.Store({fields:["league_team_id","team_name","team_pic","wins","losses","rank","points"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}});this.on("afterrender",function(){this.store.load()},this)}});Ext.define("TMS.league.model.Game",{extend:"Ext.data.Model",idProperty:"game_id",fields:[{name:"game_id",type:"int"},{name:"week_id",type:"int"},{name:"home_team_id",type:"int"},{name:"away_team_id",type:"int"},{name:"winning_team_id",type:"int"},{name:"losing_team_id",type:"int"},{name:"home_team_name",type:"string"},{name:"away_team_name",type:"string"},{name:"home_team_pic",type:"string"},{name:"away_team_pic",type:"string"},{name:"home_team_record"},{name:"away_team_record"},{name:"home_score",type:"int"},{name:"away_score",type:"int"}],proxy:{type:"ajax",api:{read:"/at-ajax/modules/league/game/read",create:"/at-ajax/modules/league/game/create",update:"/at-ajax/modules/league/game/update",destroy:"/at-ajax/modules/league/game/destroy"},reader:{idProperty:"game_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}}});Ext.define("TMS.league.model.Season",{extend:"Ext.data.Model",idProperty:"season_id",requires:["TMS.league.model.Week"],fields:[{name:"season_id",type:"int"},{name:"title",type:"string"},{name:"start_date",type:"date"},{name:"end_date",type:"date"}],proxy:{type:"ajax",api:{read:"/at-ajax/modules/league/season/read",create:"/at-ajax/modules/league/season/create",update:"/at-ajax/modules/league/season/update",destroy:"/at-ajax/modules/league/season/destroy"},reader:{idProperty:"season_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}},hasMany:{model:"TMS.league.model.Week",name:"weeks",primaryKey:"season_id",associationKey:"season_id",foreignKey:"season_id"}});Ext.define("TMS.league.model.Team",{extend:"Ext.data.Model",idProperty:"league_team_id",requires:["TMS.league.model.Game"],fields:[{name:"league_team_id",type:"int"},{name:"team_name",type:"string"},{name:"team_pic",type:"string"},{name:"team_music",type:"string"},{name:"team_video",type:"string"},{name:"captain_id",type:"int"}],proxy:{type:"ajax",startParam:undefined,limitParam:undefined,api:{read:"/at-ajax/modules/league/team/read",create:"/at-ajax/modules/league/team/create",update:"/at-ajax/modules/league/team/update",destroy:"/at-ajax/modules/league/team/destroy"},reader:{idProperty:"league_team_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}}});Ext.define("TMS.league.model.Week",{extend:"Ext.data.Model",idProperty:"week_id",requires:["TMS.league.model.Game"],fields:[{name:"week_id",type:"int"},{name:"season_id",type:"int"},{name:"title",type:"string"},{name:"start_date",type:"date"},{name:"end_date",type:"date"}],proxy:{type:"ajax",startParam:undefined,limitParam:undefined,api:{read:"/at-ajax/modules/league/week/read",create:"/at-ajax/modules/league/week/create",update:"/at-ajax/modules/league/week/update",destroy:"/at-ajax/modules/league/week/destroy"},reader:{idProperty:"week_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}},hasMany:[{model:"TMS.league.model.Game",name:"games",primaryKey:"week_id",associationKey:"week_id",foreignKey:"week_id"}],belongsTo:"TMS.league.model.Season",isActive:function(){var b=new Date();var a=new Date(this.get("start_date"));var c=new Date(this.get("end_date"));if(b>=a&&b<=c){return true}else{return false}}});Ext.define("TMS.league.store.Season",{extend:"Ext.data.Store",requires:["TMS.league.model.Season"],model:"TMS.league.model.Season",autoLoad:true,autoSync:true,remoteSort:true,pageSize:10});Ext.define("TMS.league.store.Team",{extend:"Ext.data.Store",requires:["TMS.league.model.Team"],model:"TMS.league.model.Team",autoLoad:true,autoSync:true,remoteSort:true});Ext.define("TMS.league.view.Game",{extend:"Ext.view.View",autoScroll:true,multiSelect:false,trackOver:true,deferEmptyText:false,overItemCls:"league-game-over",itemSelector:".league-game",emptyText:"No games...",initComponent:function(){this.items=[];this.dockedItems=[];this.init();return this.callParent(arguments)},init:function(){this.initTemplate()},initTemplate:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="league-game-container">','<div class="league-game">','<div class="team home-team">','<div class="image"><img src="{home_team_pic}" /></div>','<div class="name">{[this.getTeamName(values.home_team_name)]}</div>','<div class="score">{home_score}</div>','<div class="clear"></div>',"</div>",'<div class="team away-team">','<div class="image"><img src="{away_team_pic}" /></div>','<div class="name">{[this.getTeamName(values.away_team_name)]}</div>','<div class="score">{away_score}</div>','<div class="clear"></div>',"</div>",'<div class="game-footer">',"Click to view game details","</div>","</div>","</div>","</tpl>",'<div class="clear"></div>',{getTeamName:function(a){if(!a.length){return"Bye"}return a}})}});Ext.define("TMS.league.view.League",{extend:"Ext.panel.Panel",requires:["TMS.league.store.Season","TMS.league.grid.Season","TMS.league.form.Season","TMS.league.view.Schedule"],layout:"border",initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initCenter();this.initTabPanel();this.initSeasonStore();this.initSeasonGrid();this.initSeasonForm();this.initSchedule()},initCenter:function(){this.center=new Ext.panel.Panel({scope:this,region:"center",layout:"card"});this.items.push(this.center)},initTabPanel:function(){this.tabPanel=new Ext.tab.Panel({scope:this,activeTab:0});this.center.add(this.tabPanel)},initSeasonStore:function(){this.seasonStore=Ext.create("TMS.league.store.Season")},initSeasonGrid:function(){this.seasonGrid=Ext.create("TMS.league.grid.Season",{scope:this,store:this.seasonStore});this.center.add(this.seasonGrid);this.setActiveItem(this.seasonGrid);this.seasonGrid.toolbar.add(0,new Ext.toolbar.Toolbar({scope:this,items:[{scope:this,text:"Add",handler:function(){this.setActiveItem(this.tabPanel);this.tabPanel.setActiveTab(this.seasonForm)}}]}));this.seasonGrid.on("editaction",function(b,a){this.editSeason(a)},this)},initSeasonForm:function(){this.seasonForm=Ext.create("TMS.league.form.Season",{scope:this,title:"Details"});this.tabPanel.add(this.seasonForm);this.seasonForm.on("create",this.addSeason,this);this.seasonForm.on("update",this.updateSeason,this)},initSchedule:function(){this.schedule=Ext.create("TMS.league.view.Schedule",{scope:this,title:"Schedule",disabled:true});this.tabPanel.add(this.schedule)},setActiveItem:function(a){if(this.center.rendered){this.center.getLayout().setActiveItem(a)}else{this.center.activeItem=a}},getActiveItem:function(a){return this.center.getLayout().getActiveItem()},addSeason:function(b,a){this.seasonStore.add(a);this.setActiveItem(this.seasonGrid)},updateSeason:function(b,a){},editSeason:function(a){this.seasonForm.loadRecord(a);this.setActiveItem(this.tabPanel);this.tabPanel.setActiveTab(this.seasonForm);this.loadSchedule(a)},loadSchedule:function(a){this.schedule.enable();this.schedule.loadSeason(a)},save:function(){this.seasonForm.save()}});Ext.define("TMS.league.view.Schedule",{extend:"Ext.panel.Panel",requires:["TMS.league.view.Week","TMS.league.view.Game","TMS.league.form.Week","TMS.league.form.Game"],layout:"border",initComponent:function(){this.items=[];this.dockedItems=[];this.init();return this.callParent(arguments)},init:function(){this.initCenter();this.initWest();this.initWeekView();this.initGameView()},initCenter:function(){this.center=new Ext.panel.Panel({scope:this,title:"Games",region:"center",layout:"fit"});this.items.push(this.center)},initWest:function(){this.west=new Ext.panel.Panel({scope:this,title:"Weeks",region:"west",width:250,autoScroll:true});this.items.push(this.west)},initWeekView:function(){this.weekView=Ext.create("TMS.league.view.Week",{scope:this});this.west.add(this.weekView);this.weekView.on("selectionchange",function(b,c,d){if(!c.length){return}var a=c[0];this.gameView.bindStore(a.games());a.games().load()},this);this.weekView.on("itemcontextmenu",function(b,a,f,d,e,c){e.preventDefault();e.stopPropagation();e.stopEvent();var g=new Ext.menu.Menu({scope:this,items:[{scope:this,text:"Edit",record:a,handler:function(h){this.editWeek(h.record)}}]});g.showAt(e.getXY())},this)},initGameView:function(){this.gameView=Ext.create("TMS.league.view.Game",{scope:this});this.center.add(this.gameView);this.gameView.on("itemcontextmenu",function(b,a,f,d,e,c){e.preventDefault();e.stopPropagation();e.stopEvent();var g=new Ext.menu.Menu({scope:this,items:[{scope:this,text:"Edit",record:a,handler:function(h){this.editGame(h.record)}}]});g.showAt(e.getXY())},this)},loadSeason:function(a){this.weekView.bindStore(a.weeks());a.weeks().load()},editWeek:function(a){if(this.weekForm==null){this.weekForm=Ext.create("TMS.league.form.Week");this.weekWindow=new Ext.window.Window({scope:this,title:"",items:[this.weekForm],closeAction:"hide",modal:true})}this.weekWindow.setTitle(a.get("title"));this.weekForm.loadRecord(a);this.weekWindow.show()},editGame:function(a){if(this.gameForm==null){this.gameForm=Ext.create("TMS.league.form.Game");this.gameWindow=new Ext.window.Window({scope:this,title:"",items:[this.gameForm],closeAction:"hide",modal:true})}this.gameForm.loadRecord(a);this.gameWindow.show()}});Ext.define("TMS.league.view.Team",{extend:"Ext.view.View",requires:["TMS.league.store.Team"],autoScroll:true,multiSelect:false,trackOver:true,deferEmptyText:false,overItemCls:"league-team-over",itemSelector:".league-team",emptyText:"No teams...",initComponent:function(){this.items=[];this.dockedItems=[];this.init();return this.callParent(arguments)},init:function(){this.initTemplate();this.initStore()},initTemplate:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="league-team">','<div class="image"><img src="{team_pic}" /></div>','<div class="name">{team_name}</div>',"</div>","</tpl>")},initStore:function(){if(this.store){return}this.store=Ext.create("TMS.league.store.Team")}});Ext.define("TMS.league.view.Week",{extend:"Ext.view.View",autoScroll:true,multiSelect:false,trackOver:true,deferEmptyText:false,overItemCls:"league-week-over",itemSelector:".league-week",emptyText:"No weeks...",initComponent:function(){this.items=[];this.dockedItems=[];this.init();return this.callParent(arguments)},init:function(){this.initTemplate()},initTemplate:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="league-week">','<div class="title">{title}</div>','<div class="date">{[this.renderDate(values.start_date)]} - {[this.renderDate(values.end_date)]}</div>',"</div>","</tpl>",{renderDate:Ext.util.Format.dateRenderer("M j, Y")})}});Ext.define("TMS.location.forms.sections.BillTo",{extend:"Ext.form.Panel",requires:["TMS.customer.lookup.Customer","TMS.location.lookup.Location"],layout:"anchor",defaults:{anchor:"100%",xtype:"textfield"},processingPage:"/at-ajax/modules/location/process/",autoSave:false,border:false,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initLocationSelector();this.initListeners()},initCustomerSelector:function(){this.customerSelector=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Customer",name:"bill_to_customer_id"});this.items.push(this.customerSelector)},initLocationSelector:function(){this.locationSelector=Ext.create("TMS.location.lookup.Location",{fieldLabel:"Billing Location",disabled:true,type:"customer",name:"bill_to_location_id"});this.items.push(this.locationSelector)},filterByCustomer:function(a){this.locationSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.store.proxy.extraParams.to_id=a;this.locationSelector.store.proxy.extraParams.locationType="Bill To"},initListeners:function(){return;this.customerSelector.on("select",function(c,b){if(!b.length){this.locationSelector.disable();return false}this.locationSelector.enable();var a=b[0];this.locationSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.store.proxy.extraParams.to_id=a.get("customer_id");this.locationSelector.store.loadPage(1);this.locationSelector.focus(true,50);this.locationSelector.expand()},this);this.customerSelector.on("change",function(b,a){if(a==null){this.locationSelector.setRawValue("");this.locationSelector.setValue(0);this.locationSelector.store.proxy.extraParams.to_id=0}},this)},getValue:function(){return this.locationSelector.getValue()},getValues:function(){var a={bill_to_id:this.locationSelector.getValue(),bill_to_location_id:this.locationSelector.getValue()};return a},loadLocation:function(a){},setRecord:function(a){this.locationSelector.enable();records=this.locationSelector.store.add({location_id:a.bill_to_location_id,location_display:a.bill_to_location_name});this.locationSelector.select(records[0])},lookupCustomer:function(a){this.locationSelector.store.proxy.extraParams.to_id=a;this.locationSelector.store.proxy.extraParams.locationType="Billing";Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"lookup-customer",params:{customerId:a,locationType:"Billing"},success:function(c){var b=Ext.decode(c.responseText);if(b.success){this.setRecord(b.record)}}})},lookupContact:function(a){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"lookup-contact",params:{contactId:a},success:function(c){var b=Ext.decode(c.responseText);if(b.success){this.setRecord(b.record)}}})}});Ext.define("TMS.location.forms.sections.Location",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox"],utilPage:"/at-ajax/modules/util/",layout:"anchor",defaults:{anchor:"100%",xtype:"textfield"},processingPage:"/at-ajax/modules/location/process/",autoSave:false,location_id:0,customer_id:0,carrier_id:0,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initName1();this.initName2();this.initAddress1();this.initAddress2();this.initAddress3();this.initZip();this.initCity();this.initStateField();this.initType();this.initHidden()},initName1:function(){this.name1Field=Ext.create("Ext.form.field.Text",{name:"name1",fieldLabel:"Location Name"});this.name1Field.on("blur",function(b){var a=b.getValue();if(a.length){this.checkLocationName(a)}},this);this.items.push(this.name1Field)},initName2:function(){this.name2Field=Ext.create("Ext.form.field.Text",{name:"name2",fieldLabel:"&nbsp;",labelSeparator:""});this.items.push(this.name2Field)},initAddress1:function(){this.address1Field=Ext.create("Ext.form.field.Text",{name:"address1",fieldLabel:"Address"});this.items.push(this.address1Field)},initAddress2:function(){this.address2Field=Ext.create("Ext.form.field.Text",{name:"address2",fieldLabel:"&nbsp;",labelSeparator:""});this.address2Field.on("blur",function(a){if(a.getValue().length){this.address3Field.show();this.address3Field.focus()}},this);this.items.push(this.address2Field)},initAddress3:function(){this.address3Field=Ext.create("Ext.form.field.Text",{name:"address3",fieldLabel:"&nbsp;",labelSeparator:"",hidden:true});this.items.push(this.address3Field)},initCity:function(){this.cityField=Ext.create("Ext.form.field.Text",{name:"city",fieldLabel:"City"});this.items.push(this.cityField)},initStateField:function(){this.stateField=Ext.create("Ext.form.field.ComboBox",{name:"state",fieldLabel:"State",valueField:"value",displayField:"display",queryMode:"local",store:new Ext.data.Store({fields:["value","display"],autoLoad:true,proxy:{type:"ajax",url:"/at-ajax/modules/util/data/states",reader:{type:"json",root:"records"}}})});this.items.push(this.stateField)},initZip:function(){this.zipField=new Ext.form.field.Text({scope:this,name:"zip",fieldLabel:"Zip",enableKeyEvents:true});this.zipField.on("keyup",this.getZipDetails,this,{buffer:300});this.zipField.on("change",this.getZipDetails,this,{buffer:300});this.items.push(this.zipField)},initType:function(){this.typeStore=Ext.create("Ext.data.Store",{fields:["location_type_id","name"],proxy:{type:"ajax",url:this.processingPage+"get-location-types",reader:{type:"json",root:"records"}},autoLoad:true});this.typeSelector=Ext.create("Ext.ux.form.field.RealComboBox",{flex:1,valueField:"location_type_id",displayField:"name",store:this.typeStore,queryMode:"local",editable:false,margin:"2",fieldLabel:"Type",name:"locationTypeId"});this.items.push(this.typeSelector)},initHidden:function(){this.locationId=new Ext.form.field.Hidden({scope:this,name:"location_id",value:this.location_id});this.customerId=new Ext.form.field.Hidden({scope:this,name:"customer_id",value:this.customer_id});this.carrierId=new Ext.form.field.Hidden({scope:this,name:"carrier_id",value:this.carrier_id});this.items.push(this.locationId);this.items.push(this.customerId);this.items.push(this.carrierId)},getZipDetails:function(){if(this.zipField.getValue().length>4){Ext.Ajax.request({scope:this,url:this.utilPage+"data/zip/",params:{zip:this.zipField.getValue()},success:function(b){var a=Ext.JSON.decode(b.responseText);if(a.record!=null){this.down("textfield[name=city]").setValue(a.record.city);this.down("textfield[name=state]").setValue(a.record.state)}}})}},checkLocationName:function(a){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"check-name",params:{name:a},success:function(c){var b=Ext.decode(c.responseText);var d=b.record.exists}})},loadLocation:function(b,a){this.location_id=b;if(this.location_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-location-data",params:{location_id:this.location_id},success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText);if(c.success){this.setFieldValues(c.record)}}})}},setFieldValues:function(a){this.name1Field.setValue(a.location_name_1);this.name2Field.setValue(a.location_name_2);this.address1Field.setValue(a.address_1);this.address2Field.setValue(a.address_2);this.address3Field.setValue(a.address_3);this.zipField.setValue(a.zip);this.locationId.setValue(a.location_id);this.typeSelector.setValue(a.type)},clearFieldValues:function(){var a={};a.location_name_1="";a.location_name_2="";a.address_1="";a.address_2="";a.address_3="";a.zip="";a.location_id="";a.type=0;this.setFieldValues(a)}});Ext.define("TMS.location.forms.Form",{extend:"TMS.form.Abstract",requires:["TMS.location.forms.sections.Location"],url:"/at-ajax/modules/location/process/process",bodyPadding:10,location_id:0,customer_id:0,carrier_id:0,initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initLocationSection()},initLocationSection:function(){this.locationSection=Ext.create("TMS.location.forms.sections.Location",{border:false,location_id:this.location_id,customer_id:this.customer_id,carrier_id:this.carrier_id});this.items.push(this.locationSection)}});Ext.define("TMS.location.lookup.Location",{extend:"Ext.ux.form.field.RealComboBox",type:"contact",processingPage:"/at-ajax/modules/location/lookup/location",displayField:"location_display",valueField:"location_id",emptyText:"Search for location...",typeAhead:false,hideTrigger:true,anchor:"100%",pageSize:10,minChars:0,width:250,listConfig:{loadingText:"Searching...",emptyText:"No matching locations found.",getInnerTpl:function(){return'<div class="location-name">{location_name_1}</div><div class="location-address">{address_1}</div><div class="location-city-state-zip">{city}, {state} {zip}</div>'}},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["location_id","location_display","location_name_1","address_1","city","state","zip","lat","lng"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{type:this.type}}})}});Ext.define("TMS.mypage.charts.leaderboard.Branch",{extend:"Ext.chart.Chart",requires:["TMS.mypage.charts.Theme"],processingPage:"/at-ajax/modules/stats/leaderboard/branch",animate:true,shadow:true,theme:"TMS",axes:[{type:"Numeric",position:"bottom",fields:["value"],grid:true,minimum:0},{type:"Category",position:"left",fields:["name"]}],series:[{type:"bar",axis:"bottom",highlight:true,label:{display:"insideEnd",field:"value",renderer:Ext.util.Format.numberRenderer("0"),orientation:"horizontal",color:"#333","text-anchor":"middle"},xField:"name",yField:["value"]}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["name","value","image"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"},extraParams:{reverse:true}}})}});Ext.define("TMS.mypage.charts.leaderboard.Individual",{extend:"Ext.chart.Chart",requires:["TMS.mypage.charts.Theme"],processingPage:"/at-ajax/modules/stats/leaderboard/individual",animate:true,shadow:true,theme:"TMS",axes:[{type:"Numeric",position:"bottom",fields:["value"],grid:true,minimum:0},{type:"Category",position:"left",fields:["name"]}],series:[{type:"bar",axis:"bottom",highlight:true,label:{display:"insideEnd",field:"value",orientation:"horizontal",color:"#333","text-anchor":"middle"},xField:"name",yField:["value"],tips:{renderer:function(b,a){this.update(Ext.String.format('<div class="tip-title">{0}</div><div class="tip-text"><b>Value:</b> {1}</div>',b.get("name"),b.get("value")))}}}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initStore()},initListeners:function(){this.on("afterrender",function(){var a=this.series.get(0);a.on("itemmouseup",function(b){this.fireEvent("itemclick",b)},this)},this)},initStore:function(){this.store=new Ext.data.Store({fields:["name","value","image"],autoLoad:false,pageSize:5,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{reverse:true}}})}});Ext.define("TMS.mypage.charts.leaderboard.Team",{extend:"Ext.chart.Chart",requires:["TMS.mypage.charts.Theme"],processingPage:"/at-ajax/modules/stats/leaderboard/team",animate:true,shadow:true,theme:"TMS",axes:[{type:"Numeric",position:"bottom",fields:["value"],grid:true,minimum:0},{type:"Category",position:"left",fields:["name"]}],series:[{type:"bar",axis:"bottom",highlight:true,color:"#FFFFFF",label:{display:"insideEnd",field:"value",renderer:Ext.util.Format.numberRenderer("0"),orientation:"horizontal",color:"#333","text-anchor":"middle"},xField:"name",yField:["value"],tips:{renderer:function(b,a){this.update(Ext.String.format('<div class="tip-title">{0}</div><div class="tip-text"><b>Value:</b> {1}</div>',b.get("name"),b.get("value")))}}}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["name","value","image"],pageSize:5,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"},extraParams:{reverse:true}}})}});Ext.define("TMS.mypage.charts.Compare",{extend:"Ext.chart.Chart",requires:["TMS.mypage.charts.Theme"],processingPage:"/at-ajax/modules/stats/user/compare",chartType:"points",chartTypeTitle:"Points",animate:true,shadow:true,theme:"TMS",legend:{position:"top"},axes:[{type:"Numeric",position:"left",fields:["value","company","branch"],grid:true,minimum:0},{type:"Category",position:"bottom",fields:["date"]}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initChartSeries();this.initStore();this.initListeners()},initChartSeries:function(){this.series=[{title:"My Average",type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"left",xField:"date",yField:"value",tips:{renderer:this.tipRender}},{title:"Company Average",type:"line",highlight:{size:7,radius:7},axis:"left",smooth:true,xField:"date",yField:"company",tips:{renderer:this.tipRender}},{id:"average",title:"Branch Average",type:"line",highlight:{size:7,radius:7},axis:"left",smooth:true,xField:"date",yField:"branch",tips:{renderer:this.tipRender}}]},initListeners:function(){this.on("afterrender",function(){this.store.load()},this)},initStore:function(){this.store=new Ext.data.Store({fields:["date","value","company","branch"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"},extraParams:{type:this.chartType}}})},tipRender:function(b,a){this.update(Ext.String.format('<div class="tip-title">{0}</div><div class="tip-text"><b>My Average:</b> {1}</div><div class="tip-text"><b>Company Average:</b> {2}</div><div class="tip-text"><b>Branch Average:</b> {3}</div>',b.get("date"),b.get("value"),b.get("company"),b.get("branch")))}});Ext.define("TMS.mypage.charts.Stats",{extend:"Ext.chart.Chart",requires:["TMS.mypage.charts.Theme"],processingPage:"/at-ajax/modules/stats/user/stats",animate:true,shadow:true,theme:"TMS",axes:[{type:"Numeric",position:"left",fields:["value"],grid:true,minimum:0,label:{renderer:Ext.util.Format.numberRenderer("0")}},{type:"Category",position:"bottom",fields:["date"],label:{font:"11px Arial"}}],series:[{type:"line",fill:true,smooth:true,axis:"left",xField:"date",yField:"value",highlight:true,tips:{renderer:function(b,a){this.update(Ext.String.format('<div class="tip-title">{0}</div><div class="tip-text"><b>{1}:</b> {2}</div>',b.get("date"),b.get("type"),b.get("value")))}}}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initAutoUpdate:function(){this.on("afterrender",function(){setInterval(Ext.bind(function(){this.store.load()},this),15000)},this)},initStore:function(){this.store=new Ext.data.Store({fields:["date","value","type","group"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}});this.store.on("load",function(b,a){if(!a.length){}},this)}});Ext.define("TMS.mypage.charts.Theme",{});Ext.define("Ext.chart.theme.TMS",{extend:"Ext.chart.theme.Base",constructor:function(a){Ext.chart.theme.call(this,a,{baseColor:"#001B7C",background:false,axis:{stroke:"#444","stroke-width":1},axisLabelTop:{fill:"#444",font:"12px Arial, Helvetica, sans-serif",spacing:2,padding:5,renderer:function(b){return b}},axisLabelRight:{fill:"#444",font:"12px Arial, Helvetica, sans-serif",spacing:2,padding:5,renderer:function(b){return b}},axisLabelBottom:{fill:"#444",font:"12px Arial, Helvetica, sans-serif",spacing:2,padding:5,renderer:function(b){return b}},axisLabelLeft:{fill:"#444",font:"12px Arial, Helvetica, sans-serif",spacing:2,padding:5,renderer:function(b){return b}},axisTitleTop:{font:"bold 18px Arial",fill:"#444"},axisTitleRight:{font:"bold 18px Arial",fill:"#444",rotate:{x:0,y:0,degrees:270}},axisTitleBottom:{font:"bold 18px Arial",fill:"#444"},axisTitleLeft:{font:"bold 18px Arial",fill:"#444",rotate:{x:0,y:0,degrees:270}},series:{"stroke-width":0},seriesLabel:{font:"bold 12px Arial",fill:"#fff"},marker:{stroke:"#555",fill:"#000",radius:3,size:3},colors:["#001B7C","#E12210","#F28900"],seriesThemes:[{fill:"#001B7C"},{fill:"#E12210"},{fill:"#F28900"},{fill:"#ff8809"},{fill:"#ffd13e"},{fill:"#a61187"},{fill:"#24ad9a"},{fill:"#7c7474"},{fill:"#a66111"}],markerThemes:[{fill:"#001B7C",type:"circle"},{fill:"#E12210",type:"cross"},{fill:"#F28900",type:"plus"}]})}});Ext.define("TMS.mypage.dashboard.Leaderboard",{extend:"Ext.panel.Panel",requires:["TMS.mypage.Util","TMS.mypage.filter.Filter","TMS.mypage.grids.Stats"],border:false,defaults:{cls:"mypage-leaderboard"},chartHeight:200,statTypes:[],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initFilter();this.initLeaderPanel();this.initWestPanel();this.initCenterPanel();this.initInfoTemplate();this.initIndividualChart();this.initTeamChart();this.initBranchChart();this.initStatsGrid()},initLeaderPanel:function(){this.leaderPanel=new Ext.panel.Panel({scope:this,height:300,layout:"border",border:false,unstyled:true});this.items.push(this.leaderPanel)},initWestPanel:function(){this.westPanel=new Ext.panel.Panel({scope:this,region:"west",width:200,margin:"2",border:false,unstyled:true,layout:{type:"vbox",align:"stretch"}});this.leaderPanel.add(this.westPanel)},initCenterPanel:function(){this.centerPanel=new Ext.panel.Panel({scope:this,region:"center",border:false,margin:"2",layout:{type:"card",deferredRender:true},activeItem:false});this.on("afterrender",function(){this.westPanel.child("button").toggle(true)},this);this.leaderPanel.add(this.centerPanel)},initFilter:function(){this.filterPanel=Ext.create("TMS.mypage.filter.Filter",{scope:this,border:false,unstyled:true});this.items.push(this.filterPanel)},initInfoTemplate:function(){this.infoTemplate=new Ext.XTemplate('<div class="image">','<img src="{image}" />','<div class="name">',"{name}","</div>","</div>")},initIndividualChart:function(){this.createLeaderboard({type:"individual",title:"Individual Leaders",chartClass:"TMS.mypage.charts.leaderboard.Individual",icon:"/resources/icons/user-black-32.png"})},initTeamChart:function(){this.createLeaderboard({type:"team",title:"Team Leaders",chartClass:"TMS.mypage.charts.leaderboard.Team",icon:"/resources/icons/group-black-32.png"})},initBranchChart:function(){this.createLeaderboard({type:"branch",title:"Branch Leaders",chartClass:"TMS.mypage.charts.leaderboard.Branch",icon:"/resources/icons/group-black-32.png"})},initStatsGrid:function(){this.statsGrid=Ext.create("TMS.mypage.grids.Stats",{scope:this,title:"Complete Leaders",margin:"10 0 0 0"});this.items.push(this.statsGrid);this.on("statchange",function(a){this.statsGrid.store.proxy.extraParams.type=a;this.statsGrid.store.loadPage(1)},this);this.on("typechange",function(a){this.statsGrid.setProxy(this.statsGrid.processingPages[a]);this.statsGrid.store.loadPage(1)},this);this.filterPanel.on("filter",function(a,b){Ext.apply(this.statsGrid.store.proxy.extraParams,b);this.statsGrid.store.loadPage(1)},this)},createLeaderboard:function(g){var a={icon:""};var d={};Ext.apply(d,g,a);var f=d.type+"Chart";var c=d.type+"ChartPanel";var h=d.type+"InfoPanel";var b=d.type+"Panel";var e=d.type+"Button";this[f]=Ext.create(d.chartClass,{height:this.chartHeight});this[f].on("afterrender",function(){this[f].store.load({params:{start:0,limit:5}})},this);this[f].on("itemclick",function(j){var i=j.storeItem;this[d.type+"InfoPanel"].update(this.infoTemplate.apply({image:i.get("image"),name:i.get("name")+" ("+i.get("value")+")"}))},this);this[f].store.on("load",function(k,j){if(j.length){var i=j[j.length-1];this[d.type+"InfoPanel"].update(this.infoTemplate.apply({image:i.get("image"),name:i.get("name")+" ("+i.get("value")+")"}))}},this);this[c]=new Ext.panel.Panel({columnWidth:1,border:false});this[c].on("afterrender",function(){this[f].setWidth(this[c].getWidth());this[c].add(this[f]);this[c].doLayout()},this);this[h]=new Ext.panel.Panel({width:200,height:this.chartHeight,border:false,autoHeight:true,html:"&nbsp;"});this[b]=new Ext.panel.Panel(Ext.apply({title:d.title,layout:"column",autoHeight:true,items:[this[h],this[c]]},this.defaults));this[b].on("afterrender",function(i,j){this.createStatTypeMenu(j.panel,j.chart)},this,{panel:this[b],chart:this[f]});this[f].store.on("beforeload",function(j,i,k){k.panel.setLoading(true)},this,{panel:this[b]});this[f].store.on("load",function(j,i,l,k){k.panel.setLoading(false)},this,{panel:this[b]});this.filterPanel.on("filter",function(i,k,j){Ext.apply(j.chart.store.proxy.extraParams,k);if(j.chart.rendered&&this.centerPanel.getLayout().getActiveItem()==j.container){j.chart.store.load()}},this,{chart:this[f],container:this[b]});this.centerPanel.add(this[b]);this[e]=new Ext.button.Button({scope:this,text:d.title,panel:this[b],cls:"leaderboard-button",icon:d.icon,type:d.type,scale:"large",margin:"5",flex:1,enableToggle:true,toggleGroup:"tms-stats-leaderboard"});this[e].on("toggle",function(j,k,i){if(k){this.centerPanel.getLayout().setActiveItem(j.panel);this.fireEvent("typechange",j.type)}},this);this.westPanel.add(this[e])},createStatTypeMenu:function(a,c){if(a.header==null){return false}var d=new Ext.menu.Menu();var b=new Ext.button.Button({text:"Stat Type (Points)",icon:"/resources/icons/bar-chart-16.png",menu:d});Ext.each(TMS.mypage.Util.getStatTypes(),function(f){var e=new Ext.menu.Item({scope:this,text:f.title,chart:c,panel:a,type:f,parentMenu:d,parentMenuButton:b,handler:function(g){g.parentMenuButton.setText("Stat Type ("+g.text+")");g.panel.doComponentLayout();g.chart.store.proxy.extraParams.type=g.type.field;g.chart.store.loadPage(1);this.fireEvent("statchange",g.type.field)}});d.add(e)},this);a.header.add(b);a.header.doComponentLayout()}});Ext.define("TMS.mypage.dashboard.Scores",{extend:"Ext.panel.Panel",requires:["Ext.ux.Spinner","TMS.league.model.Week","TMS.league.view.Week","TMS.league.store.Team","TMS.league.view.Game","TMS.ActionWindow"],layout:"border",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initLeft();this.initCenter();this.initWeekView();this.initGameFilter();this.initGamePanel();this.initGameView();this.initGameDetails()},initLeft:function(){this.left=new Ext.panel.Panel({scope:this,region:"west",width:200,autoScroll:true});this.items.push(this.left)},initCenter:function(){this.center=new Ext.panel.Panel({scope:this,region:"center",layout:"fit",border:false});this.items.push(this.center)},initWeekView:function(){this.weekView=Ext.create("TMS.league.view.Week",{scope:this,store:new Ext.data.Store({model:"TMS.league.model.Week"})});this.left.add(this.weekView);this.on("afterrender",function(){this.weekView.store.load({params:{active:true}})},this);this.weekView.store.on("load",function(){this.left.doLayout()},this);this.weekView.on("refresh",function(a,c){var b=this.weekView.getNodes();Ext.each(b,function(e){var d=this.weekView.getRecord(e);if(d.isActive()){this.weekView.select(d)}},this)},this)},initGameFilter:function(){this.teamCombo=new Ext.form.field.ComboBox({fieldLabel:"Team",store:Ext.create("TMS.league.store.Team",{autoSync:false}),labelWidth:60,queryMode:"local",displayField:"team_name",valueField:"league_team_id"});this.teamCombo.store.on("load",function(){this.teamCombo.store.insert(0,{team_name:"All Teams...",league_team_id:0})},this);this.teamCombo.on("select",function(d,b,c){if(!b.length){return}var a=b[0];if(a.get("league_team_id")){this.gameView.store.filter("team_id",a.get("league_team_id"))}else{Ext.each(this.gameView.store.filters.items,function(e){if(e.property=="team_id"){this.gameView.store.filters.remove(e)}},this);this.gameView.store.load()}},this);this.gameFilter=new Ext.toolbar.Toolbar({scope:this,items:[this.teamCombo]})},initGamePanel:function(){this.gamePanel=new Ext.panel.Panel({scope:this,layout:"fit",height:350,autoScroll:true,tbar:this.gameFilter});this.center.add(this.gamePanel)},initGameView:function(){this.gameView=Ext.create("TMS.league.view.Game",{store:new Ext.data.Store({model:"TMS.league.model.Game",remoteFilter:true})});this.gamePanel.add(this.gameView);this.weekView.on("selectionchange",function(b,c,d){if(!c.length){return}var a=c[0];this.gameView.store.filter("week_id",a.get("week_id"))},this)},initGameDetails:function(){this.gameDetailsTemplate=new Ext.XTemplate('<div class="league-game-details">','<div class="league-game-details-header">','<div class="team-header home-team-header">','<div class="image">','<img src="{home_team.team_pic}" />',"</div>",'<div class="name">','{home_team.team_name} <span class="record">({home_team.record.wins} - {home_team.record.losses})</span>',"</div>",'<div class="score">',"{home_score}","</div>",'<div class="clear"></div>',"</div>",'<div class="team-header away-team-header">','<div class="image">','<img src="{away_team.team_pic}" />',"</div>",'<div class="name">','{away_team.team_name} <span class="record">({away_team.record.wins} - {away_team.record.losses})</span>',"</div>",'<div class="score">',"{away_score}","</div>",'<div class="clear"></div>',"</div>",'<div class="clear"></div>',"</div>",'<div class="league-game-details-body">','<div class="home-team">','<table width="100%">',"<thead>","<tr>","<th>","{home_team.team_name}","</th>",'<tpl for="dates">',"<th>{[this.renderDate(values.date)]}</th>","</tpl>","<th>","Score","</th>","</tr>","</thead>","<tbody>",'<tpl for="home_team.members">',"<tr>",'<td class="member-name">','<a href="/mypage?id={user_id}">{first_name} {last_name}</a>',"</td>",'<tpl for="stats">','<td class="{[this.createDateClass(values.date)]}">',"{value}","</td>","</tpl>","<td>","{[this.computeAverage(values.stats)]}","</td>","</tr>","</tpl>","</tbody>","</table>",'<div class="clear"></div>',"</div>",'<div class="away-team">','<table width="100%">',"<thead>","<tr>","<th>","{away_team.team_name}","</th>",'<tpl for="dates">',"<th>{[this.renderDate(values.date)]}</th>","</tpl>","<th>","Score","</th>","</tr>","</thead>","<tbody>",'<tpl for="away_team.members">',"<tr>",'<td class="member-name">','<a href="/mypage?id={user_id}">{first_name} {last_name}</a>',"</td>",'<tpl for="stats">','<td class="{[this.createDateClass(values.date)]}">',"{value}","</td>","</tpl>","<td>","{[this.computeAverage(values.stats)]}","</td>","</tr>","</tpl>","</tbody>","</table>",'<div class="clear"></div>',"</div>","</div>","</div>",{renderDate:Ext.util.Format.dateRenderer("M jS"),createDateClass:function(a){return"league-game-details-date-"+Ext.Date.format(new Date(a),"n-j-y")},computeAverage:function(b){var d=0;var c=0;var a=new Date();Ext.each(b,function(e){var f=new Date(e.date);var g=parseInt(e.value);if(f<=a&&g){d+=g;c++}},this);if(c){return Math.ceil(d/c)}return 0}});this.gameContainer=new Ext.panel.Panel({scope:this,border:false,html:"",autoScroll:true});this.gameWindow=Ext.create("TMS.ActionWindow",{scope:this,autoShow:false,layout:"fit",title:"Game Details",frame:false,items:[this.gameContainer],closeAction:"hide",modal:true,resizable:false});this.gameWindow.on("beforeshow",function(){this.gameWindow.setWidth(Ext.Element.getViewportWidth()*0.7);this.gameWindow.setHeight(Ext.Element.getViewportHeight()*0.7)},this);this.gameView.on("selectionchange",function(b,c,d){if(!c.length){return}var a=c[0];var e={lines:10,length:0,width:5,radius:10,color:"#fff",speed:1,trail:100,shadow:true};var f=new Spinner(e).spin(this.gameView.getNode(a));Ext.Ajax.request({scope:this,url:"/at-ajax/modules/league/game/details",params:{game_id:a.get("game_id")},success:function(i){var h=Ext.decode(i.responseText);this.gameContainer.update(this.gameDetailsTemplate.apply(h.record),false,Ext.bind(function(){return;var j=this.gameContainer.getEl().select("table").elements;Ext.each(j,function(l){l=Ext.get(l);var k=Ext.create("Ext.ux.grid.TransformGrid",l.dom.id,{stripeRows:true,height:l.getHeight()});k.render()},this)},this));this.gameWindow.show();f.stop();var g="."+this.gameDetailsTemplate.createDateClass(new Date(),"n/j/Y");this.gameContainer.getEl().select(g).each(function(j){j.addCls("active-date")},this)}})},this)}});Ext.define("TMS.mypage.dashboard.Standings",{extend:"Ext.panel.Panel",requires:["TMS.league.store.Season","TMS.league.grid.Standings"],layout:"fit",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.dockedItems=[];this.initToolbar();this.initSeasonCombo();this.initStandingsGrid()},initToolbar:function(){this.toolbar=new Ext.toolbar.Toolbar({scope:this,docked:"top"});this.dockedItems.push(this.toolbar)},initSeasonCombo:function(){this.seasonCombo=Ext.create("Ext.form.ComboBox",{fieldLabel:"Season",store:Ext.create("TMS.league.store.Season"),queryMode:"local",displayField:"title",valueField:"season_id"});this.toolbar.add(this.seasonCombo);this.seasonCombo.on("select",function(d,b,c){if(!b.length){return}var a=b[0];this.standingsGrid.store.load({params:{season_id:a.get("season_id")}})},this)},initStandingsGrid:function(){this.standingsGrid=Ext.create("TMS.league.grid.Standings",{scope:this});this.items.push(this.standingsGrid)}});Ext.define("TMS.mypage.dashboard.Stats",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox","TMS.mypage.Util","TMS.mypage.filter.Filter","TMS.mypage.user.Info","TMS.mypage.charts.Compare","TMS.mypage.user.Overview"],userProcessingPage:"/at-ajax/modules/stats/user/",charts:{},filter:{},layout:"column",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initLeft();this.initCenter();this.initFilter();this.initUserSelect();this.initUserInfo();this.initChartPanel();this.initTypeMenu();this.initCompareCharts();this.initUserOverview()},initLeft:function(){this.left=new Ext.panel.Panel({scope:this,width:210,border:false,unstyled:true,margin:"0 10 0 0"});this.items.push(this.left)},initCenter:function(){this.center=new Ext.panel.Panel({scope:this,columnWidth:1,border:true,unstyled:true});this.items.push(this.center)},initFilter:function(){this.filterPanel=Ext.create("TMS.mypage.filter.Filter",{scope:this,border:false,unstyled:true});this.center.add(this.filterPanel)},initUserSelect:function(){var a=this.getParams();this.userStore=new Ext.data.Store({fields:["id","name","image"],proxy:{type:"ajax",url:this.userProcessingPage+"list",reader:{type:"json",root:"records"}}});this.userSelect=new Ext.ux.form.field.RealComboBox({displayField:"name",fieldLabel:"User",labelWidth:50,emptyText:"Search by name...",typeAhead:false,pageSize:10,minChars:0,listConfig:{loadingText:"Searching...",emptyText:"No users were found.",getInnerTpl:function(){return'<div class="mypage-user-list-item"><div class="image"><img src="{image}" /></div><div class="name">{name}</div><div class="clear"></div></div>'}},store:this.userStore});if(a.id!=null){this.userSelect.loadFromStore({userId:a.id},false)}this.userSelect.on("select",function(e,c,d){if(!c.length){return false}var b=c[0];this.filterPanel.updateFilter({userId:b.get("id")})},this);this.filterPanel.insert(0,this.userSelect)},initUserInfo:function(){this.userInfo=Ext.create("TMS.mypage.user.Info");this.left.add(this.userInfo);var a=this.getParams();var b={};if(a.id!=null){b.userId=a.id}this.userInfo.on("afterrender",function(){Ext.Ajax.request({scope:this,url:this.userProcessingPage+"info",params:b,success:function(d){var c=Ext.decode(d.responseText);this.userInfo.update(c.record)}})},this);this.filterPanel.on("filter",function(c,e,d){Ext.Ajax.request({scope:this,url:this.userProcessingPage+"info",params:e,success:function(g){var f=Ext.decode(g.responseText);this.userInfo.update(f.record)}})},this)},initChartPanel:function(){this.chartPanel=new Ext.panel.Panel({height:300,title:"Points",layout:{type:"card",deferredRender:true}});this.center.add(this.chartPanel);this.chartPanel.on("afterrender",function(){var a=this.initChartType({title:"Points",field:"points"});this.chartPanel.getLayout().setActiveItem(0);a.store.load()},this)},initTypeMenu:function(){this.typeMenu=new Ext.menu.Menu();this.chartPanel.on("afterrender",function(){if(this.chartPanel.header==null){return false}this.typeButton=new Ext.button.Button({text:"Stat Type (Points)",icon:"/resources/icons/bar-chart-16.png",menu:this.typeMenu});this.chartPanel.header.add(this.typeButton);this.chartPanel.header.doComponentLayout()},this)},initCompareCharts:function(){Ext.each(TMS.mypage.Util.getStatTypes(),function(a){this.typeMenu.add({scope:this,text:a.title,type:a,icon:"/resources/icons/bar-chart-32.png",handler:function(b){if(this.charts[b.type.field]==null){this.initChartType(b.type)}this.chartPanel.getLayout().setActiveItem(this.charts[b.type.field]);this.typeButton.setText("Stat Type ("+b.type.title+")");this.chartPanel.header.doLayout();this.chartPanel.setTitle(b.type.title)}})},this)},initChartType:function(c){var b=Ext.create("TMS.mypage.charts.Compare",{chartType:c.field,chartTypeTitle:c.title,width:this.chartPanel.getWidth(),height:this.chartPanel.getHeight()});var d=this.getParams();if(d.id!=null){b.store.proxy.extraParams.userId=d.id}this.filterPanel.on("filter",function(e,g,f){Ext.apply(f.chart.store.proxy.extraParams,g);if(f.chart.rendered&&this.chartPanel.getLayout().getActiveItem()==f.chart.ownerCt){f.chart.store.load()}},this,{chart:b});var a=new Ext.panel.Panel({scope:this,border:false,unstyled:true,chart:b,bodyPadding:10});a.on("afterrender",function(e){e.chart.setWidth(e.getWidth()-20);e.chart.setHeight(this.chartPanel.getHeight()-50);e.add(e.chart);e.doComponentLayout();e.chart.store.load()},this,{single:true});this.charts[c.field]=a;this.chartPanel.add(a);return b},initUserOverview:function(){this.userOverviewPanel=new Ext.panel.Panel({scope:this,border:false,margin:"10 0 0 0"});this.center.add(this.userOverviewPanel);this.userOverview=Ext.create("TMS.mypage.user.Overview");this.userOverviewPanel.add(this.userOverview);var a=this.getParams();if(a.id!=null){this.userOverview.store.proxy.extraParams.userId=a.id}this.userOverview.store.on("load",function(){this.userOverviewPanel.doLayout()},this);this.userOverview.on("afterrender",function(){this.userOverview.store.load()},this);this.filterPanel.on("filter",function(b,d,c){Ext.apply(this.userOverview.store.proxy.extraParams,d);this.userOverview.store.load()},this)},getParams:function(){var a=location.href.split("?");var b={};if(a.length>1){b=Ext.Object.fromQueryString(a[1])}return b}});Ext.define("TMS.mypage.dashboard.Teams",{extend:"Ext.panel.Panel",requires:["TMS.league.view.Team"],layout:"border",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initLeft();this.initCenter();this.initTeamView();this.initTeamDetails()},initLeft:function(){this.left=new Ext.panel.Panel({scope:this,region:"west",width:250,autoScroll:true});this.items.push(this.left)},initCenter:function(){this.center=new Ext.panel.Panel({scope:this,layout:"fit",region:"center",border:false});this.items.push(this.center)},initTeamView:function(){this.teamView=Ext.create("TMS.league.view.Team",{scope:this});this.left.add(this.teamView);this.teamView.store.on("load",function(){this.left.doLayout()},this);this.teamView.store.on("load",function(c,b){var d=location.href.split("?");var a=b[0];if(d.length){var e=Ext.Object.fromQueryString(d[1]);if(e.id!=null){a=this.teamView.store.getAt(this.teamView.store.find("league_team_id",e.id))}}if(a!=null){this.teamView.select(a);this.teamView.getNode(a).scrollIntoView(this.left.body)}},this,{single:true})},initTeamDetails:function(){this.teamDetailsTemplate=new Ext.XTemplate('<div class="league-team-details">','<div class="league-team-details-header">','<div class="image"><img src="{team_pic}" /></div>','<div class="name">{team_name}</div>','<div class="record">{[this.computeRecord(values)]}</div>',"</div>",'<div class="sub-header">Schedule</div>','<div class="schedule">','<table width="100%">',"<thead>","<tr>","<th>","Week","</th>","<th>","Date","</th>","<th>","Opponent","</th>","<th>","Result","</th>","</tr>","</thead>","<tbody>",'<tpl for="schedule">',"<tr>","<td>","{title}","</td>","<td>","{[this.renderGameDate(values.start_date)]} - {[this.renderGameDate(values.end_date)]}","</td>","<td>","{[this.getOpponent(values, parent)]}","</td>","<td>","{[this.getResult(values, parent)]}","</td>","</tr>","</tpl>","</tbody>","</table>","</div>",'<div class="sub-header" style="margin-top: 10px;">Roster</div>','<div class="members">','<table width="100%">',"<thead>","<tr>","<th>","Rank","</th>","<th>","Name","</th>","<th>","Joined","</th>","</tr>","</thead>","<tbody>",'<tpl for="members">',"<tr>",'<td width="40">',"{rank}","</td>","<td>","{first_name} {last_name}","</td>","<td>","{[this.renderDate(values.created_at)]}","</td>","</tr>","</tpl>","</tbody>","</table>","</div>","</div>",{renderGameDate:Ext.util.Format.dateRenderer("M jS"),renderDate:Ext.util.Format.dateRenderer("F j, Y"),getOpponent:function(a,b){if(a.home_team_id!=b.league_team_id){return a.home_team_name}else{return a.away_team_name}},getResult:function(b,c){var a="";if(parseInt(b.winning_team_id)){if(b.winning_team_id==c.league_team_id){a='<span style="color: green">W</span>'}else{a='<span style="color: red">L</span>'}}return Ext.String.format("{0} ({1} - {2})",a,b.home_score,b.away_score)},computeRecord:function(a){var c=0;var b=0;Ext.each(a.schedule,function(d){if(d.winning_team_id==a.league_team_id){c++}if(d.losing_team_id==a.league_team_id){b++}});return Ext.String.format("({0} - {1})",c,b)}});this.teamDetails=new Ext.panel.Panel({scope:this,border:false,bodyPadding:10,autoScroll:true});this.center.add(this.teamDetails);this.teamView.on("selectionchange",function(b,c,d){if(!c.length){return}var a=c[0];this.teamDetails.update("");this.teamDetails.setHeight(150);this.teamDetails.setLoading(true);Ext.Ajax.request({scope:this,url:"/at-ajax/modules/league/team/details",params:{league_team_id:a.get("league_team_id")},success:function(f){var e=Ext.decode(f.responseText);this.teamDetails.update(this.teamDetailsTemplate.apply(e.record),false,Ext.bind(function(){return;var g=this.teamDetails.getEl().select(".members").elements;Ext.each(g,function(i){i=Ext.get(i);var k=i.down("table");var j=Ext.create("Ext.ux.grid.TransformGrid",k.dom.id,{stripeRows:true});var h=new Ext.panel.Panel({scope:this,items:[j],renderTo:i})},this)},this));this.teamDetails.setHeight(null);this.teamDetails.setLoading(false)}})},this)}});Ext.define("TMS.mypage.filter.Filter",{extend:"Ext.panel.Panel",layout:"hbox",defaults:{margin:2,flex:1},filter:{},initComponent:function(){this.items=[];this.filter={};this.init();this.callParent(arguments)},init:function(){this.initStartDate();this.initStopDate()},initStartDate:function(){this.startDate=new Ext.form.field.Date({fieldLabel:"Start Date",labelWidth:70,emptyText:"Select start date..."});this.startDate.on("select",function(e,d){if(this.stopDate.getValue()==null){var c=new Date(d);c.setDate(c.getDate()+7);this.stopDate.setValue(Ext.Date.format(c,"n/j/Y"))}else{var b=new Date(d);var a=new Date(this.stopDate.getValue());if(b>=a){b.setDate(b.getDate()+7);this.stopDate.setValue(Ext.Date.format(b,"n/j/Y"))}}this.updateFilter({startDate:this.startDate.getValue(),stopDate:this.stopDate.getValue()})},this);this.items.push(this.startDate)},initStopDate:function(){this.stopDate=new Ext.form.field.Date({fieldLabel:"End Date",labelWidth:70,emptyText:"Select stop date..."});this.stopDate.on("select",function(e,d){if(this.startDate.getValue()==null){var c=new Date(d);c.setDate(c.getDate()-7);this.startDate.setValue(Ext.Date.format(c,"n/j/Y"))}else{var b=new Date(this.startDate.getValue());var a=new Date(d);if(a<=b){a.setDate(a.getDate()-7);this.startDate.setValue(Ext.Date.format(a,"n/j/Y"))}}this.updateFilter({startDate:this.startDate.getValue(),stopDate:this.stopDate.getValue()})},this);this.items.push(this.stopDate)},updateFilter:function(a){Ext.apply(this.filter,a);this.fireEvent("filter",this,this.filter)}});Ext.define("TMS.mypage.grids.Branch",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/stats/branch/grid",branchListPage:"/at-ajax/modules/stats/branch/list",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initTbar();this.initColumns();this.initStore();this.initFilters()},initListeners:function(){this.on("afterrender",function(){this.store.load()},this)},initTbar:function(){this.tbar=new Ext.toolbar.Toolbar({scope:this,items:[]})},initColumns:function(){this.columns=[{header:"Name",dataIndex:"name",flex:1},{header:"Value",dataIndex:"value"}]},initStore:function(){this.store=new Ext.data.Store({fields:["name","value",],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}})},initFilters:function(){this.branchStore=new Ext.data.Store({fields:["id","name",],proxy:{type:"ajax",url:this.branchListPage,reader:{type:"json",root:"records"}}});this.branchSelect=new Ext.form.field.ComboBox({scope:this,fieldLabel:"Branch",labelWidth:50,store:this.branchStore,displayField:"name",valueField:"id"});this.branchSelect.on("select",function(d,b,c){var a=null;if(b.length){a=b[0];this.store.proxy.extraParams.branchId=a.get("id");this.store.load()}},this);this.dateFilter=new Ext.form.field.Date({scope:this,fieldLabel:"Date",labelWidth:50,emptyText:"Select date..."});this.dateFilter.on("change",function(b,a){this.store.proxy.extraParams.date=a;this.store.load()},this);this.refreshButton=new Ext.button.Button({scope:this,text:"Refresh",icon:"/resources/icons/refresh-24.png",handler:function(){this.store.load()}});this.tbar.add(this.branchSelect,this.dateFilter)}});Ext.define("TMS.mypage.grids.Stats",{extend:"Ext.grid.Panel",processingPages:{individual:"/at-ajax/modules/stats/leaderboard/individual",team:"/at-ajax/modules/stats/leaderboard/team",branch:"/at-ajax/modules/stats/leaderboard/branch"},initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager()},initPager:function(){this.tbar=new Ext.toolbar.Paging({store:this.store,displayInfo:true})},initColumns:function(){this.columns=[{header:"Rank",dataIndex:"rank",width:50},{dataIndex:"image",width:50,renderer:function(c,b,a){return'<img src="'+c+'" width="30" />'}},{header:"Name",dataIndex:"name",flex:1,renderer:function(c,b,a){if(a.get("url").length){return Ext.String.format('<a href="{0}">{1}</a>',a.get("url"),c)}else{return c}}},{header:"Value",dataIndex:"value"}]},initStore:function(){this.store=new Ext.data.Store({fields:["name","url","image","value","rank"],remoteSort:true,remoteFilter:true});this.setProxy(this.processingPages.individual);this.on("afterrender",function(){this.store.load()},this)},setProxy:function(a){this.store.setProxy({type:"ajax",url:a,pageSize:50,reader:{type:"json",root:"records"}})}});Ext.define("TMS.mypage.grids.Team",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/stats/team/grid",teamListPage:"/at-ajax/modules/stats/team/list",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initTbar();this.initColumns();this.initStore();this.initFilters()},initListeners:function(){this.on("afterrender",function(){this.store.load()},this)},initTbar:function(){this.tbar=new Ext.toolbar.Toolbar({scope:this,items:[]})},initColumns:function(){this.columns=[{header:"Name",dataIndex:"name",flex:1},{header:"Value",dataIndex:"value"}]},initStore:function(){this.store=new Ext.data.Store({fields:["name","value",],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}})},initFilters:function(){this.teamStore=new Ext.data.Store({fields:["id","name",],proxy:{type:"ajax",url:this.teamListPage,reader:{type:"json",root:"records"}}});this.teamSelect=new Ext.form.field.ComboBox({scope:this,fieldLabel:"Team",labelWidth:50,store:this.teamStore,displayField:"name",valueField:"id"});this.teamSelect.on("select",function(d,b,c){var a=null;if(b.length){a=b[0];this.store.proxy.extraParams.teamId=a.get("id");this.store.load()}},this);this.dateFilter=new Ext.form.field.Date({scope:this,fieldLabel:"Date",labelWidth:50,emptyText:"Select date..."});this.dateFilter.on("change",function(b,a){this.store.proxy.extraParams.date=a;this.store.load()},this);this.refreshButton=new Ext.button.Button({scope:this,text:"Refresh",icon:"/resources/icons/refresh-24.png",handler:function(){this.store.load()}});this.tbar.add(this.teamSelect,this.dateFilter)}});Ext.define("TMS.mypage.user.Grid",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/stats/user/grid",initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initColumns();this.initStore()},initListeners:function(){this.on("afterrender",function(){this.store.load()},this)},initColumns:function(){this.columns=[{header:"Name",dataIndex:"name",flex:1},{header:"Value",dataIndex:"value"}]},initStore:function(){this.store=new Ext.data.Store({fields:["name","value"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}})}});Ext.define("TMS.mypage.user.Info",{extend:"Ext.container.Container",border:false,unstyled:true,cls:"mypage-user-info",height:250,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initInfoTemplate()},initInfoTemplate:function(){this.infoTemplate=new Ext.XTemplate('<div class="name">',"{name} | {team_name}","</div>",'<div class="branch">',"{branch_name}","</div>",'<div class="image">','<img src="{image}" />',"</div>",'<div class="points">','<span class="points-text">Points: </span>{points}',"</div>",'<div class="rank">','<span class="rank-text">Rank: </span>{[Ext.util.Inflector.ordinalize(values.rank)]} of {total} ({[this.getPercentile(values.rank, values.total)]})',"</div>",{getPercentile:function(d,b){var a=Math.floor((d/b)*100);var c="Top";if(a>50){c="Bottom";a=100-a;if(a>10){a=((Math.ceil((a/10)))*10)}}else{if(a>10){a=(Math.floor((a/10)))*10}}if(a==0){a=1}return c+" "+a+"%"}})},update:function(a){this.callParent([this.infoTemplate.apply(a)])}});Ext.define("TMS.mypage.user.Margin",{extend:"Ext.panel.Panel",chartHeight:300,autoHeight:true,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initTbar();this.initChart();this.initFilters()},initListeners:function(){},initTbar:function(){this.tbar=new Ext.toolbar.Toolbar({scope:this,items:[]})},initFilters:function(){this.initView()},initView:function(){this.viewMenu=new Ext.menu.Menu();this.chart.on("afterrender",function(){Ext.each(this.chart.series.items,function(a){var b=new Ext.menu.CheckItem({scope:this,text:a.title,checked:true,series:a,checkHandler:function(d,c){if(c){a.showAll()}else{a.hideAll()}this.chart.doComponentLayout()}});this.viewMenu.add(b)},this);this.viewMenu.doComponentLayout()},this);this.viewButton=new Ext.button.Button({scope:this,text:"View",menu:this.viewMenu});this.tbar.add(this.viewButton)},initChart:function(){this.chart=new MyPage.charts.Margin({});this.on("afterrender",function(){this.chart.setWidth(this.getWidth());this.chart.setHeight(this.chartHeight);this.add(this.chart);this.doLayout();this.chart.store.load()},this)}});Ext.define("TMS.mypage.user.Overview",{extend:"Ext.view.View",processingPage:"/at-ajax/modules/stats/user/grid",multiSelect:false,trackOver:true,deferEmptyText:false,overItemCls:"mypage-user-overview-item-over",itemSelector:".mypage-user-overview-item",emptyText:"No stats...",initComponent:function(){this.items=[];this.dockedItems=[];this.init();return this.callParent(arguments)},init:function(){this.initStore();this.initTemplate()},initStore:function(){this.store=new Ext.data.Store({fields:["name","value"],proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records"}}})},initTemplate:function(){this.tpl=new Ext.XTemplate('<table class="mypage-user-overview-table">',"<tbody>",'<tpl for=".">',"<tr>",'<td class="name">',"{name}","</td>",'<td class="value">',"{value}","</td>","</tr>","</tpl>","</tbody>","</table>")}});Ext.define("TMS.mypage.user.Stats",{extend:"Ext.panel.Panel",requires:["TMS.mypage.charts.Stats","TMS.mypage.user.Overview"],imageEl:false,chartHeight:200,layout:"column",bodyCls:"header-info-panel",border:false,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.items=[];this.initLeftPanel();this.initCenterPanel();this.initFilterPanel();this.initUserSelect();this.initDateFilters();this.initInfoTemplate();this.initChartToolbar();this.initChartStatTypes();this.initChartFilters();this.initChartPanel();this.initChart();this.initImagePanel();this.initUserOverview()},initInfoTemplate:function(){this.infoTemplate=new Ext.XTemplate('<div class="name">',"{name} | {team_name}","</div>",'<div class="branch">',"{branch_name}","</div>",'<div class="image">','<img src="{image}" />',"</div>")},initLeftPanel:function(){this.leftPanel=new Ext.panel.Panel({scope:this,unstyled:true,border:false,width:210,margin:"0 10 0 0"});this.items.push(this.leftPanel)},initCenterPanel:function(){this.centerPanel=new Ext.panel.Panel({scope:this,unstyled:true,border:false,columnWidth:1});this.items.push(this.centerPanel)},initFilterPanel:function(){this.filterPanel=new Ext.panel.Panel({scope:this,title:"Filter",layout:"hbox",collapsed:true,collapsible:true,titleCollapse:true,autoHeight:true,defaults:{margin:2,flex:1}});this.centerPanel.add(this.filterPanel)},initUserSelect:function(){var a=location.href.split("?");var b={};if(a.length){b=Ext.Object.fromQueryString(a[1])}console.log(b);this.userStore=new Ext.data.Store({fields:["id","name","image"],proxy:{type:"ajax",url:this.userProcessingPage+"list",reader:{type:"json",root:"records"}}});this.userSelect=new Ext.ux.form.field.RealComboBox({value:b.id,displayField:"name",fieldLabel:"User",labelWidth:50,emptyText:"Search by name...",typeAhead:false,pageSize:10,minChars:0,listConfig:{loadingText:"Searching...",emptyText:"No users were found.",getInnerTpl:function(){return'<div class="mypage-user-list-item"><div class="image"><img src="{image}" /></div><div class="name">{name}</div><div class="clear"></div></div>'}},store:this.userStore});this.userSelect.on("select",function(f,d,e){if(!d.length){return false}var c=d[0];this.updateFilter({userId:c.get("id")})},this);this.filterPanel.add(this.userSelect)},initDateFilters:function(){this.startDate=new Ext.form.field.Date({fieldLabel:"Start Date",labelWidth:70,emptyText:"Select start date..."});this.startDate.on("select",function(e,d){if(this.stopDate.getValue()==null){var c=new Date(d);c.setDate(c.getDate()+7);this.stopDate.setValue(Ext.Date.format(c,"n/j/Y"))}else{var b=new Date(d);var a=new Date(this.stopDate.getValue());if(b>=a){b.setDate(b.getDate()+7);this.stopDate.setValue(Ext.Date.format(b,"n/j/Y"))}}this.updateFilter({startDate:this.startDate.getValue(),stopDate:this.stopDate.getValue()})},this);this.stopDate=new Ext.form.field.Date({fieldLabel:"End Date",labelWidth:70,emptyText:"Select stop date..."});this.stopDate.on("select",function(e,d){if(this.startDate.getValue()==null){var c=new Date(d);c.setDate(c.getDate()-7);this.startDate.setValue(Ext.Date.format(c,"n/j/Y"))}else{var b=new Date(this.startDate.getValue());var a=new Date(d);if(a<=b){a.setDate(a.getDate()-7);this.startDate.setValue(Ext.Date.format(a,"n/j/Y"))}}this.updateFilter({startDate:this.startDate.getValue(),stopDate:this.stopDate.getValue()})},this);this.filterPanel.add(this.startDate,this.stopDate)},initChartToolbar:function(){this.chartToolbar=new Ext.toolbar.Toolbar({scope:this,items:[]})},initChartFilters:function(){this.refreshButton=new Ext.button.Button({scope:this,text:"Refresh",icon:"/resources/icons/refresh-16.png",handler:function(){this.chart.store.load()}});this.chartToolbar.add("->",this.refreshButton)},initChartStatTypes:function(){var b=new Ext.menu.Menu({scope:this});var a=new Ext.button.Button({scope:this,text:"Stat Type (Points)",icon:"/resources/icons/bar-chart-16.png",menu:b});Ext.each(TMS.mypage.Util.getStatTypes(),function(d){var c=new Ext.menu.Item({scope:this,text:d.title,chart:this.chart,panel:this,type:d,parentMenu:b,parentMenuButton:a,handler:function(e){e.parentMenuButton.setText("Stat Type ("+e.text+")");e.panel.doComponentLayout();this.chart.store.proxy.extraParams.type=e.type.field;this.chart.store.proxy.extraParams.typeName=e.type.title;this.chart.store.loadPage(1)}});b.add(c)},this);this.chartToolbar.add(a)},initChartPanel:function(){this.chartPanel=new Ext.panel.Panel({layout:"fit",height:250,margin:"10 0 0 0",tbar:this.chartToolbar});this.centerPanel.add(this.chartPanel)},initChart:function(){this.chart=Ext.create("TMS.mypage.charts.Stats",{});this.chartPanel.on("afterrender",function(){this.chart.setWidth(this.chartPanel.getWidth());this.chart.setHeight(this.chartHeight);this.chartPanel.add(this.chart);this.doLayout();this.chart.store.load()},this)},initImagePanel:function(){this.imagePanel=new Ext.container.Container({scope:this,cls:"mypage-user-info",unstyled:true,border:false,autoHeight:true});this.chart.store.on("load",function(){this.imagePanel.update(this.infoTemplate.apply(this.chart.store.getProxy().getReader().rawData.user));this.leftPanel.doLayout()},this);this.leftPanel.add(this.imagePanel)},initUserOverview:function(){this.userOverviewPanel=new Ext.panel.Panel({scope:this,border:false,margin:"10 0 0 0"});this.centerPanel.add(this.userOverviewPanel);this.userOverview=Ext.create("TMS.mypage.user.Overview");this.userOverviewPanel.add(this.userOverview);this.userOverview.store.on("load",function(){this.userOverviewPanel.doLayout()},this);this.userOverview.on("afterrender",function(){this.userOverview.store.load()},this)}});Ext.define("TMS.mypage.Util",{extend:"Ext.util.Observable",singleton:true,statTypes:false,utilProcessingPage:"/at-ajax/modules/stats/util/",getStatTypes:function(){if(!this.statTypes){Ext.Ajax.request({scope:this,async:false,url:this.utilProcessingPage+"stat-types",success:function(b){var a=Ext.JSON.decode(b.responseText);this.statTypes=a.records}})}return this.statTypes}});Ext.define("TMS.orders.filter.Order",{extend:"TMS.filter.Abstract",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initStatus();this.initCustomer();this.initOwner();this.initCarrier();this.initBOL();this.initPro();this.initCustomerReference()},initStatus:function(){this.statusTypeStore=Ext.create("Ext.data.Store",{fields:["status_id","status_name"],proxy:{type:"ajax",url:"/at-ajax/modules/tools/status-types/get-filter-list",reader:{type:"json",root:"records"}}});this.statusTypeStore.load();this.items.push({xtype:"realcombobox",queryMode:"local",name:"status",displayField:"status_name",valueField:"status_id",fieldLabel:"Status",store:this.statusTypeStore})},initCustomer:function(){this.items.push({name:"company",fieldLabel:"Customer"})},initOrderedBy:function(){this.items.push({name:"ordered_by",fieldLabel:"Ordered By"})},initBillTo:function(){this.items.push({name:"bill_to",fieldLabel:"Bill To"})},initOwner:function(){this.items.push({name:"owner",fieldLabel:"Owner"})},initCarrier:function(){this.items.push({name:"carrier",fieldLabel:"Carrier"})},initBOL:function(){this.items.push({name:"bolNumber",fieldLabel:"BOL #"})},initPro:function(){this.items.push({name:"proNumber",fieldLabel:"Pro #"})},initCustomerReference:function(){this.items.push({name:"customerReference",fieldLabel:"Customer Reference #"})},initOrigin:function(){this.items.push({name:"origin",fieldLabel:" Origin"})},initDestination:function(){this.items.push({name:"destination",fieldLabel:" Destination"})}});Ext.define("TMS.orders.filter.PreOrder",{extend:"TMS.filter.Abstract",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initCustomer();this.initOwner();this.initBOL();this.initPro();this.initCustomerReference()},initCustomer:function(){this.items.push({name:"company",fieldLabel:"Customer"})},initOwner:function(){this.items.push({name:"owner",fieldLabel:"Owner"})},initCarrier:function(){this.items.push({name:"carrier",fieldLabel:"Carrier"})},initBOL:function(){this.items.push({name:"bolNumber",fieldLabel:"BOL #"})},initPro:function(){this.items.push({name:"proNumber",fieldLabel:"Pro #"})},initCustomerReference:function(){this.items.push({name:"customerReference",fieldLabel:"Customer Reference #"})}});Ext.define("TMS.orders.forms.sections.Accessorial",{extend:"Ext.form.Panel",requires:["Ext.ux.form.field.RealComboBox","TMS.customer.lookup.Customer"],title:"New Accessorial",baseTitle:"New Accessorial",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/order/accessorial/",accessorial_id:0,margin:8,layout:"anchor",data:{},autoSave:false,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.tools=this.tools||[];this.init();this.callParent(arguments)},init:function(){this.initCustomTools();this.initSelector();this.initAmount();this.initQuantity();this.initCheckbox();this.initBillToSelector();this.initHidden();this.initListeners()},initCustomTools:function(){this.closeButton=Ext.create("Ext.panel.Tool",{scope:this,type:"close",tooltip:"Remove",handler:function(c,b,a){this.destroy()}});this.tools.push(this.closeButton)},initSelector:function(){this.typeSelector=Ext.create("Ext.ux.form.field.RealComboBox",{store:this.store,valueField:"AccCodeID",displayField:"AccCodeDesc",queryMode:"local",hiddenName:"accessorial_id[]",fieldLabel:"Type"});this.items.push(this.typeSelector)},initAmount:function(){this.amount=Ext.create("Ext.form.field.Text",{fieldLabel:"Amount",name:"amount"});this.items.push(this.amount)},initQuantity:function(){this.quantity=Ext.create("Ext.form.field.Text",{fieldLabel:"Quantity",name:"quantity"});this.items.push(this.quantity)},initCheckbox:function(){this.billToCheckbox=Ext.create("Ext.form.field.Checkbox",{fieldLabel:"Bill separately",name:"billSeparately[]",hiddenName:"billSeparately[]"});this.items.push(this.billToCheckbox)},initBillToSelector:function(){this.billToSelector=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Bill To",name:"accessorial_bill_to_id",hiddenName:"accessorial_bill_to_id",hidden:true,value:0});this.items.push(this.billToSelector)},initHidden:function(){this.accessorialId=Ext.create("Ext.form.field.Hidden",{name:"accessorialId",value:0});this.items.push(this.accessorialId)},initListeners:function(){this.typeSelector.on("select",function(a,c){var b=a.getRawValue();this.baseTitle=b;this.updateTitle()},this);this.amount.on("change",this.updateTotal,this);this.quantity.on("change",this.updateTotal,this);this.billToCheckbox.on("change",function(a){if(a.checked){this.billToSelector.show();this.billToSelector.setRawValue("");this.billToSelector.setValue(0)}else{this.billToSelector.hide()}},this);this.on("afterrender",this.loadInitialData,this)},loadInitialData:function(){if(this.data.accessorial_type_id!=null){this.typeSelector.setValue(this.data.accessorial_type_id);this.typeSelector.setRawValue(this.data.accessorial_type_name);this.amount.setValue(this.data.accessorial_per_unit);this.quantity.setValue(this.data.accessorial_qty);if(!this.data.bill_to||this.data.bill_to_id==this.data.bill_to){this.billToCheckbox.setValue(false)}else{this.billToCheckbox.setValue(true)}this.billToSelector.setValue(this.data.bill_to);this.billToSelector.setRawValue(this.data.bill_to_name);this.accessorialId.setValue(this.data.order_accessorial_id);this.updateTotal()}},updateTotal:function(){clearTimeout(this.updateTotalTimeout);this.updateTotalTimeout=setTimeout(Ext.bind(function(){this.updateTitle();this.fireEvent("updatetotal")},this),1000)},updateTitle:function(){if(this.rendered){this.baseTitle=this.typeSelector.getRawValue()}else{this.baseTitle=this.data.accessorial_type_name}this.setTitle(this.baseTitle+" $"+this.getTotal())},getTotal:function(){var a=0;if(this.rendered){a=this.amount.getValue()*this.quantity.getValue()}else{a=this.data.accessorial_per_unit*this.data.accessorial_qty}if(isNaN(a)){a=0}a=a.toFixed(2);return parseFloat(a)},getValues:function(){var a={accessorialId:this.accessorialId.getValue(),amount:this.amount.getValue(),quantity:this.quantity.getValue(),type:this.typeSelector.getValue(),billToId:this.billToSelector.getValue(),billToCheckbox:this.billToCheckbox.getValue()};return a}});Ext.define("TMS.orders.forms.sections.Accessorials",{extend:"Ext.form.Panel",requires:["Ext.ux.form.field.RealComboBox","TMS.orders.forms.sections.Accessorial"],autoScroll:true,title:"Accessorials",baseTitle:"Accessorials",processingPage:"/at-ajax/modules/order/accessorial/",order_id:0,autoSave:false,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initStore();this.initListeners()},initToolbar:function(){this.toolbar=new Ext.toolbar.Toolbar({scope:this,dock:"top",items:[{scope:this,text:"Add Accessorial",icon:"/resources/icons/add-16.png",handler:this.addAccessorial},{scope:this,text:"Collapse All",handler:this.collapseAll},{scope:this,text:"Expand All",handler:this.expandAll}]});this.dockedItems.push(this.toolbar)},initStore:function(){this.store=Ext.create("Ext.data.Store",{fields:["AccCodeID","AccCode","AccCodeDesc"],proxy:{type:"ajax",url:this.processingPage+"get-accessorial-list",reader:{type:"json",root:"records"}}});this.store.load()},initListeners:function(){},addAccessorial:function(c){if(c){if(c.length){for(var b=0;b<c.length;b++){this.addAccessorial(c[b])}return}}var a=Ext.create("TMS.orders.forms.sections.Accessorial",{store:this.store,data:c,collapsible:true,titleCollapse:true});a.on("updatetotal",this.updateTitle,this);a.on("destroy",this.updateTitle,this);this.add(a)},updateTitle:function(){this.setTitle(this.baseTitle+" $"+this.getTotal());this.fireEvent("updatetotal")},getTotal:function(){var a=this.items.items;var c=a.length;var d=0;for(var b=0;b<c;b++){d+=a[b].getTotal()}d=d.toFixed(2);return parseFloat(d)},collapseAll:function(){var a=this.items.items;var c=a.length;for(var b=0;b<c;b++){a[b].collapse()}},expandAll:function(){var a=this.items.items;var c=a.length;for(var b=0;b<c;b++){a[b].expand()}},getValues:function(){var b=this.items.items;var d=b.length;var a=[];for(var c=0;c<d;c++){a.push(b[c].getValues())}return a}});Ext.define("TMS.orders.forms.sections.Audit",{extend:"TMS.ActionWindow",requires:["TMS.orders.forms.sections.OrderDetails","TMS.documents.forms.sections.DocumentsRequired","TMS.comment.forms.sections.Form","TMS.documents.view.Grid","TMS.comment.view.Grid"],layout:"border",title:"Audit Order",processingPage:"/at-ajax/modules/order/audit/",order_id:0,widthPercent:0.9,heightPercent:0.9,init:function(){this.initTitle();this.initOrderDetails();this.initDocumentsRequired();this.initColumns();this.initCenter();this.initDocuments();this.initComments();this.initHidden();this.initButtons();this.initListeners()},initTitle:function(){if(this.title==null||!this.title.length){return}this.title+=" - #"+this.order_id},initColumns:function(){this.columns=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",align:"stretch"},region:"west",width:250,split:true,items:[this.orderDetails,this.documentsRequired],border:0,frame:false});this.items.push(this.columns)},initCenter:function(){this.centerPanel=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",align:"stretch"},region:"center",border:0,frame:false});this.items.push(this.centerPanel)},initOrderDetails:function(){this.orderDetails=Ext.create("TMS.orders.forms.sections.OrderDetails",{readOnly:true,order_id:this.order_id,flex:1,autoScroll:true})},initDocumentsRequired:function(){this.documentsRequired=Ext.create("TMS.documents.forms.sections.DocumentsRequired",{order_id:this.order_id,readOnly:true,flex:1,autoScroll:true})},initDocuments:function(){this.documentsPanel=Ext.create("TMS.documents.view.Grid",{title:"Order Documents",extraParams:{order_id:this.order_id},flex:1});this.centerPanel.add(this.documentsPanel)},initComments:function(){this.commentsPanel=Ext.create("TMS.comment.view.Grid",{title:"Order Comments",field_value:this.order_id,type:"order",flex:1});this.centerPanel.add(this.commentsPanel)},initHidden:function(){this.orderIdField=Ext.create("Ext.form.field.Hidden",{name:"orderId",value:0});this.items.push(this.orderIdField)},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Approve",handler:this.approve,scale:"medium",icon:"/resources/icons/check-24.gif"});this.denyButton=Ext.create("Ext.button.Button",{scope:this,text:"Deny",handler:this.deny,scale:"medium",icon:"/resources/icons/close-24.png"});this.addTopButton([this.approveButton,this.denyButton])},approve:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"approve",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},deny:function(){this.formPanel=Ext.create("TMS.comment.forms.sections.Form",{field_value:this.order_id,commentType:"order"});this.formWindow=Ext.create("Ext.window.Window",{title:"Enter a reason",autoShow:true,modal:true,resizable:false,draggable:false,width:400,items:[this.formPanel]});this.formPanel.on("formsuccess",function(){this.formWindow.close();this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"deny",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},this)},initListeners:function(){this.orderDetails.on("dataload",function(){this.center()},this);this.documentsRequired.on("dataload",function(){this.center()},this)}});Ext.define("TMS.orders.forms.sections.AuditCorrection",{extend:"TMS.ActionWindow",requires:["TMS.orders.forms.sections.OrderDetails","TMS.documents.forms.sections.DocumentsRequired","TMS.documents.view.Grid"],layout:"fit",title:"Fix Order Details",processingPage:"/at-ajax/modules/order/audit/",order_id:0,widthPercent:0.9,heightPercent:0.9,init:function(){this.initTabPanel();this.initAuditPanel();this.initOrderPanel();this.initColumns();this.initCenterPanel();this.initOrderDetails();this.initDocumentsRequired();this.initDocuments();this.initComments();this.initButtons();this.initListeners()},initTabPanel:function(){this.tabPanel=new Ext.tab.Panel({scope:this,border:false,deferredRender:true});this.items.push(this.tabPanel);this.tabPanel.on("afterrender",function(){this.tabPanel.setActiveTab(0)},this)},initAuditPanel:function(){this.auditPanel=new Ext.panel.Panel({title:"Audit Order",border:false,layout:"border"});this.tabPanel.add(this.auditPanel)},initColumns:function(){this.columns=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",align:"stretch"},region:"west",width:250,split:true,border:false});this.auditPanel.add(this.columns)},initCenterPanel:function(){this.centerPanel=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",align:"stretch"},region:"center",border:false,frame:false});this.auditPanel.add(this.centerPanel)},initOrderPanel:function(){this.orderContainer=new Ext.panel.Panel({scope:this,layout:"fit",title:"Order",border:false});this.tabPanel.add(this.orderContainer);this.orderContainer.on("afterrender",function(){this.order=Ext.create("TMS.orders.forms.Order",{orderId:this.order_id});this.orderContainer.add(this.order)},this)},initOrderDetails:function(){this.orderDetails=Ext.create("TMS.orders.forms.sections.OrderDetails",{order_id:this.order_id,readOnly:true,flex:1});this.columns.add(this.orderDetails)},initDocumentsRequired:function(){this.documentsRequired=Ext.create("TMS.documents.forms.sections.DocumentsRequired",{order_id:this.order_id,readOnly:true,flex:1});this.columns.add(this.documentsRequired)},initDocuments:function(){this.documentsPanel=Ext.create("TMS.documents.view.Grid",{extraParams:{order_id:this.order_id},flex:1,title:"Documents"});this.centerPanel.add(this.documentsPanel)},initComments:function(){this.commentsPanel=Ext.create("TMS.comment.view.Grid",{title:"Order Comments",field_value:this.order_id,type:"order",flex:1});this.centerPanel.add(this.commentsPanel)},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Mark as Corrected",handler:this.approve,scale:"medium",icon:"/resources/icons/check-24.gif"});this.addTopButton([this.approveButton])},approve:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"fix-order-details",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},initListeners:function(){this.orderDetails.on("dataload",function(){this.center()},this);this.documentsRequired.on("dataload",function(){this.center()},this)}});Ext.define("TMS.orders.forms.sections.Carrier",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.carrier.lookup.Carrier","TMS.contacts.lookup.Contact","TMS.carrier.view.RadiusGrid"],originalValues:false,order_id:0,url:"/at-ajax/modules/order/process/set-carrier",processingPage:"/at-ajax/modules/carrier/process/",autoSave:false,layout:{type:"vbox",align:"stretch"},border:false,initComponent:function(){this.items=[];this.originalValues=false;this.init();this.callParent(arguments)},init:function(){this.initFieldContainer();this.initGrid();this.initCarrierSearch();this.initContactLookup();this.initUsedEquip();this.initListeners();this.loadData()},initFieldContainer:function(){this.fieldContainer=new Ext.panel.Panel({scope:this,layout:"anchor",bodyPadding:10});this.items.push(this.fieldContainer)},initGrid:function(){this.grid=Ext.create("TMS.carrier.view.RadiusGrid",{scope:this,title:"Radius Search",order_id:this.order_id,flex:1});this.items.push(this.grid);this.grid.grid.on("itemclick",function(b,a){this.carrier_search.loadFromStore({carrier_id:a.get("carrier_id")})},this)},initCarrierSearch:function(){this.carrier_search=Ext.create("TMS.carrier.lookup.Carrier",{fieldLabel:"Carrier Search",name:"carrier_id",hiddenName:"carrier_id"});this.carrier_search.on("select",function(b,a){if(a.length){var c=a[0].data;this.contactLookup.setParam("carrier_id",c.carrier_id);this.contactLookup.setReadOnly(false);this.contactLookup.enable();this.contactLookup.store.load();this.contactLookup.setRawValue("");this.contactLookup.setValue(0);this.contactLookup.focus(true,50)}else{this.contactLookup.setReadOnly(true);this.contactLookup.disable()}},this);this.fieldContainer.add(this.carrier_search)},initContactLookup:function(){this.contactLookup=Ext.create("TMS.contacts.lookup.Contact",{type:"carrier",fieldLabel:"Select Carrier Contact",name:"carrier_contact_id"});this.fieldContainer.add(this.contactLookup)},initUsedEquip:function(){var a=[];this.availableEquipStore=Ext.create("Ext.data.ArrayStore",{fields:["id","name"],data:a});this.usedEquip=Ext.create("Ext.ux.form.field.RealComboBox",{fieldLabel:"Select Equipment",store:this.availableEquipStore,displayField:"name",valueField:"id",readOnly:(a.length>1?false:true),editable:false,name:"used_equipment_id",hiddenName:"used_equipment_id"});this.fieldContainer.add(this.usedEquip)},makeNewStore:function(a){this.availableEquipStore=Ext.create("Ext.data.ArrayStore",{fields:["id","name"],data:a});this.usedEquip.store=this.availableEquipStore;this.availableEquipStore.load();if(a.length==1){this.usedEquip.setValue(a[0][0])}},initListeners:function(){this.carrier_search.on("select",this.save,this);this.contactLookup.on("select",this.save,this);this.usedEquip.on("select",this.save,this);this.on("beforesubmit",function(){this.setParam("order_id",this.order_id)},this)},loadData:function(){if(this.order_id){this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-order-info",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);var c=[];Ext.each(a.equipment_list,function(f){var e=[f.equipment_id,f.name];c.push(e)});this.makeNewStore(c);this.carrier_search.setValue(a.carrier_id);this.carrier_search.setRawValue(a.carrier_name);this.contactLookup.setValue(a.contact_id);this.contactLookup.setRawValue(a.contact_name);this.contactLookup.setParam("carrier_id",a.carrier_id);if(a.carrier_id>0){this.contactLookup.store.load();this.contactLookup.setReadOnly(false);this.contactLookup.enable()}else{this.contactLookup.setReadOnly(true);this.contactLookup.disable()}if(a.equipment_id){this.usedEquip.setValue(a.equipment_id)}}})}},save:function(){var a=this.getValues();a.order_id=this.order_id;if(this.autoSave&&a.order_id){this.submit()}}});Ext.define("TMS.orders.forms.sections.Charge",{extend:"TMS.form.Abstract",requires:["TMS.orders.forms.sections.Accessorials"],layout:"fit",processingPage:"/at-ajax/modules/order/revenue/",itemized:true,loadByKey:"order_id",order_id:0,initComponent:function(){this.baseTitle=this.title;this.items=[];this.init();this.callParent(arguments)},init:function(){this.initTabPanel();this.initFieldContainer();this.initAccessorials();this.initLinehaul();this.initFuel();this.initListeners();this.loadData(this[this.loadByKey])},initTabPanel:function(){this.tabPanel=new Ext.tab.Panel({scope:this,activeTab:0});this.items.push(this.tabPanel);this.tabPanel.on("afterrender",function(){this.tabPanel.setActiveTab(0)},this)},initFieldContainer:function(){this.fieldContainer=new Ext.panel.Panel({scope:this,title:"Charges",bodyStyle:{padding:"8px"}});this.tabPanel.add(this.fieldContainer)},initLinehaul:function(){this.linehaul=Ext.create("Ext.form.Text",{fieldLabel:"Linehaul",name:"linehaul",value:"0"});this.fieldContainer.add(this.linehaul)},initFuel:function(){this.fuel=Ext.create("Ext.form.Text",{fieldLabel:"Fuel",name:"fuel",value:"0"});this.fieldContainer.add(this.fuel)},initAccessorials:function(){if(this.itemized){this.accessorials=Ext.create("TMS.orders.forms.sections.Accessorials",{title:"Accessorials"})}else{this.accessorials=Ext.create("Ext.form.Text",{fieldLabel:"Accessorial Charge",name:"accessorialCharge",value:"0"})}this.tabPanel.add(this.accessorials)},initListeners:function(){this.linehaul.on("change",this.updateTitle,this);this.fuel.on("change",this.updateTitle,this);if(this.itemized){this.accessorials.on("updatetotal",this.updateTitle,this)}else{this.accessorials.on("change",this.updateTitle,this)}},updateTitle:function(){this.setTitle(this.baseTitle+" $"+this.getTotal());this.fireEvent("updatetotal")},getTotal:function(){var a=0;if(!isNaN(parseFloat(this.linehaul.getValue()))){a+=parseFloat(this.linehaul.getValue())}if(!isNaN(parseFloat(this.fuel.getValue()))){a+=parseFloat(this.fuel.getValue())}if(this.itemized){a+=this.accessorials.getTotal()}else{if(!isNaN(parseFloat(this.accessorials.getValue()))){a+=parseFloat(this.accessorials.getValue())}}a=a.toFixed(2);return parseFloat(a)},getValues:function(){var a=0;if(this.itemized){a=this.accessorials.getValues()}else{a=this.accessorials.getValue()}var b={linehaul:this.linehaul.getValue(),fuel:this.fuel.getValue(),accessorials:a};return b},loadData:function(a){this[this.loadByKey]=a;var b={};b[this.loadByKey]=this[this.loadByKey];if(this[this.loadByKey]){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-charge-information",params:b,success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText);this.record=c.record;this.setData()}})}},setData:function(){if(this.record.linehaul_charge!=null){this.linehaul.setValue(this.record.linehaul_charge)}if(this.record.fuel_charge!=null){this.fuel.setValue(this.record.fuel_charge)}if(this.record.accessorialCharges&&this.record.accessorialCharges.length){this.accessorials.addAccessorial(this.record.accessorialCharges);this.accessorials.collapseAll()}}});Ext.define("TMS.orders.forms.sections.Collected",{extend:"TMS.ActionWindow",title:"Collection Call",processingPage:"/at-ajax/modules/order/audit/",order_id:0,width:900,autoSize:false,init:function(){this.initHidden();this.initButtons();this.initListeners()},initHidden:function(){this.orderIdField=Ext.create("Ext.form.field.Hidden",{name:"orderId",value:0});this.items.push(this.orderIdField)},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Mark as Complete",handler:this.complete,scale:"medium"});this.viewButton=Ext.create("Ext.button.Button",{scope:this,text:"View Full Order",handler:this.viewOrder,scale:"medium"});this.addTopButton([this.approveButton,this.viewButton])},complete:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"mark-as-collected",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},viewOrder:function(){location.href="/orders/?d=orders&a=show&id="+this.order_id},initListeners:function(){}});Ext.define("TMS.orders.forms.sections.CustomerInformation",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.customer.lookup.Customer","TMS.contacts.lookup.Contact","TMS.location.forms.sections.BillTo"],title:"Customer Information",baseTitle:"Customer Information",processingPage:"/at-ajax/modules/order/process/",url:"/at-ajax/modules/order/process/",loadByKey:"order_id",order_id:0,autoSave:false,bodyPadding:10,layout:"anchor",initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCustomer();this.initContact();this.initBillTo();this.initListeners();this.loadData(this[this.loadByKey])},initCustomer:function(){this.customerSelector=Ext.create("TMS.customer.lookup.Customer",{fieldLabel:"Customer",name:"customer_id",hiddenName:"customer_id"});this.items.push(this.customerSelector)},initContact:function(){this.contactSelector=Ext.create("TMS.contacts.lookup.Contact",{fieldLabel:"Ordered By",name:"ordered_by_id",hiddenName:"ordered_by_id"});this.items.push(this.contactSelector)},initBillTo:function(){this.billToPanel=Ext.create("TMS.location.forms.sections.BillTo",{fieldLabel:"Bill To"});this.items.push(this.billToPanel)},initListeners:function(){this.customerSelector.on("select",function(c,b){if(!b.length){this.contactSelector.disable();return false}this.contactSelector.enable();var a=b[0];this.contactSelector.setRawValue("");this.contactSelector.setValue(0);this.contactSelector.store.proxy.url=this.processingPage+"get-customer-hot-contacts";this.contactSelector.store.proxy.extraParams.customer_id=a.get("customer_id");this.contactSelector.store.proxy.extraParams.status="hot";this.contactSelector.store.loadPage(1);this.contactSelector.focus(true,50);this.contactSelector.expand();this.billToPanel.lookupCustomer(this.customerSelector.getValue())},this);this.contactSelector.on("select",function(b,a){this.billToPanel.lookupContact(this.contactSelector.getValue())},this)},loadData:function(a){this[this.loadByKey]=parseInt(a);var b={};b[this.loadByKey]=this[this.loadByKey];if(this[this.loadByKey]){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-customer-information",params:b,success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText);this.record=c.record;this.setData()}})}},setData:function(){var a;if(this.record.customer_id){a=this.customerSelector.store.add({customer_id:this.record.customer_id,customer_name:this.record.customer_name});this.customerSelector.select(a[0]);this.billToPanel.filterByCustomer(this.record.customer_id)}if(this.record.contact_id){a=this.contactSelector.store.add({contact_id:this.record.contact_id,name:this.record.contact_name});this.contactSelector.select(a[0])}if(this.record.bill_to_location_id){this.billToPanel.setRecord(this.record)}},save:function(){if(this.autoSave&&this[this.loadByKey]){var a={contact_id:this.contact_id,name:this.down("#name").getValue(),title:this.down("#title").getValue(),status_id:this.down("#status_id").getValue()};Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"save-contact",params:a,success:function(c){var b=Ext.decode(c.responseText)}})}}});Ext.define("TMS.orders.forms.sections.Details",{extend:"Ext.panel.Panel",requires:["Ext.ux.form.field.RealComboBox"],processingPage:"/at-ajax/modules/tools/detail-types/",initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initStore();this.on("afterrender",function(){this.detailStore.on("load",function(){var a=this.createRow();this.add(a);this.selectFirst(a.down("realcombobox"))},this,{single:true});this.detailStore.load()},this)},initListeners:function(){this.on("add",this.itemAdded,this);this.on("remove",this.itemRemoved,this)},initStore:function(){this.detailStore=Ext.create("Ext.data.Store",{fields:["detail_type_id","detail_type_name",],proxy:{type:"ajax",url:this.processingPage+"list",reader:{type:"json",root:"records"}}})},selectFirst:function(a){a.setValue(a.store.getAt(0).get("detail_type_id"))},getFirstUnusedIndex:function(j){var c=0;var f=[];var h=this.items.items;for(var g=0;g<h.length-1;g++){var b=h[g].items.items[0];var a=b.getValue();f.push(a)}var e=j.store.data.items;var d=e.length;for(var g=0;g<d;g++){if(f.indexOf(e[g].data.detail_type_id)==-1){c=g;break}}return c},selectFirstUnused:function(b){if(b&&b.store){var a=b.store.getAt(this.getFirstUnusedIndex(b));b.setValue(a.get("detail_type_id"))}},setValues:function(a){if(!a.length){return false}if(!this.rendered){this.on("afterrender",function(b,c){this.setValues(c.records)},this,{records:a});return false}this.setLoading(true);this.removeAll();Ext.each(a,function(b){var f=this.createRow();this.add(f);var d=f.down("#detail_type_id");var e=f.down("#detail_value");var c=f.down("#detail_id");if(!d.isStoreLoaded){this.detailStore.on("load",function(j,i,h,k){var l=k.type;var g=k.record;l.select(this.detailStore.getAt(this.detailStore.find("detail_type_id",g.detail_type_id)))},this,{record:b,type:d})}else{d.select(this.detailStore.getAt(this.detailStore.find("detail_type_id",b.detail_type_id)))}e.setValue(b.detail_value);c.setValue(b.detail_id)},this);this.setLoading(false)},getValues:function(){var a=this.query("#detail_type_id");var j=this.query("#detail_value");var g=this.query("#detail_id");var c=[];for(var e=0;e<a.length;e++){var b=a[e].getValue();var d=g[e].getValue();var h=j[e].getValue();var f={detail_id:d,detail_type_id:b,detail_value:h};if(h.length){c.push(f)}}return c},getCount:function(){return this.items.items.length},createRow:function(){var a=Ext.create("Ext.panel.Panel",{layout:"hbox",border:false,defaults:{border:false},items:[{flex:1,xtype:"realcombobox",valueField:"detail_type_id",displayField:"detail_type_name",store:this.detailStore,queryMode:"local",editable:false,margin:"2",itemId:"detail_type_id",name:"detail_type_id[]"},{flex:1,xtype:"textfield",enforceMaxLength:true,maxLength:100,name:"detail_value[]",margin:"2",itemId:"detail_value",enableKeyEvents:true,listeners:{scope:this,keyup:function(e){if(e.getValue().length){var b=this.query("#detail_value");var d=b[b.length-1];if(d.getValue().length){var c=this.createRow();this.add(c);this.selectFirstUnused(c.down("realcombobox"))}}},blur:function(d){if(!d.getValue().length){var b=this.query("#detail_value");var c=b[b.length-1];if(d!=c){d.ownerCt.destroy()}}}}},{xtype:"hiddenfield",name:"detail_id",itemId:"detail_id",value:0},{xtype:"button",margin:"2",icon:"/resources/icons/delete-16.png",width:24,scope:this,handler:function(b){b.ownerCt.destroy()}}]});return a},itemAdded:function(a,c,b){var d=this.query("> .panel");this.manageRemoveButtons(d)},itemRemoved:function(a,c,b){var d=this.query("> .panel");if(d.length){this.manageRemoveButtons(d)}},manageRemoveButtons:function(b){for(var a=0;a<b.length-1;a++){b[a].down(".button").enable()}b[b.length-1].down(".button").disable()}});Ext.define("TMS.orders.forms.sections.Goods",{extend:"Ext.form.Panel",title:"Goods",baseTitle:"Goods",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/order/goods/",loadByKey:"order_id",order_id:0,autoSave:false,initComponent:function(){this.baseTitle=this.title;this.items=[];this.init();this.callParent(arguments)},init:function(){this.initWeight();this.initDescription();this.initListeners();this.loadData(this[this.loadByKey])},initWeight:function(){this.weight=Ext.create("Ext.form.Text",{fieldLabel:"Load Weight (in lbs)",labelAlign:"top",name:"load_weight",value:"0"});this.items.push(this.weight)},initDescription:function(){this.description=Ext.create("Ext.form.TextArea",{grow:true,name:"goods_desc",fieldLabel:"Load Description",labelAlign:"top",anchor:"100%",value:"",width:450,hidden:true});this.items.push(this.description)},initListeners:function(){},loadData:function(a){this[this.loadByKey]=a;var b={};b[this.loadByKey]=this[this.loadByKey];if(this[this.loadByKey]){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get",params:b,success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText);this.record=c.record;this.setData(c.record)}})}},setData:function(a){this.weight.setValue(a.weight);this.description.setValue(a.desc)}});Ext.define("TMS.orders.forms.sections.Invoice",{extend:"TMS.ActionWindow",requires:["TMS.documents.view.Interface"],title:"Send Invoice",processingPage:"/at-ajax/modules/order/audit/",order_id:0,widthPercent:0.9,heightPercent:0.9,init:function(){this.initBillToDetails();this.initDocuments();this.initHidden();this.initButtons();this.initListeners()},initBillToDetails:function(){this.billToDetails=Ext.create("Ext.panel.Panel",{});this.items.push(this.billToDetails)},initDocuments:function(){this.documentsPanel=Ext.create("TMS.documents.view.Interface",{extraParams:{order_id:this.order_id},height:300,collapsible:false});this.items.push(this.documentsPanel)},initHidden:function(){this.orderIdField=Ext.create("Ext.form.field.Hidden",{name:"orderId",value:0});this.items.push(this.orderIdField)},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Mark as Complete",handler:this.complete,scale:"medium"});this.viewButton=Ext.create("Ext.button.Button",{scope:this,text:"View Full Order",handler:this.viewOrder,scale:"medium"});this.addTopButton([this.approveButton,this.viewButton])},complete:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"complete-invoice",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},viewOrder:function(){location.href="/orders/?d=orders&a=show&id="+this.order_id},initListeners:function(){}});Ext.define("TMS.orders.forms.sections.Load",{extend:"Ext.panel.Panel",requires:["TMS.carrier.lookup.Carrier"],layout:"anchor",bodyPadding:5,origin:{index:0,location_id:0,location_name:"",city:"",state:"",address_1:"",zip:""},destination:{index:1,location_id:0,location_name:"",city:"",state:"",address_1:"",zip:""},initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCarrier();this.on("afterrender",function(){this.updateTitle()},this)},initCarrier:function(){this.carrier=Ext.create("TMS.carrier.lookup.Carrier",{hiddenName:"carrier_id",fieldLabel:"Carrier",value:0});this.items.push(this.carrier)},setOrigin:function(a){Ext.apply(this.origin,a);this.updateTitle()},setDestination:function(a){Ext.apply(this.destination,a);this.updateTitle()},updateTitle:function(){var a=this.origin.location_name_1;var b=this.destination.location_name_1;if(!this.origin.location_id){a="No Location Selected"}if(!this.destination.location_id){b="No Location Selected"}this.setTitle(a+" &raquo; "+b)}});Ext.define("TMS.orders.forms.sections.Loads",{extend:"Ext.panel.Panel",requires:["TMS.orders.forms.sections.Stops","TMS.orders.forms.sections.Load"],initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initStops();this.initLoadsPanel()},initStops:function(){this.stops=Ext.create("TMS.orders.forms.sections.Stops",{height:300,order_id:505});this.items.push(this.stops);this.stops.on("set",function(a,b){this.setValues(b)},this)},initLoadsPanel:function(){this.loadsPanel=new Ext.panel.Panel({scope:this,title:"Loads"});this.items.push(this.loadsPanel);this.stops.on("addstop",function(){this.setValues(this.stops.getValues())},this);this.stops.on("removestop",function(){this.setValues(this.stops.getValues())},this);this.stops.on("reorder",function(b,a){this.setValues(this.stops.getValues())},this);this.stops.on("locationchange",function(b,a){this.setValues(this.stops.getValues())},this)},setValues:function(b){if(b.length<=1){return}var a=this.getLoadPanels();Ext.each(b,function(d,c){if(c==b.length-1){return}var e=a[c];if(e==null){this.addLoad(d,b[c+1])}else{e.setOrigin(d);e.setDestination(b[c+1])}},this);Ext.each(a,function(d,c){if(b[c+1]==null){d.destroy()}},this)},addLoad:function(b,a){var c=Ext.create("TMS.orders.forms.sections.Load",{scope:this,margin:10,origin:b,destination:a});this.loadsPanel.add(c)},getLoadPanels:function(){return this.loadsPanel.items.items}});Ext.define("TMS.orders.forms.sections.OrderDetailRow",{extend:"Ext.panel.Panel",layout:"hbox",border:false,defaults:{border:false},store:false,readOnly:false,initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initDetailType();this.initDetailValue();this.initButton()},initDetailType:function(){var a={};if(this.readOnly){Ext.apply(a,{hideTrigger:true,readOnly:true})}this.detailType=Ext.create("Ext.ux.form.field.RealComboBox",Ext.apply({scope:this,flex:1,valueField:"detail_type_id",displayField:"detail_type_name",store:this.store,queryMode:"local",editable:false,margin:"2",hiddenName:"order_detail_type_id[]"},a));this.items.push(this.detailType)},initDetailValue:function(){var a={};if(this.readOnly){Ext.apply(a,{readOnly:true})}this.detailValue=Ext.create("Ext.form.field.Text",Ext.apply({scope:this,itemId:"detail_value",flex:1,margin:"2",enableKeyEvents:true,name:"order_detail_value[]"},a));this.items.push(this.detailValue)},initButton:function(){var a={};if(this.readOnly){Ext.apply(a,{hidden:true})}this.button=Ext.create("Ext.button.Button",Ext.apply({scope:this,margin:"2",icon:"/resources/icons/delete-16.png",width:24,handler:function(b){}},a));this.items.push(this.button)}});Ext.define("TMS.orders.forms.sections.OrderDetails",{extend:"TMS.form.Abstract",requires:["Ext.ux.form.field.RealComboBox","TMS.orders.forms.sections.OrderDetailRow"],title:"Order Details",baseTitle:"Order Details",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/order/process/",url:"/at-ajax/modules/order/process/save-contact-methods",loadByKey:"order_id",order_id:0,autoSave:false,readOnly:false,initComponent:function(){this.items=this.items||[];this.addEvents("dataload");this.init();this.callParent(arguments)},init:function(){this.initListeners();this.initStore();this.loadData()},initListeners:function(){this.on("add",this.itemAdded,this);this.on("remove",this.itemRemoved,this);this.on("beforesubmit",function(c){if(!this.rendered){return}var e=this.getRows();var f=e.length;var b=[];var d=[];for(var a=0;a<f;a++){b.push(e[a].detailType.getValue());d.push(e[a].detailValue.getValue());e[a].detailType.name="order_detail_type_id_"+a;e[a].detailValue.name="order_detail_value_"+a}c.setParam("order_detail_type_id",Ext.encode(b));c.setParam("order_detail_value",Ext.encode(d))},this)},initStore:function(){this.store=Ext.create("Ext.data.Store",{fields:["detail_type_id","detail_type_name"],proxy:{type:"ajax",url:this.processingPage+"get-order-details-list",reader:{type:"json",root:"records"}}});this.store.load()},getRows:function(){return this.query("> .panel")},selectFirst:function(b){if(b&&b.store){var a=b.store.getAt(0);if(a){b.setValue(a.get("detail_type_id"))}}},getFirstUnusedIndex:function(j){var c=0;var f=[];var h=this.getRows();for(var g=0;g<h.length-1;g++){var b=h[g].items.items[0];var a=b.getValue();f.push(a)}var e=j.store.data.items;var d=e.length;for(var g=0;g<d;g++){if(f.indexOf(e[g].data.detail_type_id)==-1){c=g;break}}return c},selectFirstUnused:function(b){if(b&&b.store){var a=b.store.getAt(this.getFirstUnusedIndex(b));b.setValue(a.get("detail_type_id"))}},addContactMethod:function(){},setValues:function(){},getValues:function(){var b=[];var d=[];var c=this.getRows();for(var a=0;a<c.length;a++){b.push(c[a].detailType.getValue());d.push(c[a].detailValue.getValue())}var e={"order_detail_type_id[]":b,"order_detail_value[]":d};e[this.loadByKey]=this[this.loadByKey];return e},createRow:function(){var a=Ext.create("TMS.orders.forms.sections.OrderDetailRow",{scope:this,store:this.store,readOnly:this.readOnly});a.detailValue.on("keyup",function(e){if(e.getValue().length){var b=this.query("#detail_value");var d=b[b.length-1];if(d.getValue().length){var c=this.createRow();this.add(c);this.selectFirstUnused(c.detailType)}}},this);a.detailValue.on("change",function(d){if(!d.getValue().length){var b=this.query("#detail_value");var c=b[b.length-1];if(d!=c){d.ownerCt.destroy()}}this.save()},this,{buffer:500});return a},destroyRows:function(){Ext.each(this.query("> .panel"),function(a){a.destroy()})},loadData:function(c,b){this[this.loadByKey]=c||this[this.loadByKey];var e=this.baseTitle;if(b!=null){e=this.baseTitle+" - "+b}if(this.rendered){this.setTitle(e)}else{this.title=e}if(this.store.isLoading()){this.store.on("load",function(){this.loadData()},this)}else{if(this[this.loadByKey]){this.setLoading(true);var d={};d[this.loadByKey]=this[this.loadByKey];Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-order-details-data",params:d,success:function(l){this.setLoading(false);var h=Ext.decode(l.responseText);var g=h.records;this.suspendEvents();this.destroyRows();this.resumeEvents();for(var k=0;k<g.length;k++){var f=this.createRow();f.on("afterrender",function(m,n){var i=m.detailType;var o=m.detailValue;i.setValue(n.record.detail_type_id);o.setRawValue(n.record.detail_value)},this,{record:g[k]});this.add(f)}if(!this.readOnly){var j=this.createRow();this.add(j);this.selectFirst(j.detailType)}this.fireEvent("dataload",this)}})}else{if(!this.readOnly){var a=this.createRow();this.add(a);this.selectFirst(a.detailType)}}}},itemAdded:function(a,c,b){var d=this.query("> .panel");this.manageRemoveButtons(d)},itemRemoved:function(a,c,b){var d=this.query("> .panel");if(d.length){this.manageRemoveButtons(d);this.save()}},manageRemoveButtons:function(b){if(b.length){for(var a=0;a<b.length-1;a++){b[a].down(".button").enable()}b[b.length-1].down(".button").disable()}},save:function(){if(this.autoSave&&this[this.loadByKey]){this.submit();var a=this.getValues()}}});Ext.define("TMS.orders.forms.sections.Revenue",{extend:"Ext.form.Panel",requires:["Ext.ux.form.field.RealComboBox","TMS.orders.forms.sections.Charge"],title:"Revenue",baseTitle:"Revenue",processingPage:"/at-ajax/modules/order/revenue/",order_id:0,layout:{type:"hbox",align:"stretch"},initComponent:function(){this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCharge();this.initCost();this.initProfit();this.initListeners();this.loadData(this.order_id)},initCharge:function(){this.charge=Ext.create("TMS.orders.forms.sections.Charge",{title:"Charge",flex:1});this.items.push(this.charge)},initCost:function(){this.cost=Ext.create("TMS.orders.forms.sections.Charge",{title:"Cost",flex:1});this.items.push(this.cost)},initProfit:function(){},initListeners:function(){this.charge.on("updatetotal",this.updateTitle,this);this.cost.on("updatetotal",this.updateTitle,this)},loadData:function(a){this.order_id=a;if(this.order_id){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-revenue-information",params:{order_id:this.order_id},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);this.record=b.record;if(this.record){this.setData()}}})}},setData:function(){this.charge.linehaul.setValue(this.record.linehaul_charge);this.charge.fuel.setValue(this.record.fuel_charge);this.cost.linehaul.setValue(this.record.linehaul_cost);this.cost.fuel.setValue(this.record.fuel_cost);if(this.record.accessorialCharges&&this.record.accessorialCharges.length){this.charge.accessorials.addAccessorial(this.record.accessorialCharges);this.charge.accessorials.updateTitle()}if(this.record.accessorialCosts&&this.record.accessorialCosts.length){this.cost.accessorials.addAccessorial(this.record.accessorialCosts);this.charge.accessorials.updateTitle()}},updateTitle:function(){var f=this.baseTitle;var d=this.getTotal();var b=this.charge.getTotal();var a="green";var c=0;var e="n/a";if(b>0){c=d/b;c*=100;c=c.toFixed(2);e=c+"%"}if(d<=0){a="red"}f+=' <span style="color:'+a+';"> $';f+=d;f+=" ("+e+")";f+="</span>";this.setTitle(f);this.fireEvent("updatetotal")},getTotal:function(){var a=0;a=this.charge.getTotal();a-=this.cost.getTotal();a=a.toFixed(2);return parseFloat(a)},getValues:function(){var a={charges:this.charge.getValues(),costs:this.cost.getValues()};return a}});Ext.define("TMS.orders.forms.sections.Stop",{extend:"TMS.form.Abstract",requires:["TMS.location.lookup.Location","TMS.contacts.lookup.Contact","TMS.orders.forms.sections.Details","TMS.ActionWindow","TMS.orders.forms.sections.Details","TMS.contacts.forms.sections.ContactMethods","TMS.form.plugin.StatusBar","TMS.location.forms.Form"],layout:"anchor",originalValues:false,type:"order",url:"",initComponent:function(){this.items=[];this.dockedItems=this.dockedItems||[];this.originalValues=false;this.init();this.callParent(arguments)},init:function(){this.initFieldContainer();this.initZip();this.initLocation();this.initContact();this.initDateTimeStopType();this.initDetails();this.initHidden()},initFieldContainer:function(){this.fieldContainer=new Ext.panel.Panel({scope:true,unstyled:true,border:false,bodyPadding:10,layout:"anchor",anchor:"100%"});this.items.push(this.fieldContainer)},initZip:function(){var a={};if(this.type!="preorder"){Ext.apply(a,{hidden:true})}this.zip=Ext.create("Ext.form.field.Text",Ext.apply({fieldLabel:"Zip",name:"zip",anchor:"100%",enableKeyEvents:true},a));this.zip.on("keypress",function(c,b){if(b.keyCode==13){this.fireEvent("pressedenter")}},this);this.zip.on("change",function(c,b){this.fireEvent("addresschange")},this);this.fieldContainer.add(this.zip)},initLocation:function(){this.location=Ext.create("TMS.location.lookup.Location",{name:"location_id",value:"",flex:1});this.locationAddButton=new Ext.button.Button({scope:this,margin:"0 0 0 5",icon:"/resources/icons/add-16.png",text:"Add Location",handler:this.createLocationWindow});this.locationContainer=Ext.create("Ext.form.FieldContainer",{scope:this,fieldLabel:"Location",combineErrors:true,layout:"hbox",defaults:{hideLabel:true},items:[this.location,this.locationAddButton]});this.fieldContainer.add(this.locationContainer);this.on("set",function(a,b){if(b.location_id==null||!b.location_id){return}this.location.loadFromStore({location_id:b.location_id})},this)},initContact:function(){this.contact=Ext.create("TMS.contacts.lookup.Contact",{name:"contact_id",value:0,layout:"anchor",flex:1});this.contactAddButton=new Ext.button.Button({scope:this,margin:"0 0 0 5",icon:"/resources/icons/edit-16.png",text:"Manage Contact Methods",handler:this.manageContactMethods});this.contactContainer=Ext.create("Ext.form.FieldContainer",{scope:this,disabled:true,fieldLabel:"Contact",combineErrors:true,layout:"hbox",defaults:{hideLabel:true},items:[this.contact,this.contactAddButton]});this.fieldContainer.add(this.contactContainer);this.location.on("change",function(b,a){this.contact.enable();this.contact.setParam("location_id",a)},this);this.location.on("select",function(d,b,c){if(!b.length){return}this.contact.setValue("");this.contact.setRawValue("");if(!b.length){this.contactContainer.disable();return}this.contactContainer.enable();var a=b[0];this.contact.setParam("location_id",a.get("location_id"));this.contact.store.loadPage(1);if(this.zip){this.zip.setValue(a.get("zip"))}this.fireEvent("addresschange")},this);this.on("set",function(a,b){if(b.contact_id==null||!b.contact_id){return}this.contact.loadFromStore({contact_id:b.contact_id})},this)},initDateTimeStopType:function(){this.stopTypeHidden=new Ext.form.field.Hidden({name:"stop_type",toggle:function(){if(this.getValue()=="d"){this.setValue("p")}else{this.setValue("d")}},value:"d"});this.stopTypeHidden.on("change",function(c,b,a){this.stopType.updateImage()},this);this.stopType=new Ext.panel.Panel({scope:this,width:32,height:32,unstyled:true,style:{cursor:"pointer"},stopTypeHidden:this.stopTypeHidden,pickupDetails:{img:"/resources/silk_icons/lorry_add_32.png",title:"Stop Type (Pickup)"},deliveryDetails:{img:"/resources/silk_icons/lorry_delete_32.png",title:"Stop Type (Delivery)"},updateImage:function(){var a=this.stopTypeHidden.getValue();var b;if(a=="d"){b=this.deliveryDetails}else{b=this.pickupDetails}this.update(Ext.String.format('<img src="{0}" title="{1}" />',b.img,b.title))}});this.stopType.on("afterrender",function(){this.stopType.updateImage();this.stopType.getEl().on("click",function(){this.stopTypeHidden.toggle()},this)},this);this.fieldContainer.add({xtype:"fieldcontainer",fieldLabel:"Date and Time",labelWidth:100,anchor:"100%",layout:"hbox",items:[{xtype:"datefield",name:"date",submitFormat:"n/j/Y",flex:1,margin:"0 5 0 0",value:""},{xtype:"timefield",name:"time",flex:1,margin:"0 5 0 0",value:"8:00 AM",allowBlank:false},this.stopType]});this.fieldContainer.add(this.stopTypeHidden)},initDetails:function(){this.detailsButton=new Ext.button.Button({scope:this,text:"Edit Details",baseText:"Edit Details",handler:function(){this.detailsWindow.show()}});this.fieldContainer.add({xtype:"fieldcontainer",fieldLabel:"Details",combineErrors:true,layout:"hbox",defaults:{hideLabel:true},items:[this.detailsButton]});this.detailsPanel=Ext.create("TMS.orders.forms.sections.Details",{});this.detailsPanel.on("add",function(){this.detailsButton.setText(this.detailsButton.baseText+" ("+(this.detailsPanel.getCount()-1)+")")},this);this.detailsPanel.on("remove",function(){this.detailsButton.setText(this.detailsButton.baseText+" ("+(this.detailsPanel.getCount()-1)+")")},this);this.on("set",function(a,b){if(b.details==null){return}this.detailsPanel.setValues(b.details);this.detailsButton.setText(this.detailsButton.baseText+" ("+(b.details.length)+")")},this);this.detailsWindow=Ext.create("TMS.ActionWindow",{scope:this,autoShow:false,title:"Stop Details",layout:"fit",closeAction:"hide",items:[this.detailsPanel],bottomItems:[{scope:this,text:"Save & Close",cls:"submit",handler:function(){this.detailsWindow.hide()}}]})},initDetailsPanel:function(){this.detailsPanel=Ext.create("TMS.orders.forms.sections.Details",{title:"Details",baseTitle:"Details"});this.detailsPanel.on("expand",function(){this.detailsPanel.setHeight(null);this.doLayout(true)},this);this.detailsPanel.on("collapse",function(){this.doLayout(true)},this);this.detailsPanel.on("add",function(){this.detailsPanel.setTitle(this.detailsPanel.baseTitle+" ("+(this.detailsPanel.getCount()-1)+")")},this);this.detailsPanel.on("remove",function(){this.detailsPanel.setTitle(this.detailsPanel.baseTitle+" ("+(this.detailsPanel.getCount()-1)+")")},this);this.on("set",function(a,b){if(b.details==null){return}this.detailsPanel.setValues(b.details)},this);this.items.push(this.detailsPanel)},initHidden:function(){this.fieldContainer.add({xtype:"hiddenfield",name:"stop_id",value:0})},setValues:function(a){this.callParent(arguments);if(this.originalValues==false){this.originalValues=a}this.fireEvent("set",this,a)},getValues:function(){var a=this.location.store.getAt(this.location.store.find("location_id",this.location.getValue()));if(a!=null){this.setParams(a.data)}this.setParam("details",this.detailsPanel.getValues());return this.callParent(arguments)},manageContactMethods:function(){var c=parseInt(this.contact.getValue());if(c){var a=Ext.create("TMS.contacts.forms.sections.ContactMethods",{title:"",baseTitle:"",contact_id:c,autoSave:true,plugins:[Ext.create("TMS.form.plugin.StatusBar")]});var b=Ext.create("TMS.ActionWindow",{layout:"fit",items:[a],title:this.contact.getRawValue()+" - Contact Methods"});b.showCloseButton()}},createLocationWindow:function(){this.locationForm=Ext.create("TMS.location.forms.Form",{scope:this,plugins:[Ext.create("TMS.form.plugin.StatusBar")]});this.locationForm.on("success",function(b,c){this.locationWindow.destroy();var a=c.result.record;this.location.setValue(a.location_id);this.location.loadFromStore({location_id:a.location_id})},this);this.locationForm.add({xtype:"checkboxfield",boxLabel:"This location is a Job Site",name:"job_site",inputValue:"1"});this.locationWindow=Ext.create("TMS.ActionWindow",{items:[this.locationForm],title:"Add shipping address",bottomItems:[{xtype:"button",cls:"submit",scope:this,text:"Save",handler:function(){this.locationForm.submit()}},{xtype:"button",cls:"submit",scope:this,text:"Cancel",handler:function(){this.locationWindow.destroy()}}]})}});Ext.define("TMS.orders.forms.sections.Stops",{extend:"Ext.tab.Panel",requires:["Ext.ux.GMapPanel","TMS.portal.Column","TMS.portal.Panel","TMS.orders.forms.sections.Stop"],activeItem:0,autoScroll:false,orderProcessingPage:"/at-ajax/modules/order/order/",order_id:0,pre_order_id:0,type:"order",title:"Stops",baseTitle:"Stops",initComponent:function(){this.items=[];this.addEvents("addstop","removestop","reorder","locationchange","set","get");this.init();this.callParent(arguments)},init:function(){this.initEastPanel();this.initMapPanel();this.initStopContainer();this.initMap();this.initListeners();this.initStops()},initStops:function(){if(!this.rendered){this.on("afterrender",function(){this.initStops()},this,{delay:100});return}if(this.order_id||this.pre_order_id){this.setLoading(true);Ext.Ajax.request({scope:this,url:this.orderProcessingPage+"get-stops",params:{order_id:this.order_id,pre_order_id:this.pre_order_id,type:this.type},success:function(c){var a=Ext.decode(c.responseText);var b=this.setValues(a.records);Ext.each(b,function(d){d.collapse()},this);this.setLoading(false)}})}else{this.addStop()}},initMapPanel:function(){this.mapPanel=Ext.create("Ext.ux.GMapPanel",{scope:this,title:"Map",gmapType:"map",mapConfig:{scrollwheel:false}});this.items.push(this.mapPanel);this.mapPanel.on("show",function(){this.findMarkers()},this)},initMap:function(){this.mapPanel.on("afterrender",function(){this.map=this.mapPanel.gmap},this,{single:true})},initEastPanel:function(){this.eastToolbar=new Ext.toolbar.Toolbar({scope:this,items:[{scope:this,text:"Add Stop",icon:"/resources/icons/add-16.png",handler:function(){var a=this.addStop({collapsed:false});this.goToStop(a)}},{scope:this,text:"Collapse All",handler:function(){var a=this.getStopPanels();Ext.each(a,function(b){b.collapse()},this);this.stopContainer.doLayout()}},{scope:this,text:"Expand All",handler:function(){var a=this.getStopPanels();Ext.each(a,function(c,b){setTimeout(Ext.bind(function(){c.expand()},c),(b*0))},this)}}]});this.eastPanel=new Ext.panel.Panel({scope:this,title:"Stops",region:"east",autoScroll:true,border:false,tbar:this.eastToolbar});this.items.push(this.eastPanel)},initStopContainer:function(){this.stopPortal=Ext.create("TMS.portal.Column",{border:false});this.stopContainer=Ext.create("TMS.portal.Panel",{scope:this,border:false,unstyled:true,bodyPadding:"10",autoScroll:false,items:[this.stopPortal]});this.stopContainer.on("drop",function(a){this.fireEvent("reorder",this,a)},this);this.eastPanel.add(this.stopContainer)},setValues:function(b){if(!this.rendered){this.on("afterrender",function(c,d){this.setValues(d.stops)},this,{stops:b});return}var a=[];Ext.each(b,function(c){var d=this.addStop();this.setStopValues(d,c);a.push(d)},this);this.fireEvent("set",this,b);this.updateMileage();return a},getValues:function(){var a=[];Ext.each(this.getStopPanels(),function(b){b.useDefaultNames();if(b.getValues!=null){var c=b.getValues();c.street=c.address_1;a.push(c)}b.usePrefixPostfixNames()},this);this.fireEvent("get",this,a);return a},addStop:function(a){if(a==null){a={}}var b=Ext.create("TMS.orders.forms.sections.Stop",Ext.apply({scope:this,fieldPrefix:"stop",fieldPostfix:this.getStopPanels().length,draggable:true,cls:"x-portlet",title:"No Location Selected",baseTitle:"No Location Selected",frame:true,margin:"0 0 10 0",collapsible:true,type:this.type,titleCollapse:true,animCollapse:false,tools:[{scope:this,type:"close",tooltip:"Remove",handler:function(e,d,c){this.removeStop(c.up("panel"))}}]},a));b.on("expand",function(c){c.doLayout()},this);b.on("pressedenter",function(){var c=this.addStop({collapsed:false});this.goToStop(c);c.zip.focus()},this);b.on("addresschange",function(){this.updateMileage()},this);if(!this.getStopPanels().length){b.on("afterrender",function(c,d){c.stopTypeHidden.setValue("p")},this)}b.on("destroy",function(c){if(c.marker!=null){c.marker.setVisible(false)}this.findMarkers();this.stopContainer.doLayout();this.fireEvent("removestop",this,b);this.updateMileage()},this,{stop:b});b.location.on("select",function(g,d,f){if(!d.length){return false}var c=d[0];var e=c.get("location_name_1");if(e.length>50){e=e.substr(0,50)+"..."}b.setTitle(Ext.String.format("<span>{0} ({1})</span>",e,c.get("zip")));b.baseTitle=b.title;this.addMarker(f.stop,c.get("lat"),c.get("lng"),c.get("location_name_1"));this.fireEvent("locationchange",this,f.stop)},this,{stop:b});this.stopPortal.add(b);this.doLayout();this.fireEvent("addstop",this,b);return b},removeStop:function(a){a.getEl().fadeOut({callback:Ext.bind(function(b){this.stopPortal.remove(b);b.destroy()},this,[a])})},getStopPanels:function(){return this.stopPortal.items.items},addMarker:function(b,c,a,d){if(this.map==null){this.mapPanel.on("afterrender",function(e,f){this.addMarker(f.stop,f.lat,f.lng,f.title)},this,{stop:b,lat:c,lng:a,title:d});return}if(b.marker!=null){b.marker.setVisible(false)}b.marker=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(c,a),title:d});b.marker.setVisible(false);this.findMarkers()},findMarkers:function(){if(this.map==null){this.on("afterrender",function(){this.findMarkers()},this);return}var g=this.getStopPanels();var c=[];Ext.each(g,function(i){if(i.marker!=null){c.push(i.marker.getPosition())}},this);if(!c.length){return}var f=new google.maps.LatLngBounds();for(var d=0;d<c.length;d++){f.extend(c[d])}this.map.fitBounds(f);if(c.length>1){if(this.directionsDisplay==null){this.directionsDisplay=new google.maps.DirectionsRenderer();this.directionsService=new google.maps.DirectionsService()}this.directionsDisplay.setMap(null);this.directionsDisplay.setMap(this.map);var b=c.shift();var a=c.pop();var h=[];Ext.each(c,function(i){h.push({location:i})},this);var e={origin:b,destination:a,waypoints:h,travelMode:google.maps.TravelMode.DRIVING};this.directionsService.route(e,Ext.bind(function(i,j){if(j==google.maps.DirectionsStatus.OK){this.directionsDisplay.setDirections(i)}},this))}},bounceMarker:function(a,b){if(b==null){b=true}if(b){a.setAnimation(google.maps.Animation.BOUNCE)}else{a.setAnimation()}},goToStop:function(a){if(!a.rendered){a.on("afterrender",function(b,c){this.goToStop(c.stop)},this,{stop:a});return}setTimeout(Ext.bind(function(){Ext.get(this.stopContainer.body).scrollTo("top",a.getBox().y,{scope:a,duration:300,callback:function(){a.down("field").focus(true,50)}})},this),50)},setStopValues:function(c,a){if(!c.rendered){c.on("afterrender",function(e,d){this.setStopValues(e,d.values)},this,{values:a});return}if(a.location_id){this.addMarker(c,a.lat,a.lng,a.location_name_1)}var b=a.location_name_1;if(b.length){if(b.length>50){b=b.substr(0,50)+"..."}c.setTitle(Ext.String.format("<span>{0} ({1})</span>",b,a.zip));c.baseTitle=c.title}c.setValues(a)},updateMileage:function(){clearTimeout(this.updateMileageTimeout);this.updateMileageTimeout=setTimeout(Ext.bind(function(){this.doUpdateMileage()},this),500)},doUpdateMileage:function(){this.setTitle(this.baseTitle+" (Calculating mileage...)");var b=this.getValues();if(b.length<2){this.setTitle(this.baseTitle+" - Add 2 or more stops to calculate mileage")}for(var a=0;a<b.length;a++){if(!b[a].zip||b[a].zip&&b[a].zip.length<5){this.setTitle(this.baseTitle+" - Complete stop locations to update mileage");return false}}Ext.Ajax.request({scope:this,method:"post",url:"/at-ajax/modules/mileage/process/calculate-miles",params:{stops:Ext.encode(b)},success:function(g){var c=Ext.decode(g.responseText);if(c.success){var h=false;var f="";if(c.results.google.distance){h=c.results.google;f='<span><img src="/resources/icons/google-16.png" /></span>'}if(h){if(h.distanceDisplay){this.setTitle(this.baseTitle+" - "+f+" - "+h.distanceDisplay)}else{this.setTitle(this.baseTitle)}var e=this.getStopPanels();e[0].setTitle(e[0].baseTitle);for(var d=1;d<e.length;d++){if(h.movements[d-1]&&h.movements[d-1]["distanceDisplay"]){e[d].setTitle(e[d].baseTitle+" - "+f+" - "+h.movements[d-1]["distanceDisplay"])}}}}}})},initListeners:function(){this.on("reorder",this.onReorder,this);this.on("reorder",function(){this.updateMileage()},this)},onReorder:function(){var a=this.getStopPanels();Ext.each(a,function(c,b){c.setFieldPostfix(b)},this)}});Ext.define("TMS.orders.forms.Order",{extend:"TMS.form.Navigation",requires:["TMS.orders.forms.sections.CustomerInformation","TMS.orders.forms.sections.Stops","TMS.orders.forms.sections.OrderDetails","TMS.orders.forms.sections.Goods","TMS.contacts.forms.sections.ModesEquipment","TMS.orders.forms.sections.Carrier","TMS.documents.view.Interface","TMS.comment.forms.sections.Comments","TMS.orders.forms.sections.Revenue","TMS.orders.rateconfirmation.Preview"],title:"Order",url:"/at-ajax/modules/order/process/save-order",deferredRender:true,orderId:0,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.orderId=parseInt(this.orderId);this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initButtons();this.initCustomerInformation();this.initStops();this.initOrderDetails();this.initGoods();this.initModesEquipment();this.initCarrier();this.initDocuments();this.initComments();this.initRevenue()},initTitle:function(){this.baseTitle=this.title;if(this.orderId){this.title="Editing "+this.baseTitle+" - "+this.orderId}else{this.title="New "+this.baseTitle}},initButtons:function(){this.buttons=[{scope:this,text:"Preview Rate Confirmation",icon:"/resources/icons/preview-16.png",cls:"submit",handler:function(){this.on("submit",function(){this.previewRateConfirmation()},this,{single:true});this.submit()}},{scope:this,text:"Cancel",icon:"/resources/icons/delete-16.png",cls:"submit",handler:function(){}},{scope:this,text:"Save",icon:"/resources/icons/save-16.png",cls:"submit",handler:function(){this.submit()}}]},initCustomerInformation:function(){this.customerInformation=Ext.create("TMS.orders.forms.sections.CustomerInformation",{order_id:this.orderId});this.items.push(this.customerInformation);this.items.push({xtype:"hidden",name:"order_id",value:this.orderId})},initStops:function(){this.stops=Ext.create("TMS.orders.forms.sections.Stops",{order_id:this.orderId});this.items.push(this.stops);this.stops.on("addstop",function(b,a){this.bindForm(a)},this);this.on("beforesubmit",function(){if(this.stops.rendered){this.setParam("stops",Ext.encode(this.stops.getValues()))}},this)},initOrderDetails:function(){this.orderDetails=Ext.create("TMS.orders.forms.sections.OrderDetails",{order_id:this.orderId});this.items.push(this.orderDetails)},initGoods:function(){this.goods=Ext.create("TMS.orders.forms.sections.Goods",{order_id:this.orderId});this.items.push(this.goods)},initModesEquipment:function(){this.modesEquipment=Ext.create("TMS.contacts.forms.sections.ModesEquipment",{});this.items.push(this.modesEquipment);this.customerInformation.contactSelector.on("change",function(b,a){if(isNaN(a)){return}else{this.modesEquipment.loadContact(a)}},this)},initCarrier:function(){this.carrier=Ext.create("TMS.orders.forms.sections.Carrier",{title:"Carrier",order_id:this.orderId});this.items.push(this.carrier);this.carrier.on("show",function(){if(this.stops.rendered){this.carrier.grid.fromSelect.store.loadData(this.stops.getValues())}},this)},initDocuments:function(){this.documents=Ext.create("TMS.documents.view.Interface",{autoDestroy:false,extraParams:{order_id:this.orderId}});this.items.push(this.documents);this.documents.on("minimize",function(){this.setActiveItem(this.documents);this.documents.doLayout()},this)},initComments:function(){this.comments=Ext.create("TMS.comment.forms.sections.Comments",{field_value:this.orderId,type:"order"});this.items.push(this.comments)},initRevenue:function(){this.revenue=Ext.create("TMS.orders.forms.sections.Revenue",{title:"Revenue",order_id:this.orderId});this.items.push(this.revenue);this.on("beforesubmit",function(){if(this.revenue.rendered){this.setParam("revenue",Ext.encode(this.revenue.getValues()))}},this)},previewRateConfirmation:function(){if(this.rateConfirmation==null){this.rateConfirmation=Ext.create("TMS.orders.rateconfirmation.Preview",{order_id:this.orderId})}else{this.rateConfirmation.show();this.rateConfirmation.loadOrder(this.orderId)}}});Ext.define("TMS.orders.rateconfirmation.Email",{extend:"TMS.ActionWindow",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.ContactMethods","TMS.ActionWindow"],order_id:0,contact_id:0,contactName:"",title:"Rate Confirmation Email",baseTitle:"Rate Confirmation Email",processingPage:"/at-ajax/modules/order/process/",layout:"hbox",init:function(){this.initEmailBox();this.initButtons()},initEmailBox:function(){this.emailStore=Ext.create("Ext.data.Store",{fields:["email","contact_id","contactName"],proxy:{type:"ajax",url:this.processingPage+"get-carrier-contact-email-list",extraParams:{order_id:this.order_id},reader:{type:"json",root:"records"}}});this.emailBox=Ext.create("Ext.ux.form.field.RealComboBox",{store:this.emailStore,displayField:"email",valueField:"email",queryMode:"local",flex:1,emptyText:"No emails for this contact",editable:false});this.items.push(this.emailBox);this.emailStore.on("load",function(){if(this.emailStore.data.length){this.emailBox.setValue(this.emailStore.getAt(0).get("email"));this.contact_id=this.emailStore.getAt(0).get("contact_id");this.contactName=this.emailStore.getAt(0).get("contactName");this.updateData()}else{this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-carrier-contact",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.contact_id=a.contact_id;this.contactName=a.contactName;this.updateData()}})}},this);this.emailStore.load()},updateData:function(){this.setTitle(this.baseTitle+" - "+this.contactName);if(this.contact_id){this.manageContactMethodsButton.enable();if(this.emailStore.data.length){this.sendEmailButton.enable()}else{this.sendEmailButton.disable()}}else{this.manageContactMethodsButton.disable();this.sendEmailButton.disable()}},initButtons:function(){this.sendEmailButton=Ext.create("Ext.button.Button",{scope:this,text:"Send Email",handler:this.sendEmail,itemId:"sendEmailButton",icon:"/resources/icons/email-16.png"});this.manageContactMethodsButton=Ext.create("Ext.button.Button",{scope:this,text:"Manage Contact Methods",handler:this.manageContactMethods,itemId:"manageContactMethodsButton"});this.addTopButton([this.sendEmailButton,this.manageContactMethodsButton]);this.showCloseButton()},sendEmail:function(){var a=this.emailBox.getValue();this.setLoading("Sending email to "+a);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"email-confirmation",params:{order_id:this.order_id,email:a},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);if(b.success){this.update(b.msg[0]);this.topToolbar.hide()}}})},manageContactMethods:function(){var a=Ext.create("TMS.contacts.forms.sections.ContactMethods",{contact_id:this.contact_id});var b=Ext.create("TMS.ActionWindow",{title:this.contactName,width:400,height:300,items:[a]});b.showCloseButton();b.on("close",function(){this.emailBox.setValue("");this.emailStore.load()},this)}});Ext.define("TMS.orders.rateconfirmation.Fax",{extend:"TMS.ActionWindow",requires:["Ext.ux.form.field.RealComboBox","TMS.contacts.forms.sections.ContactMethods","TMS.ActionWindow"],order_id:0,contact_id:0,contactName:"",title:"Rate Confirmation Fax",baseTitle:"Rate Confirmation Fax",processingPage:"/at-ajax/modules/order/process/",layout:"hbox",init:function(){this.initFaxBox();this.initButtons()},initFaxBox:function(){this.faxStore=Ext.create("Ext.data.Store",{fields:["fax","contact_id","contactName"],proxy:{type:"ajax",url:this.processingPage+"get-carrier-contact-fax-list",extraParams:{order_id:this.order_id},reader:{type:"json",root:"records"}}});this.faxBox=Ext.create("Ext.ux.form.field.RealComboBox",{store:this.faxStore,displayField:"fax",valueField:"fax",queryMode:"local",flex:1,emptyText:"No faxes for this contact",editable:false});this.items.push(this.faxBox);this.faxStore.on("load",function(){if(this.faxStore.data.length){this.faxBox.setValue(this.faxStore.getAt(0).get("fax"));this.contact_id=this.faxStore.getAt(0).get("contact_id");this.contactName=this.faxStore.getAt(0).get("contactName");this.updateData()}else{this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-carrier-contact",params:{order_id:this.order_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.contact_id=a.contact_id;this.contactName=a.contactName;this.updateData()}})}},this);this.faxStore.load()},updateData:function(){this.setTitle(this.baseTitle+" - "+this.contactName);if(this.contact_id){this.manageContactMethodsButton.enable();if(this.faxStore.data.length){console.log(this.faxStore);this.sendFaxButton.enable()}else{this.sendFaxButton.disable()}}else{this.manageContactMethodsButton.disable();this.sendFaxButton.disable()}},initButtons:function(){this.sendFaxButton=Ext.create("Ext.button.Button",{scope:this,text:"Send Fax",handler:this.sendFax,itemId:"sendFaxButton",icon:"/resources/icons/fax-16.png"});this.manageContactMethodsButton=Ext.create("Ext.button.Button",{scope:this,text:"Manage Contact Methods",handler:this.manageContactMethods,itemId:"manageContactMethodsButton"});this.addTopButton([this.sendFaxButton,this.manageContactMethodsButton]);this.showCloseButton()},sendFax:function(){var a=this.faxBox.getValue();this.setLoading("Sending fax to "+a);Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"fax-confirmation",params:{order_id:this.order_id,fax:a},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);if(b.success){this.update(b.msg[0]);this.topToolbar.hide()}}})},manageContactMethods:function(){var a=Ext.create("TMS.contacts.forms.sections.ContactMethods",{contact_id:this.contact_id});var b=Ext.create("TMS.ActionWindow",{title:this.contactName,width:400,height:300,items:[a]});b.showCloseButton();b.on("close",function(){this.faxBox.setValue("");this.faxStore.load()},this)}});Ext.define("TMS.orders.rateconfirmation.Preview",{extend:"TMS.ActionWindow",requires:["TMS.ActionWindow","TMS.orders.rateconfirmation.Email","TMS.orders.rateconfirmation.Fax"],order_id:0,iframe:false,iframeHtml:false,title:"Rate Confirmation Preview",url:"/at-ajax/modules/order/process/",closeAction:"hide",widthPercent:0.9,heightPercent:0.9,init:function(){this.initIframe();this.initButtons()},initIframe:function(){this.iframeHtml=Ext.core.DomHelper.markup({tag:"iframe",cls:"rate-confirmation-iframe",border:0,frameborder:0,width:"100%",height:"100%"});this.html=this.iframeHtml;this.on("afterrender",function(){this.iframe=this.getEl().down("iframe");if(this.order_id){this.loadOrder(this.order_id)}},this)},initButtons:function(){this.showCloseButton();this.addTopButton([{scope:this,text:"Download PDF",handler:this.download,icon:"/resources/icons/download-16.png"},{scope:this,text:"Send Email",handler:this.sendEmail,icon:"/resources/icons/email-16.png"},{scope:this,text:"Send Fax",handler:this.sendFax,icon:"/resources/icons/fax-16.png"},{scope:this,text:"Tweet This",handler:this.tweetThis,icon:"/resources/icons/twitter-16.png"}])},loadOrder:function(a){this.order_id=a||this.order_id;setTimeout(Ext.bind(function(){this.setLoading()},this),200);this.iframe.on("load",function(){this.setLoading(false)},this);this.iframe.dom.src=this.url+"output-confirmation?order_id="+this.order_id},download:function(){location.href=this.url+"download-confirmation?order_id="+this.order_id},sendEmail:function(){Ext.create("TMS.orders.rateconfirmation.Email",{order_id:this.order_id})},sendFax:function(){Ext.create("TMS.orders.rateconfirmation.Fax",{order_id:this.order_id})},tweetThis:function(){this.tweetThisWindow=Ext.create("TMS.ActionWindow",{html:'<img src="/resources/img/seriously.png" />',width:350,height:290})}});Ext.define("TMS.orders.view.FilteredGrid",{extend:"Ext.panel.Panel",requires:["TMS.orders.filter.Order","TMS.orders.view.Grid"],layout:"border",height:500,title:"Orders",extraFilters:{},gridConfig:{},constructor:function(){this.extraFilters={};this.gridConfig={};return this.callParent(arguments)},initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initFilters();this.initGrid();this.initListeners()},initFilters:function(){this.filterPanel=Ext.create("TMS.orders.filter.Order",{region:"east",title:"Search",width:250,collapsible:true,collapsed:true,extraFilters:this.extraFilters});this.items.push(this.filterPanel)},initGrid:function(){this.gridPanel=Ext.create("TMS.orders.view.Grid",Ext.apply({height:500,region:"center",filter:this.filterPanel},this.gridConfig));this.items.push(this.gridPanel);this.gridPanel.store.on("load",function(){},this);this.filterPanel.registerFilter(this.gridPanel.quickSearch)},initListeners:function(){this.gridPanel.on("filter",function(a,b){this.filterPanel.filter()},this)}});Ext.define("TMS.orders.view.Grid",{extend:"TMS.grid.Grid",requires:["TMS.orders.forms.sections.Carrier","TMS.form.plugin.StatusBar","TMS.ActionWindow"],processingPage:"/at-ajax/modules/order/order/",toolsProcessingPage:"/at-ajax/modules/tools/status-types/list",viewConfig:{stripeRows:true},initComponent:function(){this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initColumns();this.initStore();this.initPager();this.initListeners()},initToolbar:function(){this.quickSearch=Ext.create("Ext.form.field.Text",{fieldLabel:"Quick Search",name:"quickSearch"});this.quickSearch.on("change",function(a){this.fireEvent("filter",this,a)},this,{buffer:500});this.toolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:["->",this.quickSearch]});this.dockedItems.push(this.toolbar)},initColumns:function(){this.columns=[{header:"Order #",dataIndex:"order_id",width:85,renderer:function(c,b,a){var d='<a href="/orders/?d=orders&a=show&id='+a.get("order_id")+'">'+a.get("order_display")+"</a>";if(a.get("detail_value")==this.quickSearch.getValue()){d+="<p>"+a.get("detail_type_name")+"</p>"}return d}},{header:"Status",dataIndex:"status_id",width:80,renderer:function(c,b,a){return a.get("status_name")}},{header:"Customer",dataIndex:"customer_name",flex:1,xtype:"templatecolumn",tpl:'<a href="/customers/?d=customers&a=view&id={customer_id}">{customer_name}</a>'},{header:"Ordered By",dataIndex:"ordered_by_name",xtype:"templatecolumn",tpl:'<a href="/contacts/?d=contacts&a=view&id={ordered_by_id}">{ordered_by_name}</a>',hidden:true},{header:"Bill To",dataIndex:"bill_to_name",xtype:"templatecolumn",tpl:'<a href="/customers/?d=customers&a=view&id={bill_to_id}">{bill_to_name}</a>',hidden:true},{header:"Origin",dataIndex:"origin",sortable:false,flex:1},{header:"Destination",dataIndex:"destination",sortable:false,flex:1},{header:"Owner",dataIndex:"broker_name",xtype:"templatecolumn",tpl:'<a href="/contacts/?d=contacts&a=view&id={contact_id}">{broker_name}</a>'},{header:"Charge",dataIndex:"total_charge",renderer:Ext.util.Format.usMoney},{header:"Margin",dataIndex:"total_profit_pct",renderer:function(f,c,b){var g="";var d="green";var e=0;var h="n/a";var a=b.data.total_charge-b.data.total_cost;if(b.data.total_charge&&b.data.total_charge>0){e=a/b.data.total_charge;e*=100;e=e.toFixed(2);h=e+"%"}if(a<=0){d="red"}g+=' <span style="color:'+d+';"> $';g+=a;g+="<br />"+h;g+="</span>";return g;if(f){return f+"%"}else{return"n/a"}}},{header:"Carrier",dataIndex:"carrier_name",flex:1,sortable:false,renderer:function(f,c,b,g,e,d,a){if(!parseInt(b.get("carrier_id"))&&parseInt(b.get("origin_stop_id"))&&parseInt(b.get("destination_stop_id"))){return Ext.String.format('<div class="button"><a href="#{0}" class="carrier_search_tool"><img src="/resources/silk_icons/lorry_go.png" alt="Find Carrier" title="Find Carrier" />Find Carrier</a></div>',b.get("order_id"))}else{if(f){return Ext.String.format('<a href="/carriers/?d=carriers&action=view&id={0}">{1}</a>',b.get("carrier_id"),b.get("carrier_name"))}else{return""}}}}]},initStore:function(){this.store=new Ext.data.Store({fields:["order_id","order_display","customer_id","customer_name","ordered_by_id","ordered_by_name","bill_to_id","bill_to_name","status_id","contact_id","charge_id","total_charge","total_cost","fuel_cost","linehaul_cost","accessorial_cost","total_profit","total_profit_pct","broker_name","status_name","origin","origin_stop_id","destination","destination_stop_id","carrier_id","carrier_name","detail_type_id","detail_type_name","detail_value"],remoteSort:true,pageSize:25,proxy:{type:"ajax",url:this.processingPage+"get",reader:{type:"json",root:"records",totalProperty:"total"}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("?d=orders&a=show&id={0}",a.get("order_id"))},this);this.on("afterrender",function(){this.getView().on("cellcontextmenu",function(h,j,f,d,k,g,a){var b=h.getHeaderByCell(j);var c=h.getPositionByEvent(a);var e=c.column;var i=b.dataIndex;a.preventDefault();if(i=="status_id"){if(this.statusMenu==null){this.statusMenu=new Ext.menu.Menu({scope:this,items:[{text:"Loading...",icon:"/resources/js/extjs/resources/themes/images/gray/grid/loading.gif"}]});Ext.Ajax.request({scope:this,url:this.toolsProcessingPage,event:a,record:d,success:function(n,m){var l=Ext.JSON.decode(n.responseText);if(l.success&&l.records!=null){this.statusMenu.removeAll();Ext.each(l.records,function(o){var p=new Ext.menu.Item({scope:this,text:o.status_name,record:o,handler:function(q){this.updateStatus(this.statusMenu.record.get("order_id"),q.record.status_id)}});this.statusMenu.add(p)},this);this.statusMenu.doComponentLayout()}}})}this.statusMenu.record=d;this.statusMenu.showAt(a.getXY())}},this)},this);this.store.on("load",function(){var c=Ext.select(".carrier_search_tool",true);var b=c.elements.length;for(var a=0;a<b;a++){c.elements[a].on("click",function(i,h){i.preventDefault();var d=h.href.split("#")[1];var g=Ext.create("TMS.orders.forms.sections.Carrier",{order_id:d,plugins:[Ext.create("TMS.form.plugin.StatusBar")]});var f=Ext.create("TMS.ActionWindow",{title:"Find A Carrier",layout:"fit",sizePercent:0.9,items:[g],bottomItems:[{text:"Save",scale:"medium",icon:"/resources/icons/save-24.png",handler:function(){g.submit()}}]});f.on("close",function(){this.store.load()},this)},this)}},this)},initFilters:function(){this.filterPanel.add(new Ext.form.field.Text({fieldLabel:"Name"}))},updateStatus:function(a,b){Ext.Ajax.request({scope:this,url:this.processingPage+"update-status",params:{order_id:a,status_id:b},success:function(e,d){var c=Ext.JSON.decode(e.responseText);this.store.load()}})}});Ext.define("TMS.orders.view.PostGrid",{extend:"Ext.grid.Panel",processingPage:"/at-ajax/modules/order/posting/get",viewConfig:{stripeRows:true},features:[{id:"group",ftype:"groupingsummary",groupHeaderTpl:"Quote #: {name}",hideGroupedHeader:true,showSummaryRow:false,remoteRoot:"summaryData"}],initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("?d=quotes&a=show&id={0}",a.get("pre_order_id"))},this)},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initColumns:function(){this.columns=[{header:"Pre Order",dataIndex:"pre_order_id",flex:1},{header:"Service",dataIndex:"posting_service_name",flex:1,renderer:function(c,b,a){return Ext.String.format('<a href="{0}" target="_blank">{1}</a>',a.get("url"),c)}},{header:"Date",dataIndex:"posting_created_at",flex:1},{xtype:"templatecolumn",tpl:'<div class="button" style="width: 75px;"><a href="?d=posts&a=cancel&id={pre_order_id}"><img src="/resources/silk_icons/cross.png" /> Cancel</a></div>'}]},initStore:function(){this.store=new Ext.data.Store({fields:["pre_order_id","posting_created_at","posting_service_name","url",],remoteSort:true,pageSize:50,groupField:"pre_order_id",proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.orders.view.PreOrderFilteredGrid",{extend:"Ext.panel.Panel",requires:["TMS.orders.filter.PreOrder","TMS.orders.view.PreOrderGrid"],layout:"border",height:500,title:"Quotes",collapsible:true,titleCollapse:true,extraFilters:{},gridConfig:{},constructor:function(){this.gridConfig={};return this.callParent(arguments)},initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initFilters();this.initGrid();this.initListeners()},initFilters:function(){this.filterPanel=Ext.create("TMS.orders.filter.PreOrder",{region:"east",width:250,collapsible:true,collapsed:true,title:"Search",extraFilters:this.extraFilters});this.items.push(this.filterPanel)},initGrid:function(){this.gridPanel=Ext.create("TMS.orders.view.PreOrderGrid",Ext.apply({region:"center",filter:this.filterPanel},this.gridConfig));this.items.push(this.gridPanel);this.filterPanel.registerFilter(this.gridPanel.quickSearch)},initListeners:function(){this.gridPanel.on("filter",function(a,b){this.filterPanel.filter()},this);if(this.collapsed){this.collapsed=false;this.on("afterrender",function(){this.collapse()},this)}this.on("expand",function(){this.gridPanel.doLayout();this.scrollIntoView()},this)}});Ext.define("TMS.orders.view.PreOrderGrid",{extend:"TMS.grid.Grid",processingPage:"/at-ajax/modules/order/pre-order/get",viewConfig:{stripeRows:true},initComponent:function(){this.dockedItems=this.dockedItems||[];this.init();this.callParent(arguments)},init:function(){this.initToolbar();this.initSelectionModel();this.initColumns();this.initStore();this.initPager();this.initListeners()},initToolbar:function(){this.postMenu=Ext.create("Ext.menu.Menu",{showSeparator:false,items:[{text:"Road Runners",checked:true,value:1},{text:"Internet Truckstop",checked:true,value:4},{text:"GetLoaded",checked:true,value:7},{text:"Transcore",checked:true,value:8},{text:"Jaguar",checked:true,value:10},"-",{scope:this,text:"Post",handler:this.doPost}]});this.quantityField=Ext.create("Ext.form.field.Text",{emptyText:"Quantity",fieldLabel:"Quantity",labelWidth:55,width:80,value:1,margin:4});this.convertToOrderMenu=Ext.create("Ext.menu.Menu",{showSeparator:false,items:[this.quantityField,"-",{scope:this,text:"Convert",handler:this.convertToOrder,icon:"/resources/silk_icons/lightning_add.png"}]});this.quickSearch=Ext.create("Ext.form.field.Text",{fieldLabel:"Quick Search",name:"quickSearch"});this.quickSearch.on("change",function(a){this.fireEvent("filter",this,a)},this,{buffer:500});this.toolbar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{scope:this,text:"Convert to Order",menu:this.convertToOrderMenu,icon:"/resources/silk_icons/lightning_add.png"},"-",{scope:this,text:"Post Selected Quotes",menu:this.postMenu},"->",this.quickSearch]});this.dockedItems.push(this.toolbar)},getSelectedIds:function(){var d=this.selModel.getSelection();var a=d.length;var c=[];if(a){for(var b=0;b<a;b++){c.push(d[b].data.pre_order_id)}}return c},getSelectedServiceIds:function(){var c=[];var b=this.postMenu.items.items.length;for(var a=0;a<b;a++){var d=this.postMenu.items.items[a];if(d.checked){c.push(d.value)}}return c},doPost:function(){var b=this.getSelectedIds();var a=this.getSelectedServiceIds();if(b.length){this.setLoading("Posting to services...");Ext.Ajax.request({scope:this,method:"post",url:"/at-ajax/modules/preorder/post/do-post",params:{preOrderIds:Ext.encode(b),postingServiceIds:Ext.encode(a)},success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText)}})}},convertToOrder:function(){var a=this.getSelectedIds();if(a.length){this.setLoading("Converting...");Ext.Ajax.request({scope:this,method:"post",url:"/at-ajax/modules/preorder/process/convert-to-order",params:{preOrderIds:Ext.encode(a),quantity:this.quantityField.getValue()},success:function(c){this.setLoading(false);var b=Ext.decode(c.responseText);location.href="/orders"}})}},initSelectionModel:function(){this.selModel=Ext.create("Ext.selection.CheckboxModel")},initListeners:function(){this.on("afterrender",function(){this.store.load()},this);this.on("itemdblclick",function(b,a){this.setLoading(true);location.href=Ext.String.format("?d=quotes&a=show&id={0}",a.get("pre_order_id"))},this);this.store.on("load",function(){var b=Ext.select(".convert-button",true);for(var a=0;a<b.elements.length;a++){b.elements[a].on("click",function(d,c){d.preventDefault();this.quantityField.setValue(1);setTimeout(Ext.Function.bind(this.convertToOrder,this),200)},this)}},this)},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initColumns:function(){this.columns=[{header:"Quote #",dataIndex:"pre_order_id",width:75,xtype:"templatecolumn",tpl:'<a href="?d=quotes&a=show&id={pre_order_id}">{pre_order_id}</a>'},{header:"Customer",dataIndex:"customer_name",flex:1,xtype:"templatecolumn",tpl:'<a href="/customers/?d=customers&a=view&id={customer_id}">{customer_name}</a>'},{header:"Origin",dataIndex:"origin",flex:2,sortable:false},{header:"Destination",dataIndex:"destination",flex:2,sortable:false},{header:"Owner",dataIndex:"broker_name",flex:1,xtype:"templatecolumn",tpl:'<a href="/contacts/?d=contacts&a=view&id={contact_id}">{broker_name}</a>'},{header:"Charge",dataIndex:"total_charge",renderer:Ext.util.Format.usMoney},{header:"Expiration Date",dataIndex:"expiration_date",flex:1},{header:"",dataIndex:"",xtype:"templatecolumn",width:100,tpl:'<div class="button" style="width:60px;"><a href="#" class="convert-button" id="convert-{pre_order_id}">Convert</a></div>'}]},initStore:function(){this.store=new Ext.data.Store({fields:["pre_order_id","customer_id","bill_to_id","ordered_by_id","status_id","broker_id","charge_id","total_charge","contact_id","broker_name","customer_name","status_name","origin","origin_stop_id","destination","destination_stop_id","expiration_date"],remoteSort:true,pageSize:25,proxy:{type:"ajax",url:this.processingPage,reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.panel.plugin.AutoHeight",{init:function(a){this.panel=a;this.panel.on("afterrender",function(){this.panel.setHeight(Ext.Element.getViewportHeight()-this.panel.getEl().getY()-10);this.panel.doLayout()},this);Ext.EventManager.onWindowResize(function(){this.panel.setHeight(Ext.Element.getViewportHeight()-this.panel.getEl().getY()-10);this.panel.doLayout()},this)}});Ext.define("TMS.panel.plugin.FullScreen",{extend:"Ext.util.Observable",init:function(a){this.panel=a},maximize:function(a){this.panel=a;this.lastOwner=a.ownerCt;this.lastIndex=0;if(this.lastOwner!=null&&this.lastOwner.items!=null){Ext.each(this.lastOwner.items.items,function(c,b){if(c==this.panel){this.lastIndex=b}},this)}if(this.window==null){this.window=Ext.create("Ext.window.Window",{scope:this,layout:"fit",baseCls:"x-panel",frame:false,closeAction:"hide",closable:false,draggable:false,resizable:false,width:Ext.Element.getViewportWidth(),height:Ext.Element.getViewportHeight()});this.window.on("show",function(){this.window.setWidth(Ext.Element.getViewportWidth());this.window.setHeight(Ext.Element.getViewportHeight());this.window.center();this.window.doLayout()},this);Ext.EventManager.onWindowResize(function(){this.window.setWidth(Ext.Element.getViewportWidth());this.window.setHeight(Ext.Element.getViewportHeight());this.window.center();this.window.doLayout()},this)}this.window.add(this.panel);this.window.show();this.fireEvent("maximize",this,this.panel,this.window)},minimize:function(){this.window.hide();this.window.remove(this.panel,false);if(this.lastOwner!=null){this.lastOwner.insert(this.lastIndex,this.panel)}this.panel.doLayout();this.fireEvent("maximize",this,this.panel)}});Ext.define("TMS.portal.Column",{extend:"Ext.container.Container",alias:"widget.portalcolumn",requires:["TMS.portal.Portlet"],layout:{type:"anchor"},defaultType:"portlet",cls:"x-portal-column"});Ext.define("TMS.portal.DropZone",{extend:"Ext.dd.DropTarget",constructor:function(a,b){this.portal=a;Ext.dd.ScrollManager.register(a.body);this.callParent([a.body,b]);a.body.ddScrollConfig=this.ddScrollConfig},ddScrollConfig:{vthresh:50,hthresh:-1,animate:true,increment:200},createEvent:function(a,f,d,b,h,g){return{portal:this.portal,panel:d.panel,columnIndex:b,column:h,position:g,data:d,source:a,rawEvent:f,status:this.dropAllowed}},notifyOver:function(u,t,v){var d=t.getXY(),a=this.portal,p=u.proxy;if(!this.grid){this.grid=this.getGrid()}var b=a.body.dom.clientWidth;if(!this.lastCW){this.lastCW=b}else{if(this.lastCW!=b){this.lastCW=b;this.grid=this.getGrid()}}var o=0,c=0,n=this.grid.columnX,q=n.length,m=false;for(q;o<q;o++){c=n[o].x+n[o].w;if(d[0]<c){m=true;break}}if(!m){o--}var i,g=0,r=0,l=false,k=a.items.getAt(o),s=k.items.items,j=false;q=s.length;for(q;g<q;g++){i=s[g];r=i.el.getHeight();if(r===0){j=true}else{if((i.el.getY()+(r/2))>d[1]){l=true;break}}}g=(l&&i?g:k.items.getCount())+(j?-1:0);var f=this.createEvent(u,t,v,o,k,g);if(a.fireEvent("validatedrop",f)!==false&&a.fireEvent("beforedragover",f)!==false){p.getProxy().setWidth("auto");if(i){p.moveProxy(i.el.dom.parentNode,l?i.el.dom:null)}else{p.moveProxy(k.el.dom,null)}this.lastPos={c:k,col:o,p:j||(l&&i)?g:false};this.scrollPos=a.body.getScroll();a.fireEvent("dragover",f);return f.status}else{return f.status}},notifyOut:function(){delete this.grid},notifyDrop:function(l,h,g){delete this.grid;if(!this.lastPos){return}var j=this.lastPos.c,f=this.lastPos.col,k=this.lastPos.p,a=l.panel,b=this.createEvent(l,h,g,f,j,k!==false?k:j.items.getCount());if(this.portal.fireEvent("validatedrop",b)!==false&&this.portal.fireEvent("beforedrop",b)!==false){a.el.dom.style.display="";if(k!==false){j.insert(k,a)}else{j.add(a)}l.proxy.hide();this.portal.fireEvent("drop",b);var m=this.scrollPos.top;if(m){var i=this.portal.body.dom;setTimeout(function(){i.scrollTop=m},10)}}delete this.lastPos;return true},getGrid:function(){var a=this.portal.body.getBox();a.columnX=[];this.portal.items.each(function(b){a.columnX.push({x:b.el.getX(),w:b.el.getWidth()})});return a},unreg:function(){Ext.dd.ScrollManager.unregister(this.portal.body);TMS.portal.DropZone.superclass.unreg.call(this)}});Ext.define("TMS.portal.Panel",{extend:"Ext.panel.Panel",alias:"widget.portalpanel",requires:["TMS.portal.DropZone","TMS.portal.Column",],cls:"x-portal",bodyCls:"x-portal-body",defaultType:"portalcolumn",componentLayout:"body",autoScroll:true,initComponent:function(){var a=this;this.layout={type:"column"};this.callParent();this.addEvents({validatedrop:true,beforedragover:true,dragover:true,beforedrop:true,drop:true});this.on("drop",this.doLayout,this)},beforeLayout:function(){var b=this.layout.getLayoutItems(),a=b.length,c=0,d;for(;c<a;c++){d=b[c];d.columnWidth=1/a;d.removeCls(["x-portal-column-first","x-portal-column-last"])}b[0].addCls("x-portal-column-first");b[a-1].addCls("x-portal-column-last");return this.callParent(arguments)},initEvents:function(){this.callParent();this.dd=Ext.create("TMS.portal.DropZone",this,this.dropConfig)},beforeDestroy:function(){if(this.dd){this.dd.unreg()}TMS.portal.Panel.superclass.beforeDestroy.call(this)}});Ext.define("TMS.portal.Portlet",{extend:"Ext.panel.Panel",alias:"widget.portlet",layout:"fit",anchor:"100%",margin:5,draggable:true,cls:"x-portlet",doClose:function(){this.el.animate({opacity:0,callback:function(){this.fireEvent("close",this);this[this.closeAction]()},scope:this})}});Ext.define("TMS.preorders.forms.sections.Charge",{extend:"TMS.orders.forms.sections.Charge",processingPage:"/at-ajax/modules/preorder/process/",loadByKey:"pre_order_id",pre_order_id:0});Ext.define("TMS.preorders.forms.sections.CustomerInformation",{extend:"TMS.orders.forms.sections.CustomerInformation",loadByKey:"pre_order_id",pre_order_id:0,processingPage:"/at-ajax/modules/preorder/process/"});Ext.define("TMS.preorders.forms.sections.Expiration",{extend:"TMS.form.Abstract",title:"Quote Expiration",baseTitle:"Quote Expiration",bodyStyle:{padding:"8px"},processingPage:"/at-ajax/modules/order/expiration/",url:"/at-ajax/modules/order/expiration/",loadByKey:"pre_order_id",pre_order_id:0,autoSave:false,initComponent:function(){this.baseTitle=this.title;this.items=[];this.init();this.callParent(arguments)},init:function(){this.initCreatedAt();this.initExpiration();this.initListeners();this.loadData(this[this.loadByKey])},initCreatedAt:function(){this.createdAt=Ext.create("Ext.form.Display",{fieldLabel:"Created",name:"created_at",value:"Now"});this.items.push(this.createdAt)},initExpiration:function(){this.expiration=Ext.create("Ext.form.Date",{name:"expiration_date",fieldLabel:"Expires",value:Ext.Date.format(Ext.Date.add(new Date(),Ext.Date.DAY,60),"m/d/Y")});this.items.push(this.expiration)},initListeners:function(){},loadData:function(a){this[this.loadByKey]=a;var b={};b[this.loadByKey]=this[this.loadByKey];if(this[this.loadByKey]>0){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get",params:b,success:function(d){this.setLoading(false);var c=Ext.decode(d.responseText);this.record=c.record;this.setData(c.record)}})}},setData:function(b){var a=new Date(b.createdAt);this.createdAt.setValue(b.createdAt);this.expiration.setValue(b.expiration)}});Ext.define("TMS.preorders.forms.sections.OrderDetails",{extend:"TMS.orders.forms.sections.OrderDetails",loadByKey:"pre_order_id",pre_order_id:0,processingPage:"/at-ajax/modules/preorder/process/"});Ext.define("TMS.preorders.forms.PreOrder",{extend:"TMS.form.Navigation",requires:["TMS.preorders.forms.sections.CustomerInformation","TMS.preorders.forms.sections.Expiration","TMS.orders.forms.sections.Stops","TMS.preorders.forms.sections.OrderDetails","TMS.contacts.forms.sections.ModesEquipment","TMS.preorders.forms.sections.Charge"],title:"Quote",url:"/at-ajax/modules/preorder/process/save",deferredRender:true,preOrderId:0,initComponent:function(){this.items=this.items||[];this.dockedItems=this.dockedItems||[];this.preOrderId=parseInt(this.preOrderId);this.init();this.callParent(arguments)},init:function(){this.initTitle();this.initHidden();this.initButtons();this.initCustomerInformation();this.initQuoteExpiration();this.initStops();this.initOrderDetails();this.initModesEquipment();this.initCharges()},initTitle:function(){this.baseTitle=this.title;if(this.preOrderId){this.title="Editing "+this.baseTitle+" - "+this.preOrderId}else{this.title="New "+this.baseTitle}},initHidden:function(){},initButtons:function(){this.buttons=[{scope:this,text:"Save and Convert",icon:"/resources/icons/save-16.png",cls:"submit",handler:function(){this.setParam("doConvert",1);this.submit()}},{scope:this,text:"Save",icon:"/resources/icons/save-16.png",cls:"submit",handler:function(){this.submit()}}]},initCustomerInformation:function(){this.customerInformation=Ext.create("TMS.preorders.forms.sections.CustomerInformation",{pre_order_id:this.preOrderId,loadByKey:"pre_order_id"});this.items.push(this.customerInformation);this.items.push({xtype:"hidden",name:"pre_order_id",value:this.preOrderId})},initQuoteExpiration:function(){this.quoteExpiration=Ext.create("TMS.preorders.forms.sections.Expiration",{pre_order_id:this.preOrderId});this.items.push(this.quoteExpiration)},initStops:function(){this.stops=Ext.create("TMS.orders.forms.sections.Stops",{pre_order_id:this.preOrderId,type:"preorder"});this.items.push(this.stops);this.stops.on("addstop",function(b,a){this.bindForm(a)},this);this.on("beforesubmit",function(){if(this.stops.rendered){this.setParam("stops",Ext.encode(this.stops.getValues()))}},this)},initOrderDetails:function(){this.orderDetails=Ext.create("TMS.preorders.forms.sections.OrderDetails",{pre_order_id:this.preOrderId});this.items.push(this.orderDetails)},initModesEquipment:function(){this.modesEquipment=Ext.create("TMS.contacts.forms.sections.ModesEquipment",{});this.items.push(this.modesEquipment);this.customerInformation.contactSelector.on("change",function(b,a){if(isNaN(a)){return}else{this.modesEquipment.loadContact(a)}},this)},initCharges:function(){this.charges=Ext.create("TMS.preorders.forms.sections.Charge",{pre_order_id:this.preOrderId,title:"Charges"});this.items.push(this.charges);this.on("beforesubmit",function(){if(this.charges.rendered){this.setParam("charges",Ext.encode(this.charges.getValues()))}},this)}});Ext.define("TMS.task.filter.Task",{extend:"TMS.filter.Abstract",processingPage:"/at-ajax/modules/task/grid/",requires:["Ext.ux.form.field.RealComboBox"],init:function(){this.initTaskTypes();this.initTaskOwners();this.initCreatedBy();this.initAssignedTo();this.initDueDateOn();this.initDueDateFrom();this.initDueDateTo()},initTaskTypes:function(){this.typeStore=Ext.create("Ext.data.Store",{fields:["task_type_id","task_name"],proxy:{type:"ajax",url:this.processingPage+"get-task-type-list",reader:{type:"json",root:"records"}}});this.typeStore.load();this.items.push({xtype:"realcombobox",queryMode:"local",name:"status",displayField:"task_name",valueField:"task_type_id",fieldLabel:"Task Type",store:this.typeStore})},initTaskOwners:function(){var a={data:[{value:"all",display:"All"},{value:"unclaimed",display:"Unclaimed"},{value:"me",display:"Me"},{value:"others",display:"Others"}]};this.taskOwnerStore=Ext.create("Ext.data.Store",{autoLoad:true,fields:["value","display"],data:a,proxy:{type:"memory",reader:{type:"json",root:"data"}}});this.items.push({xtype:"realcombobox",queryMode:"local",name:"taskOwner",displayField:"display",valueField:"value",fieldLabel:"Task Owners",store:this.taskOwnerStore})},initCreatedBy:function(){this.items.push({name:"created_by",fieldLabel:"Created By"})},initAssignedTo:function(){this.items.push({name:"assigned_to",fieldLabel:"Assigned To"})},initDueDateOn:function(){this.items.push({xtype:"datefield",name:"dueDateOn",fieldLabel:"Due Date On"})},initDueDateFrom:function(){this.items.push({xtype:"datefield",name:"dueDateFrom",fieldLabel:"Due Date From"})},initDueDateTo:function(){this.items.push({xtype:"datefield",name:"dueDateTo",fieldLabel:"Due Date To"})}});Ext.define("TMS.task.forms.sections.Notification",{extend:"TMS.ActionWindow",title:"Notification",processingPage:"/at-ajax/modules/task/process/",widthPercent:0.9,heightPercent:0.9,comment_id:0,bodyPadding:10,init:function(){if(this.comment_id){this.loadData(this.comment_id)}this.initButtons();this.initListeners()},initButtons:function(){this.approveButton=Ext.create("Ext.button.Button",{scope:this,text:"Mark as Complete",handler:this.complete,scale:"medium",icon:"/resources/icons/check-24.gif"});this.addTopButton([this.approveButton])},complete:function(){this.setLoading();Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"complete-task",params:{taskId:this.task_id},success:function(b){this.setLoading(false);var a=Ext.decode(b.responseText);this.fireEvent("taskcomplete");this.close()}})},initListeners:function(){},loadData:function(a){this.comment_id=a||this.comment_id;Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"get-comment",params:{comment_id:this.comment_id},success:function(c){var b=Ext.decode(c.responseText);if(b.success){this.update(b.comment)}else{this.update(b.errorStr)}}})}});Ext.define("TMS.task.view.FilteredGrid",{extend:"Ext.panel.Panel",requires:["TMS.task.filter.Task","TMS.task.view.Grid"],layout:"border",height:500,title:"Tasks",collapsible:true,titleCollapse:true,extraFilters:{},initComponent:function(){this.items=this.items||[];this.init();this.callParent(arguments)},init:function(){this.initFilters();this.initGrid();this.initListeners()},initFilters:function(){this.filterPanel=Ext.create("TMS.task.filter.Task",{region:"east",width:250,collapsible:true,collapsed:true,titleCollapse:true,title:"Search",extraFilters:this.extraFilters});this.items.push(this.filterPanel)},initGrid:function(){this.gridPanel=Ext.create("TMS.task.view.Grid",{region:"center",filter:this.filterPanel});this.items.push(this.gridPanel)},initListeners:function(){}});Ext.define("TMS.task.view.Grid",{extend:"TMS.grid.Grid",requires:["TMS.TimeDifference"],processingPage:"/at-ajax/modules/task/grid/",timeDifference:false,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initColumns();this.initStore();this.initPager();this.initListeners()},initColumns:function(){this.columns=[{header:"Description",dataIndex:"task_type_id",flex:4,renderer:function(d,c,b){var e="";if(b.data.user_id==b.data.myId||!b.data.claimable){e='<a class="task-link" href="'+b.data.taskUrl+'">'+b.data.taskDisplay+"</a>"}else{e=b.data.taskDisplay}return e}},{header:"Created By",dataIndex:"created_by",flex:1,renderer:function(d,c,b){if(b.data.user_id==b.data.user_id2){return"TMS"}else{}return b.data.created_by}},{header:"Assigned To",dataIndex:"assigned_to",flex:1,renderer:function(d,c,b){if(b.data.employee_id=="0"&&b.data.role_id&&b.data.canClaim){var e='<div class="rounded5 button box-right"><a href="#" class="claim-task-button" id="claim-task-'+b.data.task_id+'">Claim Task</a></div>';return e}else{if(b.data.employee_id=="0"&&b.data.role_id){return b.data.role_name}}return b.data.assigned_to}},{header:"Due",dataIndex:"due_at",flex:1},{header:"Duration",dataIndex:"created_at",flex:1,xtype:"templatecolumn",tpl:'<span class="time-difference x-hidden">{created_at}</span>'}]},initStore:function(){this.store=new Ext.data.Store({fields:["task_id","role_id","employee_id","taskDisplay","taskUrl","created_by","assigned_to","myId","user_id","user_id2","due","duration","due_at","created_at","canClaim","role_name","task_type_id","claimable"],remoteSort:true,pageSize:25,proxy:{type:"ajax",url:this.processingPage+"get-records",reader:{type:"json",root:"records",totalProperty:"total"}}})},initPager:function(){this.pager=new Ext.toolbar.Paging({store:this.store,displayInfo:true});this.tbar=this.pager},initListeners:function(){this.on("afterrender",function(){this.store.loadPage(this.store.currentPage)},this);this.store.on("load",function(){if(this.timeDifference){this.timeDifference.remove()}this.timeDifference=Ext.create("TMS.TimeDifference");var g=Ext.select("a.claim-task-button",true);var e=g.elements.length;for(var d=0;d<e;d++){g.elements[d].on("click",function(k,i){var j=i.id.split("-");var h=j[j.length-1];this.setLoading(true);Ext.Ajax.request({scope:this,method:"post",url:"/at-ajax/modules/task/process/claim-task",params:{taskId:h},success:function(m){this.setLoading(false);var l=Ext.decode(m.responseText);this.store.load()}})},this)}var a=Ext.select("a.task-link",true);var c=a.elements.length;for(var d=0;d<c;d++){if(a.elements[d].dom.href.match(/#action/)){var f=a.elements[d].dom.href.split("#")[1].split("-");var b=f[1];a.elements[d].on("click",function(j,i,h){Ext.Ajax.request({scope:this,method:"post",url:"/at-ajax/modules/task/process/get-details",params:{taskId:h.taskId},success:function(m){var l=Ext.decode(m.responseText);if(l.cls){var k=Ext.create(l.cls,l.details);k.on("taskcomplete",function(){this.store.load()},this)}}})},this,{taskId:b})}}},this)}});Ext.define("TMS.task.Notifier",{extend:"Ext.util.Observable",singleton:true,config:{},defaultParams:{title:"",content:"",icon:"/resources/img/thumb_icon.png",url:false,timeout:false},enabled:false,constructor:function(a){if(window.webkitNotifications){this.enabled=true;this.requestPermission()}return this},show:function(c){var a={};Ext.apply(a,this.defaultParams);Ext.apply(a,c);if(window.webkitNotifications!=null&&window.webkitNotifications.checkPermission()==0){var b=webkitNotifications.createNotification(a.icon,a.title,a.content);if(a.url){b.onclick=function(){b.cancel();location.href=a.url}}if(a.timeout){setTimeout(Ext.Function.bind(function(){this.cancel()},b),a.timeout)}b.show();return b}else{TMS.Application.showMessage(a)}},requestPermission:function(){if(window.webkitNotifications.checkPermission()!=0){if(!Ext.util.Cookies.get("tmsNotifications")){Ext.EventManager.on(window,"load",function(){this.message=Ext.get(Ext.core.DomHelper.insertFirst(Ext.get("content"),{tag:"div",id:"notify-request",html:"Click here to enable browser notifications for TMS",style:{display:"none"}}));this.message.slideIn();this.message.on("click",function(){Ext.util.Cookies.set("tmsNotifications");window.webkitNotifications.requestPermission();this.message.slideOut("t",{callback:function(){this.message.remove()}})},this)})}}}});Ext.define("TMS.task.TaskManager",{extend:"Ext.util.Observable",processingPage:"/at-ajax/modules/task/process/",config:{checkIntervalWait:60000},constructor:function(a){this.initConfig(a);this.initCheckInterval();return this},initCheckInterval:function(){this.checkInterval=setInterval(Ext.Function.bind(this.checkNewNotifications,this),this.checkIntervalWait)},checkNewNotifications:function(){Ext.Ajax.request({scope:this,method:"post",url:this.processingPage+"check-new",success:function(b){var a=Ext.decode(b.responseText);if(a.newTasks){TMS.task.NotifierInstance.show({title:a.title,content:a.content,url:a.url,icon:a.icon})}}})}});Ext.define("TMS.user.lookup.User",{extend:"Ext.ux.form.field.RealComboBox",processingPage:"/at-ajax/modules/user/lookup/",displayField:"name",valueField:"user_id",emptyText:"Search users by name...",typeAhead:false,hideTrigger:true,anchor:"100%",pageSize:10,minChars:0,listConfig:{loadingText:"Searching...",emptyText:"No users found."},store:false,initComponent:function(){this.init();this.callParent(arguments)},init:function(){this.initStore()},initStore:function(){this.store=new Ext.data.Store({fields:["user_id","name"],remoteSort:true,pageSize:10,proxy:{type:"ajax",url:this.processingPage+"get-user-list",reader:{type:"json",root:"records",totalProperty:"total"}}})}});Ext.define("TMS.user.model.Branches",{extend:"Ext.data.Model",idProperty:"branch_id",fields:[{name:"branch_id",type:"int"},{name:"branch_name",type:"string"}],proxy:{type:"ajax",api:{read:"/at-ajax/modules/user/branches/read",create:"/at-ajax/modules/user/branches/create",update:"/at-ajax/modules/user/branches/update",destroy:"/at-ajax/modules/user/branches/destroy"},reader:{idProperty:"branch_id",type:"json",root:"records",totalProperty:"total"},writer:{type:"json",allowSingle:false,writeAllFields:false,root:"records",encode:true}}});